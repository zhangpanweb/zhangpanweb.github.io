{"data":{"markdownRemark":{"html":"<p>Service Worker，其主要作用是作为一个网页与Web服务器间的代理服务器。它可以缓存资源，并在网页请求对应资源时，劫持网页请求，直接返回已缓存的资源，从而节省网络加载时间，以及在无网络条件下正常加载页面。</p>\n<hr>\n<h4>工作流程</h4>\n<p>整体工作流程如下：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/20ac395243cae239fd859f586dadfb72/15bad/service-worker.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 541px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 74.12199630314232%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABaElEQVQ4y4WU67KCMAyE+/6PqD/AEVG5CCJyFeP5MpMz1XrpTMYS2s3uJuLkb2VZJmVZspX7/S6vi5zlL5eLrNdr2e12T+9tuXme/y/cbrcAwL/wqZi/3Pl8lqqqpK5rrb4sSwDyLQKGbdvK4XCQoiik67qA5evlnwxhNgyD9H2vDL8tiqEAELMqYNg0jSCbABDwaZqegssUPJ1O2rw0TdUi8gHg9XpVDwn2yDbGFjxTmDNMxHa71eK+PYFkgH5JtmIw+wiI1DzPVQ4sYDSOo170f2ke7I7HozJk/66B6iFgNjY+oAXPsMM/pgECnH8LyGEkmPnfFh0GhPC77Mt2ny7CxDqPAn5hZTkahA28I8d+v9+LYwSQwnDjCxLNV/KbzUaBzEfySZKo3+QAB4gAw0VRpEZziARS7O8IAKCME5JsfGCFp+Tw3JijSj8OSCTMQ/yM41gHmMp0lT1F+cqwJ2fvyEFqtVrJA2HnjvKx9/E9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"service worker\"\n        title=\"\"\n        src=\"/static/20ac395243cae239fd859f586dadfb72/15bad/service-worker.png\"\n        srcset=\"/static/20ac395243cae239fd859f586dadfb72/0d23f/service-worker.png 138w,\n/static/20ac395243cae239fd859f586dadfb72/6bae1/service-worker.png 275w,\n/static/20ac395243cae239fd859f586dadfb72/15bad/service-worker.png 541w\"\n        sizes=\"(max-width: 541px) 100vw, 541px\"\n      />\n  </span>\n  </a></p>\n<ul>\n<li>\n<p>加载并执行主线程JavaScript，主线程调用<code class=\"language-text\">serviceWorkerContainer.register()</code>注册service worker</p>\n<ul>\n<li><code class=\"language-text\">serviceWorkerContainer.register()</code>包含两个参数，第一个参数是指定service worker脚本的url地址第二个参数为可选配置项</li>\n<li>调用此方法后，将会调用浏览器API执行service worker的注册操作</li>\n<li>此方法返回一个Promise，可以通过指定<code class=\"language-text\">resolve</code>方法对service worker进行检测，也可以指定<code class=\"language-text\">reject</code>方法捕获错误</li>\n</ul>\n</li>\n<li>注册service worker后，service work在一个被称作<code class=\"language-text\">ServiceWorkerGlobalScope</code>的执行上下文中被执行，这个执行环节是独立于主线程的，无DOM操作权限。</li>\n<li>service worker在注册及工作过程中，浏览器会通过事件的方式告知service worker所处的阶段以及网页发起的请求等。service worker通过注册事件处理器来对这些事件进行反应，做出相应处理</li>\n<li>在主线程进行注册后，service worker首先收到的是<code class=\"language-text\">install</code>事件，这个事件表示service worker的安装，可以在此事件的事件处理器中执行建立<code class=\"language-text\">IndexedDB</code>、初始化缓存内容的事务。<code class=\"language-text\">install</code>事件的事件处理器执行完毕后，即表示此service worker已安装</li>\n<li>之后是<code class=\"language-text\">activate</code>事件，activate事件主要用来清理老版本service worker的过期资源，从而达到释放存储空间等目的。</li>\n<li>\n<p>在这之后，service worker即会正式接管页面</p>\n<ul>\n<li>此时，service woker处于监听状态，比如，如果网页发起请求，浏览器便会通过<code class=\"language-text\">fetch</code>事件，将请求移交给service worker，service worker内部可以通过注册<code class=\"language-text\">fetch</code>事件处理器，来处理网页请求</li>\n<li>需要注意的是，service worker接管的页面，是在完成注册之后打开的页面，所以原注册页面不会被接管，如果需要被接管，页面需要被刷新</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h4>代码</h4>\n<p>结合<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers#Basic_architecture\">MDN上的一个实例</a>来说明一下service worker的工作流程，具体代码可见<a href=\"https://github.com/mdn/sw-test/\">github仓库</a>。</p>\n<ul>\n<li>如下代码，app.js在主线程中执行，调用<code class=\"language-text\">navigator.serviceWorker.register</code>注册service worker，将文件<code class=\"language-text\">sw.js</code>中的脚本加载进service worker的执行环境进行执行</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// app.js</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'serviceWorker'</span> <span class=\"token keyword\">in</span> navigator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  navigator<span class=\"token punctuation\">.</span>serviceWorker<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./sw.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">.</span>installing<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Service worker installing'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">.</span>waiting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Service worker installed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">.</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Service worker active'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// registration failed</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Registration failed with '</span> <span class=\"token operator\">+</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>此脚本在service worker执行环境中注册了install事件处理器，当service worker的install事件被触发时，事件处理器被调用。在此事件处理器中，调用<code class=\"language-text\">event.waitUntil</code>将install延迟至<code class=\"language-text\">watiUntil</code>中的内容处理完毕。在<code class=\"language-text\">waituntil</code>中，初始化了一个名称为<code class=\"language-text\">v1</code>的缓存器，并将页面所需资源添加至缓存器中。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'install'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span>\n    caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'v1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'./'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./index.html'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./style.css'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./app.js'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./image-list.js'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./star-wars-logo.jpg'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./gallery/bountyHunters.jpg'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./gallery/myLittleVader.jpg'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./gallery/snowTroopers.jpg'</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>注册<code class=\"language-text\">fetch</code>事件，当网页发起请求时，浏览器会触发fetch事件，并将网络请求以<code class=\"language-text\">event.request</code>的方式传递给service worker。在此处理过程中，通过<code class=\"language-text\">cache.match</code>来匹配缓存器中对应的资源。如果资源已经存在，<code class=\"language-text\">response</code>不为undfined，则直接将此资源返回，不再发起网络请求。若资源不存在，则通过<code class=\"language-text\">fetch</code>发起网络请求，获得资源后，先通过<code class=\"language-text\">cache.put</code>将资源存储至缓存器中，然后将资源返回给网页。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>caches<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response <span class=\"token operator\">!==</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> responseClone <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'v1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">,</span> responseClone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./gallery/myLittleVader.jpg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h4>更多</h4>\n<ul>\n<li>对于activate事件，其用法和install事件类似，它可以用来清楚老版本的过期资源，具体实例可见<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers#Updating_your_service_worker\">MDN文档</a></li>\n<li>servcie worker除了用来做缓存外，还可以用来进行消息推送等，详情可见：<a href=\"https://serviceworke.rs/push-get-payload.html\">https://serviceworke.rs/push-get-payload.html</a></li>\n</ul>\n<hr>\n<p>参考</p>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers\">https://developer.mozilla.org/en-US/docs/Web/API/Service<em>Worker</em>API/Using<em>Service</em>Workers</a></li>\n<li><a href=\"https://lavas.baidu.com/pwa/offline-and-cache-loading/service-worker/service-worker-introduction\">https://lavas.baidu.com/pwa/offline-and-cache-loading/service-worker/service-worker-introduction</a></li>\n<li><a href=\"https://serviceworke.rs/push-get-payload.html\">https://serviceworke.rs/push-get-payload.html</a></li>\n<li><a href=\"https://developers.google.com/web/fundamentals/primers/service-workers/\">https://developers.google.com/web/fundamentals/primers/service-workers/</a></li>\n</ul>","frontmatter":{"title":"Service Worker简介"}}},"pageContext":{"postName":"/post/Service Worker简介"}}