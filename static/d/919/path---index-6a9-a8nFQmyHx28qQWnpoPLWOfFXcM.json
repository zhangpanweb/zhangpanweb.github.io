{"data":{"allMarkdownRemark":{"edges":[{"node":{"id":"58f83ef5-4246-583f-b1e8-995baf73439f","frontmatter":{"title":"开发环境设置浏览器自动刷新","date":"2019-03-08","description":"开发环境的浏览器自动刷新，有利于提高开发效率。在此记录如何配置开发环境的浏览器自动刷新"},"html":"<p>开发环境中，如果在更新代码后，浏览器能够自动刷新，能够很大程度上提升我们的开发效率。在此记录一下，以<code class=\"language-text\">webpack-dev-server</code>和<code class=\"language-text\">express</code>两者提供服务的情况下，如何设置浏览器自动刷新。</p>\n<hr>\n<h4>webpack-dev-server</h4>\n<p>在<code class=\"language-text\">webpack-dev-server</code>提供服务的情况下，浏览器自动刷新的设置相当简单，只需要在<code class=\"language-text\">webpack.config.js</code>中加入以下代码即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\ndevServer<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    contentBase<span class=\"token punctuation\">:</span> <span class=\"token string\">'./views'</span><span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>相关<code class=\"language-text\">contentBase</code>和<code class=\"language-text\">publicPath</code>参数值可以按照需要进行设置，可参考<a href=\"https://webpack.js.org/guides/development/#using-webpack-dev-middleware\">webpack官网devServer配置项</a></p>\n<hr>\n<h4>以 express 提供服务</h4>\n<p>若以express提供服务，则需要使用<code class=\"language-text\">webpack-dev-middleware</code>和<code class=\"language-text\">webpack-hot-middleware</code>模块进行配置。首先</p>\n<h5>安装模块</h5>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev webpack-dev-middleware webpack-hot-middleware</code></pre></div>\n<h5>webpack配置</h5>\n<p>在 webpack 中添加配置</p>\n<ul>\n<li>entry 配置增加对<code class=\"language-text\">webpack-hot-middleware/client</code>的引用</li>\n<li>output 配置中增加<code class=\"language-text\">publicPath</code>配置</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'webpack-hot-middleware/client?reload=true'</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./entry/index.jsx'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\noutput<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span><span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h5>express 增加中间件</h5>\n<p>增加对<code class=\"language-text\">webpack-dev-middleware</code>和<code class=\"language-text\">webpack-hot-middleware</code>的使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> webpack <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'webpack'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./webpack.config'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> compiler <span class=\"token operator\">=</span> <span class=\"token function\">webpack</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack-dev-middleware\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  noInfo<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> publicPath<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>publicPath\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack-hot-middleware\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>reload 选项</h5>\n<p><code class=\"language-text\">webpack-hot-middleware/client</code>可以配置<a href=\"https://github.com/webpack-contrib/webpack-hot-middleware#config\">很多选项</a>，其中可以关注一下<code class=\"language-text\">reload</code>的参数。由于<code class=\"language-text\">webpack-hot-middleware</code>的主要目的是做热替换的。但是在某些项目中，比如React项目，单纯的<code class=\"language-text\">webpack-dev-middleware</code>和<code class=\"language-text\">webpack-hot-middleware</code>模块无法达到热替换的目的，设置<code class=\"language-text\">reload=true</code>会在当 webpack 检测到文件更新，但是无法完成热替换时，将替换方案退化为，重新刷新浏览器。</p>\n<hr>\n<h4>更多</h4>\n<p>热替换是比刷新浏览器更好的体验，React 的热替换可以参考：</p>\n<ul>\n<li><a href=\"https://github.com/gaearon/react-hot-loader\">react-hot-loade</a></li>\n<li><a href=\"https://mobile.twitter.com/dan_abramov\">Dan Abramov</a> 有关热替换的文章：[my-wishlist-for-hot-reloading](</li>\n</ul>","fields":{"postName":"开发环境设置浏览器自动刷新"}}},{"node":{"id":"ec263497-77a0-5a8f-9de0-d9cbe16556a0","frontmatter":{"title":"配置一个最基本的React项目","date":"2019-03-07","description":"从0开始，配置一个最基本的React项目，内容包括：建立最基本的express服务器、webpack配置、babel配置等"},"html":"<p>配置一个最基本的 React 项目，大概分为一下几个部分：</p>\n<ul>\n<li>后端，使用<code class=\"language-text\">express</code>快速构建一个服务器</li>\n<li>采用 webpack 进行打包</li>\n<li>采用 babel 作为语法转义</li>\n<li>构建好的项目文件目录如下：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/dist\n\t- bundle.js   // 打包后的js文件\n\t- bundle.map.js  // source-map文件\n/entry\n\t- index.jsx  // React项目住入口\n/node_modules\n/pages\n\t- App.jsx\n\t- app.less\n/views\n\t- index.html\n.babelrc\napp.js\npackage-lock.json\npackage.json\nwebpack.config.js</code></pre></div>\n<hr>\n<h4>webpack</h4>\n<p>最终配置如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  mode<span class=\"token punctuation\">:</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n  entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    app<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./entry/index.jsx'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  resolve<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    extensions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'.jsx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.js'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  module<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    rules<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        test<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token regex\">/.js$/</span><span class=\"token punctuation\">,</span> <span class=\"token regex\">/.jsx$/</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        exclude<span class=\"token punctuation\">:</span> <span class=\"token regex\">/node_modules/</span><span class=\"token punctuation\">,</span>\n        use<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'babel-loader'</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.less$/</span><span class=\"token punctuation\">,</span>\n        use<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'style-loader'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'css-loader'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'less-loader'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  watch<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  devtool<span class=\"token punctuation\">:</span> <span class=\"token string\">'source-map'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>各方面解释如下：</p>\n<ul>\n<li>设置入口文件为<code class=\"language-text\">./entry/index.jsx</code></li>\n<li>打包后输出文件位置为<code class=\"language-text\">./dist</code>，文件名称为<code class=\"language-text\">bundle.js</code></li>\n<li>指定<code class=\"language-text\">resolve.extensions</code>为<code class=\"language-text\">[&#39;.jsx&#39;, &#39;.js&#39;]</code>，从而在文件引入的时候可以不带上后缀，如<code class=\"language-text\">import App from &#39;../pages/App&#39;</code>，此时<code class=\"language-text\">../pages/App</code>会按照<code class=\"language-text\">../pages/App.jsx</code>的方式去查找，若找不到，再按照 js 的后缀去查找，再找不到就会报错</li>\n<li>module 中对对应文件进行编译</li>\n</ul>\n<h5>js 和 jsx 文件的编译</h5>\n<p>首先是对于<code class=\"language-text\">.js</code>和<code class=\"language-text\">.jsx</code>的文件，采用<code class=\"language-text\">babel-loader</code>进行 babel 编译。其主要目的是转义<code class=\"language-text\">jsx</code>语法和<code class=\"language-text\">es6</code>及其以上的语法，具体 babel 配置见下面 babel 配置方面</p>\n<h5>less 文件的编译</h5>\n<p>对于 less 文件，依次采用了<code class=\"language-text\">less-loader</code>、<code class=\"language-text\">css-loader</code>和<code class=\"language-text\">style-loader</code>进行处理，这三个 loader 的作用如下：</p>\n<ul>\n<li><code class=\"language-text\">less-loader</code>：将 less 语法编译为 css</li>\n<li><code class=\"language-text\">css-loader</code>：css-loader 的使用，允许你在 less 文件或 css 文件中采用<code class=\"language-text\">@import</code>和<code class=\"language-text\">url()</code>加载其他文件，与采用<code class=\"language-text\">import</code>和<code class=\"language-text\">require</code>类似，css-loader 回去解析它们</li>\n<li><code class=\"language-text\">style-loader</code>：将 css 文件已<code class=\"language-text\">&lt;style&gt;</code>标签的形式插入到html 文件的 DOM 中，从而使样式生效</li>\n</ul>\n<hr>\n<h4>babel</h4>\n<p>babel 的配置，主要有两方面作用：</p>\n<ul>\n<li>转义<code class=\"language-text\">jsx</code>语法</li>\n<li>转义<code class=\"language-text\">es6</code>及以上的语法为 es5，使其能够在低版本浏览器中运行</li>\n</ul>\n<p>最终的配置文件如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/preset-env\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"useBuiltIns\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"usage\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"forceAllTransforms\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/preset-react\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/plugin-transform-runtime\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用到的 preset 及 plugins 解释如下：</p>\n<ul>\n<li>\n<p><code class=\"language-text\">@babel/preset-env</code>：根据目标运行环境来转化es6及以上代码，使其能够在目标环境中运行。目标环境可以通过<code class=\"language-text\">.browserlistrc</code>或<code class=\"language-text\">package.json</code>中的<code class=\"language-text\">target</code>字段指定，若未指定，则采用默认配置</p>\n<ul>\n<li>设置<code class=\"language-text\">&quot;useBuiltIns&quot;: &quot;usage&quot;</code>，若代码中采用了 es6及以上的高级功能，babel 会自动引入对应的<code class=\"language-text\">polyfill</code></li>\n</ul>\n</li>\n<li><code class=\"language-text\">@babel/preset-react</code>，转义 React 的 <code class=\"language-text\">jsx</code>语法的相关内容</li>\n<li><code class=\"language-text\">@babel/plugin-transform-runtime</code>：生成沙箱环境，是的各类 polyfill 不影响全局变量，并减少包的体积</li>\n</ul>\n<hr>\n<h4>主文件</h4>\n<ul>\n<li>入口文件<code class=\"language-text\">./entry/index.jsx</code>：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ReactDOM <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'../pages/App'</span><span class=\"token punctuation\">;</span>\n\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>App</span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">./pages/App.jsx</code>：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'./app.less'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>hello<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello world!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>配置后之后，使用 webpack 打包，即可看到<code class=\"language-text\">./dist</code>文件夹中生成了<code class=\"language-text\">bundle.js</code>文件。</p>\n<hr>\n<h4>后端及 index.html</h4>\n<h5>所需文件</h5>\n<ul>\n<li>后端采用 express 架设简单服务器</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token string\">'3100'</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./views/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server has been listening on </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">./views/index.html</code>:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\">&lt;!DOCTYPE html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>common-react-config<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>root<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/bundle.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">package.json</code>中加入<code class=\"language-text\">start</code>脚本</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack &amp; nodemon app.js\"</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>执行<code class=\"language-text\">npm start</code>即可在<code class=\"language-text\">localhost:3100</code>中看到<code class=\"language-text\">Hello world!</code></p>\n<h5>流程</h5>\n<ul>\n<li>请求<code class=\"language-text\">localhost:30000</code>，请求进入<code class=\"language-text\">app.js</code>中后，后端会读取<code class=\"language-text\">./views/index.html</code>并返回给前端</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./views/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>前端接收到请求后，会进行解析，并根据<code class=\"language-text\">&lt;script&gt;</code>请求<code class=\"language-text\">bundle.js</code>文件</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/bundle.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>对于<code class=\"language-text\">bundle.js</code>的请求，会在服务器端静态服务器处找到<code class=\"language-text\">bundle.js</code>文件，并返回此文件</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>前端收到 <code class=\"language-text\">bundle.js</code>文件后，执行对应 js，并渲染出<code class=\"language-text\">Hello world!</code></li>\n</ul>","fields":{"postName":"React项目基础配置"}}},{"node":{"id":"bb41f2ad-a554-5644-ad89-87a6b9f0dc21","frontmatter":{"title":"babel基础概述","date":"2019-03-05","description":"配置babel前必须了解的babel基础知识，包括plugins、preset以及常用的plugins、preset"},"html":"<ul>\n<li>babel 可以通过<code class=\"language-text\">.babelrc</code>、<code class=\"language-text\">babel.config.js</code>或<code class=\"language-text\">package.json</code>中的<code class=\"language-text\">babel</code>字段进行配置</li>\n<li>以<code class=\"language-text\">.babelrc</code>为例，设置最常用的<code class=\"language-text\">presets</code>和<code class=\"language-text\">plugins</code>两个配置项：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n   <span class=\"token string\">\"presets\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"presetsA\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"presetsAOptions\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"presetsAValue\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">...</span>\n   <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"pluginsA\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"pluginsAOptions\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"pluginsAValue\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>更多配置项可以见<a href=\"https://babeljs.io/docs/en/options\">babel文档</a></li>\n</ul>\n<hr>\n<h4>plugins</h4>\n<ul>\n<li>babel 是一个编译器，它接受代码，经过对应语法转义后输出代码。而babel 的语法转义是通过 plugin实现的，plugin 会指导babel 对相应 JavaScript 程序进行编译，比如<code class=\"language-text\">@babel/plugin-transform-arrow-functions</code>，可以将箭头函数转化为ES5的非箭头函数，如下面代码。babel 的语法转义功能，即将目标环境无法识别的语法，转化为对应可以识别的语法，从而使一些更高级的语法功能能够在目标环境中运行。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fn</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// converted to</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token function-variable function\">fn</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>plugin 分为<code class=\"language-text\">transform plugins</code>和<code class=\"language-text\">syntax plugins</code>，<code class=\"language-text\">transform plugins</code>会包含对应的<code class=\"language-text\">syntx plugins</code>，它会识别并解析高级语法，并转化为目标环境能够识别的语法，比如上面箭头函数的例子。<code class=\"language-text\">syntx plugins</code>只能够使 babel 能够解析对应语法，但并不能转化他们。</li>\n<li>babel 的<code class=\"language-text\">transform plugins</code>列表可见：<a href=\"https://babeljs.io/docs/en/plugins\">https://babeljs.io/docs/en/plugins</a></li>\n<li>\n<p>我们也可以自定义plugin，来转化我们想转化的语法。可以参考：</p>\n<ul>\n<li><a href=\"https://itnext.io/introduction-to-custom-babel-plugins-98a62dad16ee\">babel自定义插件简介</a></li>\n<li><a href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md\">babel插件手册</a></li>\n</ul>\n</li>\n</ul>\n<hr>\n<h4>preset</h4>\n<ul>\n<li>在我们的项目中，因为有很多需要转化的点，比如 ES6的一堆功能，一个一个的添加插件会显得非常困难，这个是时候就有了 preset。preset 是一个插件包，里面有预设好的一堆插件。我们自己也可以自定义 preset，将一些插件以我们想要的方式进行排列，并进行共享。</li>\n<li>常见比较常用的preset 有：@babel/preset-env</li>\n</ul>\n<hr>\n<h4>plugins和 preset 执行顺序</h4>\n<p>babel 会按照配置文件中指定的 plugins 和 preset 来转化代码，plugins 和 preset 的执行顺序如下：</p>\n<ul>\n<li>先执行 plugins，然后执行 preset</li>\n<li>plugins 列表，按照从前往后的顺序执行</li>\n<li>preset 列表，按照从后往前的顺序执行</li>\n</ul>\n<hr>\n<h4>polyfill</h4>\n<ul>\n<li>\n<p><a href=\"https://babeljs.io/docs/en/babel-polyfill\">@babel/polyfill</a>模块中包含了<code class=\"language-text\">core-js</code>和一个自定义的<code class=\"language-text\">regenerator runtime</code>来模拟 ES2015以上的 JavaScript 允许环境。它可以帮助你 polyfill 一些 ES2015及以上的功能，比如内建的<code class=\"language-text\">Promise</code>、<code class=\"language-text\">WeakMap</code>，静态方法<code class=\"language-text\">Array.from</code>、实例方法<code class=\"language-text\">Array.prototype.includes</code>，以及生成器函数。</p>\n</li>\n<li>\n<p>注意，因为 polyfill 是需要在生成环境被使用的，所以需要按照<code class=\"language-text\">npm install --save @babel/polyfill</code>的方式进行安装</p>\n</li>\n<li>\n<p>使用方式：</p>\n<ul>\n<li>单独手动引入。手动引入又分为 <strong>在项目入口文件处整体引入</strong> 和在 <strong>使用时引入引入特定模块</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 整体引入</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@babel/polyfill\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token comment\">// 通过 webpack 的方式整体引入</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\nentry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"@babel/polyfill\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./app/js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 引入特定模块</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"core-js/modules/es.promise.finally\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </code></pre></div>\n<ul>\n<li>通过 <code class=\"language-text\">@babel/preset-env</code>引入，见下面对<code class=\"language-text\">@babel/preset-env</code>的介绍。</li>\n<li>通过<code class=\"language-text\">@babel/plugin-transform-runtime</code>引入，这种引入方式能够做到不影响全局变量，但是以这种方式引入后，无法引用实例方法，比如<code class=\"language-text\">Array.prototype.includes</code></li>\n</ul>\n</li>\n</ul>\n<hr>\n<h4>@babel/preset-env</h4>\n<ul>\n<li>在这个 preset 中包含了所有支持现代 JavaScript（包括ES2015、ES2016等）的插件。</li>\n<li>设置<code class=\"language-text\">useBuiltIns：&quot;usage&quot;</code>后，babel 会探测你代码中使用到的，但是目标环境中缺失的功能，并引入对应的这个 polyfill，而不是整个 polyfill 文件。从而减少包的体积。</li>\n</ul>\n<h5>原理</h5>\n<ul>\n<li><code class=\"language-text\">@babel/preset-env</code>会将代码的指定目标运行环境，通过一些数据源对应为在目标环境中运行相应代码所需要的语法及功能，然后将这些语法和功能对应为对应所需的插件和 polyfill，从而通过这些插件和 polyfill，将代码转化为可以在目标环境中允许的代码</li>\n<li>可以通过<code class=\"language-text\">.browserlistrc</code>指定代码的目标运行环境，<code class=\"language-text\">.browserlistrc</code>的配置方式可以参考<a href=\"https://github.com/browserslist/browserslist#queries\">browserlist项目</a>，如果没有找到<code class=\"language-text\">.browserlistrc</code>文件，则会使用<a href=\"https://github.com/browserslist/browserslist#queries\">默认配置</a></li>\n</ul>\n<h5>@babel/preset-env和@babel/polyfill</h5>\n<p>通过<code class=\"language-text\">@babel/preset-env</code>可以引入<code class=\"language-text\">@babel/polyfill</code>：</p>\n<ul>\n<li>指定<code class=\"language-text\">useBuiltIns: &#39;usage&#39;</code>后，不需要再显性<code class=\"language-text\">require</code>或<code class=\"language-text\">import</code> <code class=\"language-text\">@babel/polyfill</code>。但是注意<code class=\"language-text\">@babel/polyfill</code>还是需要被安装。设置后，babel 会在需要时，独引用<code class=\"language-text\">@babel/polyfill</code>的特定 polyfill，而不是整个polyfill</li>\n<li>多次引入<code class=\"language-text\">@babel/polyfill</code>会造成一些不可预知的问题。如果指定<code class=\"language-text\">useBuiltIns: &#39;entry&#39;</code>，任需在使用到的地方手动通过通过<code class=\"language-text\">require</code>或<code class=\"language-text\">import</code> <code class=\"language-text\">@babel/polyfill</code>，但是它会将所有的 <code class=\"language-text\">import &quot;@babel/polyfill&quot;</code>或 <code class=\"language-text\">require(&quot;@babel/polyfill&quot;)</code> 根据环境，转化为一个单独的引入。</li>\n<li>如果<code class=\"language-text\">useBuiltIns</code>未被指定或被显性指定为 false，则需要在手动显性引入<code class=\"language-text\">@babel/polyfill</code></li>\n</ul>\n<h5>forceAllTransforms参数</h5>\n<ul>\n<li>默认为 false，此时会按照目标运行环境执行对应转化</li>\n<li>如果设置为true，此时会强制执行所有可能的转化，如果目标代码需要执行UglifyJS 或执行在一个只支持ES5的环境中，则这个参数会很有用</li>\n</ul>\n<hr>\n<h4>@babel/plugin-transform-runtime</h4>\n<h5>作用</h5>\n<ul>\n<li>babel 会使用一些工具函数，比如<code class=\"language-text\">_extend</code>，这些工具函数基本上会在每个文件中被使用到，导致在每个文件中，都需要去定义这些工具函数。而<code class=\"language-text\">@babel/plugin-transform-runtime</code>会使所有的工具函数都去引用<code class=\"language-text\">@babel/runtime</code>，这样就避免了不断去重复定义这些工具函数。</li>\n<li>另一个作用是，为代码创建一个沙箱环境。如果使用<code class=\"language-text\">@babel/polyfill</code>，它会提供一些类似<code class=\"language-text\">Promise</code>、<code class=\"language-text\">Set</code>的功能，这些功能的实现会污染全局环境，当你需要发布某个库时，这就会成为一个问题。这个插件可以解决这个问题，具体可见：<a href=\"https://babeljs.io/docs/en/babel-plugin-transform-runtime#technical-details%E3%80%82\">https://babeljs.io/docs/en/babel-plugin-transform-runtime#technical-details。</a></li>\n</ul>\n<h5>使用</h5>\n<ul>\n<li>开发环境</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev @babel/plugin-transform-runtime</code></pre></div>\n<ul>\n<li>生成环境需要安装<code class=\"language-text\">@babel/runtime</code>作为</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save @babel/runtime</code></pre></div>\n<h5>引入 polyfill</h5>\n<ul>\n<li>对于 babel 7.0及以上，移除了原有的<code class=\"language-text\">polyfill</code>参数，此时，通过<code class=\"language-text\">@babel/plugin-transform-runtime</code>引入 polyfill 的方式是，在配置文件中指定<code class=\"language-text\">corejs</code>为2，并采用<code class=\"language-text\">@babel/runtime-corejs2</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/plugin-transform-runtime\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"corejs\"</span><span class=\"token operator\">:</span><span class=\"token number\">2</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save @babel/runtime-corejs2</code></pre></div>\n<ul>\n<li>需要注意的是，这种方式引入的 polyfill，无法使用实例方法，如<code class=\"language-text\">&quot;foobar&quot;.includes(&quot;foo&quot;)</code></li>\n</ul>\n<h5>使用async和 await</h5>\n<ul>\n<li><code class=\"language-text\">@babel/plugin-transform-runtime</code>中，参数<code class=\"language-text\">regenerator</code>可以指定是否转化生成器函数，指定为 true（默认也是 true）时，可以转化<code class=\"language-text\">async</code>和<code class=\"language-text\">await</code></li>\n</ul>\n<hr>\n<h4>@babel/preset-stage-x</h4>\n<ul>\n<li>babel7 已经去除了所有的<code class=\"language-text\">@babel/preset-stage-x</code>，相关信息可以在<a href=\"https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets\">去除Babel 的Stage Presets</a>这篇文章中获取到</li>\n<li>简单来说，<code class=\"language-text\">@babel/preset-stage-x</code> 使很多用户能干哟用上一些 proposal 的功能的同时，让大家误以为这些 proposal 的功能就是标准，最后造成了一些迁移以及处理上的麻烦，所以在babel7中将 stage 的 preset 去除了</li>\n</ul>","fields":{"postName":"babel基础概述"}}},{"node":{"id":"9d7073d5-384f-52f1-b795-968c4c4117e8","frontmatter":{"title":"Hooks与定时器","date":"2019-02-24","description":"React Hooks用于定时器时引发的问题及解决方式"},"html":"<p>简单的示例：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span></code></pre></div>\n<p>问题：允许后会出现跳字符的问题。</p>\n<p>原因：随着 Counter 的渲染，设置了多个定时器，多个定时器导致count 被设置为不同的值，页面不停被渲染。</p>\n<hr>\n<h4>1. 多个定时器的问题</h4>\n<h5>1.1 利用 useRef 取消多个定时器</h5>\n<p>利用 useRef 设置一个引用，判断之前是否有设置定时器，如果有则不再设置，代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count:'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span></code></pre></div>\n<p>问题：会发现，页面上的数字变为1后，不会再更新。但是在控制台，一直在输出<code class=\"language-text\">count: 0</code></p>\n<p>原因：在 setInterval 中获得的 count 参数的值一直是0，随着页面的渲染，每次传入定时器函数中的值都是初始值。</p>\n<h5>1.2 利用 useEffect 取消之前的定时器</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count:'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 useEffect 中返回<code class=\"language-text\">() =&gt; clearInterval(id);</code>，则每次渲染，都会利用这个函数来取消之前的定时器，然后设置新的定时器。所以去除了设置多个定时器的问题。</p>\n<p>需要注意的点：在上面的例子中，<code class=\"language-text\">useEffect</code>没有传入第二个参数，此时例子能够按照预期工作。但是如果给第二个参数传入<code class=\"language-text\">[]</code>，会发现它加到1后不会往上加了，但是控制台还在不断输出<code class=\"language-text\">count：0</code>。原因：当不传第二个参数时，每次都会取消上一个定时器然后添加新的定时器，然后新添加的定时器会引用最新的 count 值，所以能够正确工作。但是增加<code class=\"language-text\">[]</code>后，表示定时器只会在挂载时添加，在组件卸载时删除，但是在组件更新时定时器不会变化，此时定时器中的执行函数每次获取的都是最初值0。</p>\n<hr>\n<h4>2 解决值不更新的问题</h4>\n<h5>2.1 利用 useRef 获取最新值</h5>\n<p>可以利用 useRef 来设置一个引用，保持最新值的引用，如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> currentCount <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  currentCount<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> count<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'currentCount'</span><span class=\"token punctuation\">,</span> currentCount<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>currentCount<span class=\"token punctuation\">.</span>current <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>页面按照预期每秒钟变动一次。正如Dan Abramov 在[这个 twitter][https://twitter.com/dan_abramov/status/1098027329836797952)]中解释的:</p>\n<blockquote>\n<p>How do you opt into class-like behavior? With a thing similar to “this”. A ref.\nconst something = useRef()\nIn classes, it’s <code class=\"language-text\">this.something</code>. With Hooks, it’s <code class=\"language-text\">something.current</code>. But in both cases it’s a way to “break out” of captured values and get the latest one.</p>\n</blockquote>\n<p>一个 ref 会表现的像类组件中的<code class=\"language-text\">this.something</code>一样，它总是会获取最新的值。</p>\n<h5>2.2 利用 useRef 创造新函数</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> savedCallback <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    savedCallback<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      savedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用<code class=\"language-text\">useRef</code>生成一个每次渲染都不变的<code class=\"language-text\">savedCallback</code>，每次渲染都会生成新的<code class=\"language-text\">callback</code>函数，此函数中 count 会引用最新的值，<code class=\"language-text\">useEffect</code>每次渲染都更新<code class=\"language-text\">savedCall.current</code>中存储callback，更新为最新的 callback，然后声明 tick 函数，将每次的调用都指向这个最新的<code class=\"language-text\">savedCall.current</code>。这样，每次就都能够获得最新的 count 值并进行更新。</p>\n<p>需要注意的一点：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    savedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>不能直接写成<code class=\"language-text\">setInterval(savedcallback.current,1000)</code>，原因：useEffect 中的内容会在组件挂载后执行，而 setInterval 则在组件 render 时，造成的结果就是 setInterval 时 savedCall.current的值是 undefined。这就导致 count 的值根本不会进行更新。</p>\n<p>相同的道理，如下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> savedCallback <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count:'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    savedCallback<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span>savedCallback<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>此代码只会更新一次，但是会每秒打印一个<code class=\"language-text\">count: 0</code>。因为执行 setInterval 时，savedCall.current，其值是<code class=\"language-text\">()=&gt;{setCount(count+1)}</code>，它是一个具体函数，而不在是一个引用，所以此定时器在设定时，引用的是第一次渲染是的 callback，后续每秒执行的也是这个第一次渲染的 callback，继而callback 中每次获得的 count 值都是0。</p>\n<h5>2.3 给 setCount传入一个 updater</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>prevCount <span class=\"token operator\">=></span> prevCount <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span></code></pre></div>\n<p>在<code class=\"language-text\">prevCount=&gt;prevCount+1</code>中<code class=\"language-text\">prevCount</code>会引用最新的值，此时给它+1则没问题。页面会按照预期每秒加1。</p>\n<h5>2.4 使用useReducer</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>action <span class=\"token operator\">===</span> <span class=\"token string\">'inc'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> state <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'inc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 参考Dan Abramov 的博客：https://overreacted.io/making-setinterval-declarative-with-react-hooks/</span></code></pre></div>","fields":{"postName":"Hooks与定时器"}}},{"node":{"id":"6582eeda-d688-52f0-b8f8-574e20c68468","frontmatter":{"title":"Nextjs简介","date":"2019-02-17","description":"以一个项目为基础，简要介绍 Next 框架中的一些概念和简单使用方式"},"html":"<p>本文基于的项目来自Next的官方教程，地址为：<a href=\"https://github.com/arunoda/learnnextjs-demo.git\">https://github.com/arunoda/learnnextjs-demo.git</a> ，采用<code class=\"language-text\">clean-url-ssr</code>分支。</p>\n<hr>\n<h4>几个主要的概念</h4>\n<h5>渲染方式</h5>\n<p>Next 结合了服务端渲染和客户端渲染。首屏加载时采用服务端渲染，之后若用户点击链接进入到新的页面，对新的页面则使用客户端渲染。</p>\n<h5>服务端渲染</h5>\n<p>Next 中，首次请求采用的服务端渲染。服务端渲染指的是，在服务端生成 html 字符串，然后传递给客户端，客户端解析并展示从服务端获取的内容，并进行<a href=\"https://reactjs.org/docs/react-dom.html#hydrate\">hydrate</a>，增加事件处理等。服务端渲染，又可以分为两种方式：</p>\n<ul>\n<li>一种是采用 Next 自身的路由框架，直接在<code class=\"language-text\">page</code>文件夹中增加页面，请求的页面路径直接渲染出<code class=\"language-text\">page</code>文件夹下的页面。例如，在<code class=\"language-text\">/pages/index.js</code>中定义以下组件并导出，则可以直接在<code class=\"language-text\">localhost:3000</code>中看到通过服务端渲染展示出的页面，页面中只有一个<code class=\"language-text\">Hello world!</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello world!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>另一种是自定义路由。通过 express 自定义路由，自定义路由会通过express框架的<code class=\"language-text\">res.render</code>进行服务端渲染，然后将结果返回给客户端，客户端直接呈现服务端渲染结果。比如<a href=\"https://github.com/arunoda/learnnextjs-demo/blob/4482c6e0f16acea394a7f632ce2cd1e29a492779/server.js#L15\">模板项目中的一个例子</a></li>\n</ul>\n<h5>客户端渲染</h5>\n<p>在首页加载完成后，用户点击某个链接，导向新的页面，此时则加载对应页面的 JS 文件，将JS 下载客户端后，在客户端进行渲染，展示页面内容。此时不再通过服务端生成页面，而是客户端加载 JS 并生成页面。</p>\n<blockquote>\n<p>Next 中的客户端加载是通过<code class=\"language-text\">Link</code>组件来完成的，通过在页面中使用<code class=\"language-text\">Link</code>组件，则可以是页面拦截直接的服务端请求，转而采用加载 JS，并进行客户端渲染。若直接使用<code class=\"language-text\">a</code>标签，则相当于直接转向新的页面，则此时还是会重新请求服务端，进行服务端渲染。</p>\n</blockquote>\n<h5>页面兼容两种渲染方式</h5>\n<p>如上所述，由于 Next 将首页采用服务端渲染，而用户可能在每个页面进行刷新，此时这个页面则成为加载的首页，此时页面必须能够被进行服务端渲染，从而完成首页加载；而另一方面，每个页面都可能由另外一个页面从客户端点击后链接导入而来，此时页面则必须能够进行客户端渲染。综上，每个页面都必须兼容服务端渲染和客户端渲染方式。而 Next 中的页面天然具有这种能力。</p>\n<hr>\n<h4>数据获取</h4>\n<p>Next 定义了<code class=\"language-text\">getInitialProps</code>方法进行数据获取，它是一个静态方法，例子如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">//  /pages/post.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Post</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Layout</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/&lt;[/]?p>/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">.</span>image<span class=\"token punctuation\">.</span>medium<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Layout</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span>\n\nPost<span class=\"token punctuation\">.</span>getInitialProps <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`https://api.tvmaze.com/shows/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> show <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> show <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Post<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>服务端渲染。若请求 post，并进行服务端渲染，则服务端会先查看Post 是否有定义<code class=\"language-text\">getInitialProps</code>方法，若有定义此方法，则使用定义的方法请求数据，并将数据放置在一个服务端渲染出的 html 页面中的一个script 标签中（如下所示）。客户端加载 html 后会将此数据渲染进视图。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>__NEXT_DATA__<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>application/json<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\">\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"props\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"pageProps\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"show\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"page\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"/post\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"query\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"900\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"buildId\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"development\"</span><span class=\"token punctuation\">}</span>\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>客户端渲染。在进行客户端渲染时，渲染页面，会先通过<code class=\"language-text\">getInitialProps</code>请求数据，并将请求到的数据通过 props 传递给组件，组件进行对应渲染。</li>\n</ul>\n<hr>\n<h4>数据传递</h4>\n<p>在页面跳转时，若需要传递数据，比如在列表页，点击某个链接，跳转至其详情页，则在详情页需要知道，需要展示哪个内容的详情，此时则需要传递给详情对应数据。在列表页，跳转如下</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Link</span> <span class=\"token attr-name\">as</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`/p/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>show<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">href</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`/post?id=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>show<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>show<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Link</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>则在详情页，获取此 id 的方式为：</p>\n<ul>\n<li>对于组件，通过 <code class=\"language-text\">withRouter</code>，在<code class=\"language-text\">router.query</code>中获取，如下</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> Content <span class=\"token operator\">=</span> <span class=\"token function\">withRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>router<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">This is the blog post content.</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Content props:</span><span class=\"token punctuation\">{</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>对于<code class=\"language-text\">getInitialProps</code>方法，通过<code class=\"language-text\">context</code>方式获取，如下</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Post<span class=\"token punctuation\">.</span>getInitialProps <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>id<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`https://api.tvmaze.com/shows/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> show <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Fetched show:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>show<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>show<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当然，这两种方式获取的数据是相同的。</p>\n<p>若采用自定义路由（如下代码），在对应页面，也可以通过上面的方式通过<code class=\"language-text\">router.query</code>和<code class=\"language-text\">context.query</code>获取<code class=\"language-text\">queryParams</code>中的数据。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">server<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/p/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> actualPage <span class=\"token operator\">=</span> <span class=\"token string\">'/post'</span>\n    <span class=\"token keyword\">const</span> queryParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> req<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> actualPage<span class=\"token punctuation\">,</span> queryParams<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>","fields":{"postName":"Nextjs简介"}}},{"node":{"id":"eff01ce4-1d55-5bd7-986f-fa18c0ca2388","frontmatter":{"title":"Fiber内部：深入了解React中新的reconciliation算法","date":"2019-01-06","description":"此文为译文，原文见：https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e"},"html":"<p>从 React 元素到 Fiber 节点的一切，如何以及为什么。</p>\n<p>React 是一个建立用户界面的 JavaScript 库。其核心是，跟踪组件内状态变化及更新状态至屏幕的机制。在 React 中，我们知道这个过程是<strong>reconciliation</strong>。如果 state 或 props 变化了，UI 上需要重新渲染组件，则调用<code class=\"language-text\">setState</code>方法，进行框架检查。</p>\n<p>React 文档提供了一个对这种机制的高层概览，包括：React 元素的角色、生命周期方法、<code class=\"language-text\">render</code>方法以及用于组件子元素的 diff 算法。从<code class=\"language-text\">render</code>方法返回的不可变的 React 元素树也就是为我们所知的“虚拟 DOM”。这个术语在之前有利于解释 React，但是它也造成了一定的迷惑，也没有继续在 React 文档中继续使用。在这篇文章中，我会依旧把它称作 React 元素树。</p>\n<p>在 React 元素树中，框架始终保有一个内部实例（组件、DOM 节点等）的组成的树来维持 state。从 React16 版本开始，React 发布了对这种内部实例树的新实现和管理它的新算法——Fiber。想要了解 Fiber 架构带来的好处，可以参考 <a href=\"https://medium.com/dailyjs/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7\">如何以及为什么 React 在 Fiber 中使用 linked list</a>。</p>\n<p>这是这个系列的第一篇，这个系列的目标是让你认识 React 的内部架构。在这篇文章中，我会提供对重要概念和算法数据结构的深度概览。在你拥有这些背景知识之后，我们将去探索那些用于处理 fiber 树的算法和重要函数。这个系列的下一篇文章将会展示 React 如何利用算法来进行第一次渲染、处理状态以及更新属性。这这里开始，我们将进入一些调度细节、子 reconciliation 进程以及建立影响列表的机制。</p>\n<p>在这里，我会给你一些相对高阶的知识。阅读它并理解 React 背后的内部运行魔法。如果你想要参与 React，这个系列的文章也会成为一个指引。我深信 reverse-engineering，所以在这里会有很多链接，链接到 React16.6.0 版本的资源。</p>\n<p>肯定是有很多需要掌握的，如果你感觉没办法立马理解某些内容，也不要感到有压力。获得有价值的东西确实需要一些时间。注意，你不需要理解以下任何内容，如果你只是使用 React，这篇文章是有关 React 内部运作的文章。</p>\n<hr>\n<h4>建立背景知识</h4>\n<p>这里有一些我会在这个系列里面使用的简单应用。我们有一个按钮，这个按钮很简单，它会增加渲染到屏幕上的一个数字。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4cb17450b9c01101e2d65de05be09c8e/13cfa/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 550px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 21.386430678466077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABJ0AAASdAHeZh94AAAAVElEQVQY05WO0QqAIBRD/f/vK3yJ9BPiXi0w2/KhoAe74GAw2DjM8UcAaKvfux7ohQEXc1aKbExJmpX1LJ8eo8DKGBZ6PzXPXGPgseuzGQDaGebDG03zPCtuy+5RAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"1\"\n        title=\"\"\n        src=\"/static/4cb17450b9c01101e2d65de05be09c8e/542ea/1.png\"\n        srcset=\"/static/4cb17450b9c01101e2d65de05be09c8e/e35fc/1.png 138w,\n/static/4cb17450b9c01101e2d65de05be09c8e/4417e/1.png 275w,\n/static/4cb17450b9c01101e2d65de05be09c8e/542ea/1.png 550w,\n/static/4cb17450b9c01101e2d65de05be09c8e/13cfa/1.png 678w\"\n        sizes=\"(max-width: 550px) 100vw, 550px\"\n      />\n  </span>\n  </a></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Update counter\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>你可以在<a href=\"https://stackblitz.com/edit/react-t4rdmh\">这里</a>看到它。正如你所看到，这是一个简单的组件，从 render 方法返回两个组件，一个 button 一个 span。一旦你点击按钮，组件的状态会在 handler 里面更新，这反过来会导致 span 中的文字更新。</p>\n<p>在 reconciliation 期间，React 会执行各种活动。比如，在第一次渲染和状态更新之后，React 会执行以下一些高阶操作：</p>\n<ul>\n<li>更新<code class=\"language-text\">ClickCount</code> <code class=\"language-text\">state</code>中的<code class=\"language-text\">count</code>属性</li>\n<li>检索并比较<code class=\"language-text\">ClickCount</code>的子元素以及他们的属性</li>\n<li>更新<code class=\"language-text\">span</code>元素的属性</li>\n</ul>\n<p>在 reconciliation 期间，React 还会执行一些其他操作，比如调用生命周期方法和更新 refs。所以这些活动都集中在 Fiber 架构中进行。活动的类型经常取决于 React 元素的类型。比如说，对于一个类组件，React 需要创建一个实例，而对函数组件则不需要做实例化。正如你所知道，React 中有很多类型的元素，比如，类和函数组件、host 组件（DOM 节点）、portals 等。React 元素的类型通过 createElement 的第一个参数来定义。createElement 函数常用在 render 方法中来创建一个元素。</p>\n<p>在我们开始对这些活动以及主要的 fiber 算法之前，让我们先了解一下 React 内部使用的数据结构。</p>\n<hr>\n<h4>从 React 元素到 Fiber 节点</h4>\n<p>React 的每个组件都有一个 UI 展示，我们称之为一个视图或者一个模板，它从 render 方法返回。<code class=\"language-text\">ClickCounter</code>组件的模板如下</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Update counter</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">key</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h5>React 元素</h5>\n<p>一旦一个模板通过 JSX 编译器，你会得到一堆 React 元素。这些是真正从 React 组件 render 方法返回的内容，不是 HTML。如果你不使用 JSX，<code class=\"language-text\">ClickCounter</code>组件的 render 方法可以被改写成下面的样子：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n            React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">'button'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">{</span>\n                    key<span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n                    onClick<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClick\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'Update counter'</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">{</span>\n                    key<span class=\"token punctuation\">:</span> <span class=\"token string\">'2'</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 render 方法中对<code class=\"language-text\">React.createElement</code>的调用会建立两个类似下面的数据结构：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n        $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>react<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        type<span class=\"token punctuation\">:</span> <span class=\"token string\">'button'</span><span class=\"token punctuation\">,</span>\n        key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            children<span class=\"token punctuation\">:</span> <span class=\"token string\">'Update counter'</span><span class=\"token punctuation\">,</span>\n            onClick<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n        $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>react<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        type<span class=\"token punctuation\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n        key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n        props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>你可以看到 React 增加了<code class=\"language-text\">$$typeof</code>属性来标识他们是 React 元素。现在，我们拥有了 type、key、props 属性来描述这个元素。这些值来自我们传入<code class=\"language-text\">React.createElement</code>的内容。注意 React 如何把文字内容作为 span 和 button 节点的 children 属性进行表示。并且点击处理器被作为了 button 属性的部分。这里还有一些其他 React 元素的属性，比如<code class=\"language-text\">ref</code>，它超出了这篇文章的讨论范围。</p>\n<p><code class=\"language-text\">ClickCounter</code>这个 React 元素没有 props 和 key：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>react<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    ref<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> ClickCounter\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h5>Fiber 节点</h5>\n<p>在 reconciliation 期间，每个 React 元素 render 方法返回的数据都会被 merge 到一颗 fiber 节点数上。每个 React 元素都会有一个对应的 fiber 节点。和 React 元素不同的是，fiber 并不会在每次渲染时重新创建。这里有可变的数据结构来承载组建的 state 和 DOM。</p>\n<p>我们之前讨论过，React 元素的类型会决定框架进行的不同活动。在我们的简单应用中，对类组件<code class=\"language-text\">ClickCounter</code>，它调用了生命周期方法和 render 方法，对 span host 组件（DOM 节点），它进行了 DOM 转化。每个 React 元素都转化为对应类型的 Fiber 节点，这些类型描述了需要进行的活动。</p>\n<p>你可以把一个 fiber 想象成一个数据结构，它代表了需要做的工作，或者换句话说，一个活动的单元。Fiber 架构提供了便捷的方法来跟踪、调度、暂停或停止这些活动。</p>\n<p>当一个 React 元素第一次被转化为一个 fiber 节点时，React 会使用来自这个元素的数据来创建一个 fiber，这个动作在 createFiberFromTypeAndProps 函数中。在后续的更新中，React 会复用这个 fiber 节点，利用来自对应 React 元素的数据来更新必须的属性。React 也需要基于 key 属性在层级关系中移动节点，或者当对应 React 元素不再从 render 方法返回时删除它。</p>\n<blockquote>\n<p>可以参考 ChildReconciler 方法，查看所有活动的列表以及 React 对已存 fiber 节点执行的对应方法。</p>\n</blockquote>\n<p>因为 React 为每个 React 元素创建了一个 fiber，所以我们有了这些元素组成的树。在我们的简单应用中，它看起来是这样的：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f72d1e65326e6a8fea140b091033dbf/d3f53/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 550px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.62068965517241%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABJ0AAASdAHeZh94AAABXUlEQVQoz4VRTUvDQBDtT/QknsWLB6EHTz3qRREFP0DwLqVnC0pPoharEeyXgmmhVmPApE2a5qvZZPOchKakrdWByWzmvXk7M5vhYYhZ4+RRNiQsHOPxN/pPsBR/wqGYiQ63NRV7eRH7BRHPrwohDPDZdMFYDIzyfZ3wAPpggAE5UpfHghdlGRsHAjZPG7h7+ARUBWb7HY7tgfEw7jggNU4Hxj3oTEUAH6ragyRJ04JJu549hGuokImwfljF6s4TVrYEHJ03gaFKSk7M8wMG09bBwwCapi0WjJOBD9t2cHkvo1ASkS+1cP3YxY3wheKViHJdQcgDjGwrjo7rwrKs+ZHTy5/YiPbkaTD6CrInNSxvV5A7a+A3S9dm0i+UOK0NhtaLY4TW2zqK9Tc0O9ocd7Y+s+g2l8YytW9IH12s7QpYylWQPa5i4URJh3+NwGmnzGNoSUO8dAx0ZPNfwR+Yma49ZzX6vAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"2\"\n        title=\"\"\n        src=\"/static/2f72d1e65326e6a8fea140b091033dbf/542ea/2.png\"\n        srcset=\"/static/2f72d1e65326e6a8fea140b091033dbf/e35fc/2.png 138w,\n/static/2f72d1e65326e6a8fea140b091033dbf/4417e/2.png 275w,\n/static/2f72d1e65326e6a8fea140b091033dbf/542ea/2.png 550w,\n/static/2f72d1e65326e6a8fea140b091033dbf/d3f53/2.png 725w\"\n        sizes=\"(max-width: 550px) 100vw, 550px\"\n      />\n  </span>\n  </a></p>\n<p>所有的 fiber 节点通过一个链接列表互相连接，这个链接列表会使用到 fiber 节点上的以下属性：<code class=\"language-text\">child</code>、<code class=\"language-text\">sibling</code>和<code class=\"language-text\">return</code>。为了了解更多为何采取这种方式的细节，可以参考我的文章，<a href=\"https://medium.com/dailyjs/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7\">如何以及为什么 React 在 Fiber 中使用链接列表</a>。</p>\n<h5>进度树中的 current 和 work</h5>\n<p>在第一次渲染之后，React 会拥有一个 fiber 树，这个 fiber 树反映了用于渲染 UI 的应用状态。这棵树经常被称作 current。当 React 开始更新时，React 内部会进阿里一个所谓的 workInProgress 树，这棵树反映的是未来即将被更新到屏幕上的状态。</p>\n<p>所有对 fiber 的操作都来自于 workInProgress 树。当 React 遍历 current 树时，对于每个已有 fiber 节点，都会创建一个可选的节点来构成 workInProgress 树。这个节点来自 React 元素的 render 方法返回的数据。一旦更新被处理，素有相关工作都完成了，React 会有一个可选的待渲染的树。一旦这颗 workInProgress 树被渲染到屏幕上，他就成了 current 树。</p>\n<p>React 的核心原则之一就是一致性。React 总是一次性更新 DOM，它不会只展示部分结果。workInProgress 树所起的作用，是一个“草稿”，它对用户是不可见的，所以 React 可以先处理所有组件，然后把他们的变更渲染到屏幕上。</p>\n<p>在源代码中，你会看到很多方法，他们会从 current 和 workInProgress 树上面获得 fiber 节点。这些方法，其中之一的签名如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>每个 fiber 节点都会存一个引用，指向其他树中对应可能存在的这个节点。在 current 树中的一个节点指向 workInProgress 树的节点，反之亦然。</p>\n<h5>副作用</h5>\n<p>我们把 React 中的每个组件都看作一个函数，它使用 state 和 props 来计算需要展示的 UI。每个类似于更改 DOM 或者调用生命周期方法的活动，都应该被看做是一个副作用，或者，简单地说，是一个影响。影响在<a href=\"https://reactjs.org/docs/hooks-overview.html#%EF%B8%8F-effect-hook\">文档</a>中也有提及：</p>\n<blockquote>\n<p>你之前可能已经在 React 组件中执行过数据获取、订阅或手动更改 DOM 等活动。我们把这些操作称之为“副作用”（或者简称为“影响”），因为他们能够影响其他组件，而且不能在渲染期间执行。</p>\n</blockquote>\n<p>如你所见，state 和 props 更新会导致副作用。执行影响是一种操作，fiber 节点是一种非常方便的机制去跟踪除了更新之外的影响。每个 fiber 节点都有与之相关的影响，我们把他们写在<code class=\"language-text\">effectTag</code>属性中。</p>\n<p>所以，在 Fiber 中，影响定义了对于每个实例来说，在更新被处理之后需要执行的工作。对于宿主组件来说（DOM 元素），这些工作包括增加、更新和移除元素。对于类组件来说，React 需要去更新 refs、调用<code class=\"language-text\">componentDidMount</code>和<code class=\"language-text\">componentDidUpdate</code>生命周期方法。这里也有一些其他影响，与 fiber 的其他类型相对应。</p>\n<h5>影响列表</h5>\n<p>React 处理更新非常快，为了达到一定成都的效率，它采用了一些非常有趣的机制。其中之一就是，为了快速遍历，它建立了一个包含影响在其中的 fiber 列表。遍历线性列表比遍历树要快很多。这里没有必要在没有副作用的节点上浪费时间。</p>\n<p>这个列表的目标是，把有 DOM 更新和其他影响的节点与这些影响关联起来。这个列表是 finishedWork 树的一个子集，而且使用 nextEffect 属性来做连接，而不是在 current 和 workInProgress 树中使用的 child 属性。</p>\n<p><a href=\"https://medium.com/@dan_abramov\">Dan Abramov</a> 提供了一个给影响列表的类比。他喜欢把它比做成一个圣诞树，在这个树上，使用圣诞灯把所有有影响的节点绑在一起。为了把这些可视化，我们可以想象一个拥有以下 fiber 节点的树，在树上，高亮的节点有一些操作需要被执行。比如说，我们的更新导致 c2 被插入到 DOM 总， d2 和 c1 更新属性，b2 出发了生命周期方法。影响列表会把他们连在一起，这样 React 就能够跳过其他节点。</p>\n<p>你可以看到，有影响的节点如何被连接在一起。当遍历节点时，React 使用 firstEffect 节点来指向列表的开头。所以上面的图能够被表示成一个线性的列表，如下所示：</p>\n<p>正如你所看到的，React 会以从孩子到父母的顺序来执行这些影响。</p>\n<h5>fiber 节点的根</h5>\n<p>每个 React 应用都有一个或多个 DOM 节点作为容器。在沃恩的例子中，是一个有 id 属性的 div 元素。React 给这些每个容器创建一个<a href=\"https://github.com/facebook/react/blob/0dc0ddc1ef5f90fe48b58f1a1ba753757961fc74/packages/react-reconciler/src/ReactFiberRoot.js#L31\">fiber 根</a>对象。你能够通过使用对这些 DOM 元素的引用来访问到它。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fiberRoot <span class=\"token operator\">=</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#container\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>_reactRootContainer<span class=\"token punctuation\">.</span>_internalRoot<span class=\"token punctuation\">;</span></code></pre></div>\n<p>fiber 根是 React 存放 fiber 树引用的地方。fiber 树被存放在 fiber 根的 current 属性上。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> hostRootFiberNode <span class=\"token operator\">=</span> fiberRoot<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span></code></pre></div>\n<p>fiber 树以一个特殊类型的 fiber 节点开始，它就是 HostRoot。它在内部创建，作为你最上层组件的父亲。在 HostRoot fiber 节点和 FiberRoot 可以通过 stateNode 属性相联系：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">fiberRoot<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">===</span> fiberRoot<span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span></code></pre></div>\n<p>你可以经由 fiber 根访问最上层的 HostRoot fiber 节点，从而进入 fiber 树。或者你也可以通过组件实例直接获得单个 fiber 节点：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">compInstance<span class=\"token punctuation\">.</span>_reactInternalFiber<span class=\"token punctuation\">;</span></code></pre></div>\n<h5>fiber 节点结构</h5>\n<p>现在让我们来看看由<code class=\"language-text\">ClickCounter</code>组件创建起来的 fibeer 节点的结构，如下</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> ClickCounter<span class=\"token punctuation\">,</span>\n    alternate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    tag<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    nextEffect<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>以及 span DOM 元素的 fiber 节点：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    alternate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    tag<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    nextEffect<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 fiber 节点上有很多属性。在之前有谈到过<code class=\"language-text\">alternate</code>、<code class=\"language-text\">affectTag</code>和<code class=\"language-text\">nextEffect</code>的作用。现在让我们来看看我们为什么需要其他属性。</p>\n<h6>stateNode</h6>\n<p>容纳指向与此 fiber 节点像关联的组件、DOM 节点或者其他 React 元素类型实例的引用。一般来说，我们说，这个属性被用来存放 fiber 节点的本地状态。</p>\n<h6>type</h6>\n<p>定义与这个 fiber 相关的组件或者类。对于类组件，它指向构造器方法，对于 DOM 元素来说，它指向 HTML 标签。我经常使用这个属性，来弄清一个 fiber 节点与什么元素相关联。</p>\n<h6>tag</h6>\n<p>定义 fiber 的<a href=\"https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/shared/ReactWorkTags.js\">类型</a>。它被用在 reconciliation 算法中，用于决定需要做什么工作。正如之前提到的，根据 React 元素的类型，需要做的工作内容是不同的。函数<a href=\"https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js#L414\">createFiberFromTypeAndProps</a>会把一个 React 元素映射为与对应类型的 fiber 节点。在我们的应用中，<code class=\"language-text\">ClickCounter</code>组件的 tag 属性是 1，代表它是一个类组件，对于 span 元素，tag 属性是 5，代表它是一个宿主组件（HostComponent）。</p>\n<h6>updateQueue</h6>\n<p>一个状态更新、回调和 DOM 更新的队列。</p>\n<h6>memoizedState</h6>\n<p>用于创建输出的 fiber 状态。在处理更新时，它反映现在被渲染在屏幕上的状态。</p>\n<h6>pendingProps</h6>\n<p>React 元素中，来自新数据的已经被更新的属性，它之后会被用于子组件或 DOM 元素。</p>\n<h6>key</h6>\n<p>一组子元素中，用于标识哪项已经被更新了、已经被加入或这已经被移除列表的唯一标识符。它和 React 在<a href=\"https://reactjs.org/docs/lists-and-keys.html#keys\">这里</a>描述的“列表和 key 值”功能相关。</p>\n<p>你可以在<a href=\"https://github.com/facebook/react/blob/6e4f7c788603dac7fccd227a4852c110b072fe16/packages/react-reconciler/src/ReactFiber.js#L78\">这里</a>找到 fiber 节点的完整结构，在上面的描述中我忽略了一堆属性。特别的，我跳过了构成树形数据结构的 child、sibling 和 return，我在之前的文章中有提到过他们。还有一类属性，比如 expirationTime、childExpirationTime 和 mode，他们对调度（Scheduler）很重要。</p>\n<hr>\n<h4>通用算法</h4>\n<p>React 主要在两个阶段执行操作：渲染（render）和提交（commit）。</p>\n<p>在第一次渲染阶段，React 把通过<code class=\"language-text\">setState</code>和<code class=\"language-text\">React.render</code>把更新推给组件调度，指出在 UI 中需要更新的内容。如果时初次渲染，React 为每个从 render 方法返回的元素创建一个新的 fiber 节点。在之后的更新中，已存 React 元素的 fiber 可以重复使用并更新。这个阶段的结果，是一颗 fiber 节点组成的树，并且节点都被标记上了对应应该执行的副作用。副作用描述了在下面 commit 阶段应该做的事情。在 commit 阶段，React 会拿到标记了副作用的 fiber 树并把他们应用到实例上。它会遍历副作用树，执行 DOM 更新和其他对用户可见的变化。</p>\n<p>有一点你需要知道的是，第一次 render 阶段的工作可以被异步执行。React 可以根据可用时间来处理一个或多个 fiber 节点，然后它会保存已完成的工作，转向其他内容。之后它会从它停下的位置继续开始。然而，有时候也会丢弃易完成的工作从头开始。这种暂停可以被实现，是基于一个事实，这个事实是，在 render 阶段所作的工作不会产生任何用户可见的变化（比如 DOM 更新）。相反，之后的 commit 阶段则总是同步的。这是因为在这个极端执行的工作会产生用户可见的变化（比如 DOM 更新）。这也是为什么需要一次性执行他们。</p>\n<p>调用生命周期方法是 React 执行一类工作。有些方法在 render 阶段被调用，有些则在 commit 阶段。下面是第一次 render 阶段执行的生命周期列表：</p>\n<ul>\n<li>[UNSAFE_]componentWillMount (deprecated)</li>\n<li>[UNSAFE_]componentWillReceiveProps (deprecated)</li>\n<li>getDerivedStateFromProps</li>\n<li>shouldComponentUpdate</li>\n<li>[UNSAFE_]componentWillUpdate (deprecated)</li>\n<li>render</li>\n</ul>\n<p>正如你所看到的，从 16.3 版本开始，一些老的不建议使用的生命周期方法都被标记上了<code class=\"language-text\">UNSAFE</code>。在文档中，他们被称作遗留生命周期。在未来的 16.x 版本中，他们会被 deprecated。他们对应<code class=\"language-text\">UNSAFE</code>后面的方法，会在 17 版本中被移除。你能够在<a href=\"https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html\">这里</a>了解到更多相关变化以及建议的迁移方式。</p>\n<p>你想知道原因吗？</p>\n<p>我们刚才已经知道了，在 render 阶段不产生类似于 DOM 更新的副作用，React 会异步处理更新，异步应用给组件（他们甚至会在多个线程中进行）。然而，被标记了 UNSAFE 的生命周期方法经常会被错误理解，从而被误用。开发者会把一些有副作用的代码放在这些方法里面，这回给新的一步渲染方式造成麻烦。虽然只是 UNSAFE 后面部分的方法被移除，在未来的并发模式中，他们依然很可能会引发问题。</p>\n<p>在 commit 阶段执行的生命周期方法列表如下：</p>\n<ul>\n<li>getSnapshotBeforeUpdate</li>\n<li>componentDidMount</li>\n<li>componentDidUpdate</li>\n<li>componentWillUnmount</li>\n</ul>\n<p>因为这写方法在同步的 commit 阶段被执行，所以他们可能包含副作用，也可能会接触到 DOM。</p>\n<p>现在，我们已经了解到了遍历树和执行工作的通用算法，让我们继续深入一点吧。</p>\n<hr>\n<h4>render 阶段</h4>\n<p>reconciliation 算法使用 <a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1132\">renderRoot</a>方法，从最顶端的 <code class=\"language-text\">HostRoot</code>节点开始。React 会跳过已经被处理过的 fiber 节点，直到它找到有未完成工作的节点。比如说，如果你在组件树比较深的层级中调用<code class=\"language-text\">setState</code>方法，React 会从顶端开始，快速跳过其祖先，知道达到调用 setState 的节点。</p>\n<h5>工作循环中的主要步骤</h5>\n<p>所有的节点都会在<a href=\"https://github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js#L1136\">工作循环</a>中被处理。下面是循环同步部分的实现：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>isYieldy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isYieldy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在上面的代码中，nextUnitOfWork 是一个引用，指向 workInProgress 树上有待执行工作的 fiber 节点。React 会遍历 Fiber 树，它会使用这个变量来知道这里是否还有用待完成工作的 fiber 节点。在 current fiber 被处理完之后，这个遍历会包含一个指向书中下一个 fiber 节点的引用，或者是 null。在这种情况下，React 就会退出工作循环，准备提交这些变化。</p>\n<p>在遍历树、初始化和完成工作时，有四个主要的函数：</p>\n<ul>\n<li>performUnitOfWork</li>\n<li>beginWork</li>\n<li>completeUnitOfWork</li>\n<li>completeWork</li>\n</ul>\n<p>为了演示他们时怎么被使用的，你可以看看这个<a href=\"https://vimeo.com/302222454\">视频</a>。在 demo 中我使用了这些方法的简化实现。每个函数会接受一个待处理的 fiber 节点，在 React 顺着树从上往下的过程中，你可以看到被激活的 fiber 节点在不断变化。你也可以看到算法如何从一个分支切换到另外一个分支。他会先完成子节点的工作然后移动到父节点。</p>\n<blockquote>\n<p>注意，垂直而下的代表的时兄弟，弯曲而下代表的时父子。比如 b1 没有子节点，b2 有一个子节点 c1</p>\n</blockquote>\n<p>在这个<a href=\"https://vimeo.com/302222454\">视频</a>中，你可以暂停播放，仔细看到每个现在处理的节点以及函数的状态。从概念上来说，你可以把“开始”看作成“进入”一个组件，把“完成”看作”走出“这个组件。你也可以在这个<a href=\"https://stackblitz.com/edit/js-ntqfil?file=index.js\">示例实现</a>中进行探索。</p>\n<p>让我们以开始的两个方法<code class=\"language-text\">performUnitOfWork</code>和<code class=\"language-text\">beginWork</code>开始：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    next <span class=\"token operator\">=</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> next<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"work performed for \"</span> <span class=\"token operator\">+</span> workInProgress<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">performUnitOfWork</code>接受一个<code class=\"language-text\">workInProgress</code>树上的 fiber 节点，以调用<code class=\"language-text\">beginWork</code>方法开始。它是一个 fiber 所需进行所有活动的开端。为了演示的目的，我们简单地把 logfiber 的名字代表需要完成的工作。<code class=\"language-text\">beginWork</code>方法总是返回一个指针，指向循环中下一个待处理的子节点，或者是 null。</p>\n<p>如果这里有下一个子节点，则子节点会被复制给<code class=\"language-text\">workLoop</code>方法中的<code class=\"language-text\">nextUnitOfWork</code>这个变量。相反，如果它没有子节点，则 React 知道，它已经到达了分支的最末端，所以它能够结束现在进行的这个节点了。一旦一个节点被完成，它需要转向其兄弟，或者在其兄弟也完成后转向其父母。这些都是在<code class=\"language-text\">completeUnitOfWork</code>方法中进行的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> returnFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span><span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> siblingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>siblingFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// If there is a sibling, return it</span>\n      <span class=\"token comment\">// to perform work for this sibling</span>\n      <span class=\"token keyword\">return</span> siblingFiber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// If there's no more work in this returnFiber,</span>\n      <span class=\"token comment\">// continue the loop to complete the parent.</span>\n      workInProgress <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// We've reached the root.</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"work completed for \"</span> <span class=\"token operator\">+</span> workInProgress<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>你可以看到，这个方法的概要，就是个大的 while 循环。React 会在一个<code class=\"language-text\">workInProgress</code>节点没有子节点时进入到这个方法中。在完成现有 fiber 的工作后，它会检查，是否存在节点的兄弟，如果找到，React 会退出这个方法，返回一个指向这个兄弟的指针。这个指针会被复制给<code class=\"language-text\">nextUnitOfWork</code>变量，React 会开始指向以这个兄弟节点为开始的分支的工作。需要注意的是，在这个时候，React 只是完成了先前那个节点的工作，它并没有完成其父节点的工作。当且仅当所有以其子节点开始的分支都被完成了，才会完成父节点，并进行转向。</p>\n<p>正如你所看到的，在<code class=\"language-text\">performUnitOfWork</code>和<code class=\"language-text\">completeUnitOfWork</code>是用来做遍历的，二主要的活动那个则发现在<code class=\"language-text\">beginWork</code>和<code class=\"language-text\">completeWork</code>中。在这个系列的下面的文章中，我们会学习，对于<code class=\"language-text\">clikcCounter</code>组件和<code class=\"language-text\">span</code>节点，进入<code class=\"language-text\">beginWork</code>和<code class=\"language-text\">completeWork</code>发生了什么。</p>\n<hr>\n<h4>commit 阶段</h4>\n<p>这个阶段以<a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L2306\">completeRoot</a>函数开始。这里是 React 更新 DOM 和调用更新前、更新后生命周期方法的地方。</p>\n<p>当 React 进入到这个阶段时，它会有两棵树以及一个影响列表。第一颗树代表的时渲染在屏幕上的现有状态。另外还有以可替换树，它时在 render 阶段构建起来的。在源码中，它被称为<code class=\"language-text\">finishedWorkd</code>或<code class=\"language-text\">workInProgress</code>，它代表这需要被反映在屏幕上的状态。这课替换树和 current 树类似，也是通过 child 和 sibling 指针连接起来的。</p>\n<p>继续，这里有一个影响列表——它时 finishedWork 树的子集，之间通过 <code class=\"language-text\">nextEffect</code>指针相连接。记住，影响列表是 render 阶段的结果。render 阶段的意义就在于决定哪个节点应该被插入、被更新、被删除，哪个组件需要有生命周期方法被调用。这些都是影响列表告诉我们的。它也是一系列需要在 commit 阶段被遍历的节点。</p>\n<blockquote>\n<p>为了 debug 的目的，current 树可以通过 fiber 根的 <code class=\"language-text\">current</code>属性访问到。finishedWork 树可以通过 current 树中<code class=\"language-text\">HostFiber</code>节点的<code class=\"language-text\">alternate</code>属性访问到。</p>\n</blockquote>\n<p>在 commit 阶段被调用的主要方法是<code class=\"language-text\">commitRoot</code>。大致上说，它做了以下工作：</p>\n<ul>\n<li>在标记了<code class=\"language-text\">Snapshot</code>影响的节点上调用<code class=\"language-text\">getSnapshotBeforeUpdate</code>生命周期方法</li>\n<li>在标记了<code class=\"language-text\">Deletion</code>影响的节点上调用<code class=\"language-text\">componentWillUnmount</code>生命周期方法</li>\n<li>执行所有的 DOM 插入、更新和删除</li>\n<li>把 finishedWork 树置为 current 树</li>\n<li>在标记了<code class=\"language-text\">Placement</code>影响的节点上调用<code class=\"language-text\">componentDidMount</code>生命周期方法</li>\n<li>在标记了<code class=\"language-text\">Update</code>影响的节点上调用<code class=\"language-text\">componentDidUpdate</code>生命周期方法</li>\n</ul>\n<p>在调用变更前方法<code class=\"language-text\">getSnapshotBeforeUpdate</code>之后，React 会在一棵树中提交所有的副作用。这会在两部进行。第一步是执行所有的 DOM（host）插入、更新、删除和 ref 卸载。React 会把 finishedWork 树赋值给<code class=\"language-text\">FiberRoot</code>，使得 finishedWork 树成为 current 树。这会在 commit 阶段第一步完成之后执行，所以在 componentWillUnmount 期间，之前的那棵树还是 current 树。但是在它的执行是在第二步之前，所以在执行 componentDidMount/Update 时，finishedWork 已经时 current 树了。在第二步中，React 会调用所有的其他生命周期方法和 ref 回调。这些方法是在一个单独的步骤中进行的，此时整棵树中所有的替换、更新和删除已经被调用了。</p>\n<p>这里有一个执行上述步骤的函数梗概：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">commitBeforeMutationLifecycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">commitAllHostEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">commitAllLifeCycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>每个子方法会实现一个循环，这个循环会遍历影响列表并检查影响类型。当它发现子方法需要被用于的影响时，则会在这个影响上调用这个子函数。</p>\n<h5>变更前生命周期方法</h5>\n<p>举例来说，下面的代码展示了一个例子，它会遍历影响树，检查节点是否有<code class=\"language-text\">Snapshot</code>影响：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitBeforeMutationLifecycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> Snapshot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">commitBeforeMutationLifeCycles</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>对一个类方法来说，这个影响意味着调用<code class=\"language-text\">getSnapshotBeforeUpdate</code>生命周期方法。</p>\n<h5>DOM 更新</h5>\n<p><a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376\">commitAllHostEffects</a>是 React 执行所有 DOM 更新的函数。这个函数定义了对一个节点来说需要进行的操作的类型并执行它：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitAllHostEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>primaryEffectTag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> Placement<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">...</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> PlacementAndUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">...</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> Update<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">...</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> Deletion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">...</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>有趣的是，React 把 componentWillMount 生命周期方法作为删除过程的一部分在<code class=\"language-text\">commitDeletion</code>函数中进行。</p>\n<h5>变更后生命周期方法</h5>\n<p><a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L465\">commitAllLifecycles</a>是 React 调用剩余生命周期方法<code class=\"language-text\">componentDidUpdate</code>和<code class=\"language-text\">componentDidMount</code>的地方。</p>\n<hr>\n<p>We're finally done！</p>","fields":{"postName":"Fiber内部：深入了解React中新的reconciliation算法"}}},{"node":{"id":"1fc5a68a-b3dd-562b-9a49-939674b93f0d","frontmatter":{"title":"深入了解React中state和props的更新","date":"2019-01-06","description":"此文为译文，原文见：https://medium.com/react-in-depth/in-depth-explanation-of-state-and-props-update-in-react-51ab94563311"},"html":"<p>在上<a href=\"https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e\">一篇文章</a>中，我讲解了一些基础，这些基础是理解这篇文章中描述更新过程中的技术细节所必需的。</p>\n<p>我讲述了在这篇文章中会用到的主要数据结构和概念，特别是 Fiber 节点、current 和 work-in-progress 树、副作用和副作用列表。我也提供了一个主要算法的概览，并说明了 render 阶段和 commit 阶段的不同点。如果你还没有阅读上一篇文章，我推荐你从那里开始。</p>\n<p>我也介绍了一个简单的应用，只有一个按钮，点击后会增加渲染在屏幕上数字的大小。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4cb17450b9c01101e2d65de05be09c8e/13cfa/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 550px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 21.386430678466077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABJ0AAASdAHeZh94AAAAVElEQVQY05WO0QqAIBRD/f/vK3yJ9BPiXi0w2/KhoAe74GAw2DjM8UcAaKvfux7ohQEXc1aKbExJmpX1LJ8eo8DKGBZ6PzXPXGPgseuzGQDaGebDG03zPCtuy+5RAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"1\"\n        title=\"\"\n        src=\"/static/4cb17450b9c01101e2d65de05be09c8e/542ea/1.png\"\n        srcset=\"/static/4cb17450b9c01101e2d65de05be09c8e/e35fc/1.png 138w,\n/static/4cb17450b9c01101e2d65de05be09c8e/4417e/1.png 275w,\n/static/4cb17450b9c01101e2d65de05be09c8e/542ea/1.png 550w,\n/static/4cb17450b9c01101e2d65de05be09c8e/13cfa/1.png 678w\"\n        sizes=\"(max-width: 550px) 100vw, 550px\"\n      />\n  </span>\n  </a></p>\n<p>它的实现如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token operator\">&lt;</span>button key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span> onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n        Update counter\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">&lt;</span>span key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在这里我给组件添加了<code class=\"language-text\">componentDidUpdate</code>生命周期方法，它将用于展示在 React 在 commit 阶段如添加影响，调用这个方法。</p>\n<p>在这篇文章中，我想向你展示 React 如何处理状态更新并建立副作用列表。我们将带你看到在 render 和 commit 阶段的高级函数中发生了什么。</p>\n<p>特别的，我们将看到在<code class=\"language-text\">completeWork</code>函数中，React 如何：</p>\n<ul>\n<li>更新<code class=\"language-text\">ClickCounter</code> <code class=\"language-text\">state</code>中的<code class=\"language-text\">count</code>属性</li>\n<li>调用<code class=\"language-text\">render</code>方法来获得一个子元素列表并执行对比</li>\n<li>更新<code class=\"language-text\">span</code>元素的属性</li>\n</ul>\n<p>和在<code class=\"language-text\">commitRoot</code>中，React：</p>\n<ul>\n<li>更新<code class=\"language-text\">span</code>元素的<code class=\"language-text\">textContent</code>属性</li>\n<li>调用<code class=\"language-text\">componentDidUpdate</code>生命周期方法</li>\n</ul>\n<p>在那之前，让我们先快速看一下当我们在点击处理函数中调用<code class=\"language-text\">setState</code>方法时，工作时如何调度的。</p>\n<p>注意，你不用理解这些也能使用 React，这篇文章时关于 React 内部是如何工作的。</p>\n<hr>\n<h4>调度更新</h4>\n<p>当我们点击按钮时，<code class=\"language-text\">click</code>事件被触发，React 执行被传入 button 属性的回调。在我们的应用中，它仅仅增加计数并更新状态。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>每个 React 组件有一个与之相关联的<code class=\"language-text\">updater</code>，它作为一个桥梁，连接组件和 React 核心。这使得<code class=\"language-text\">setState</code>能够能够被 React DOM、ReactNative、服务端渲染和测试工具中被以不同的方式进行实现。</p>\n<p>在这篇文章中，我们将看到 ReactDOM 中<code class=\"language-text\">updater</code>对象的实现，而 React DOM 中私用的则是 Fiber reconciler。对于<code class=\"language-text\">ClickCounter</code>组件来说，这个<code class=\"language-text\">updater</code>是<code class=\"language-text\">classComponentUpdater</code>。它负责获取一个 Fiber 实例、队列更新以及调度工作。</p>\n<p>当更新被加入队列中，他们被加入到需要在一个 Fiber 节点上被处理的更新的队列中。在我们的例子中，与<code class=\"language-text\">ClickCounter</code>组件相关联的 Fiber 节点有以下结构：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> ClickCounter<span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n         baseState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n         firstUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n             next<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                 payload<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n             <span class=\"token punctuation\">}</span>\n         <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n         <span class=\"token operator\">...</span>\n     <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n     <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>正如你所能够看到的，<code class=\"language-text\">updateQueue.firstUpdate.next.payload</code>中的函数时我们传入到<code class=\"language-text\">ClickCounter</code>组件<code class=\"language-text\">setState</code>中的回调。它代表的是，在 render 阶段需要被处理的第一个更新。</p>\n<hr>\n<h4>处理 ClickCounter Fiber node 的更新</h4>\n<p>我上篇文章中<a href=\"https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e\">有关工作循环的章节</a>解释了<code class=\"language-text\">nextUnitOfWork</code>全局变量的作用。具体来说，章节中降到了，这个变量包含一个引用，指向<code class=\"language-text\">workInProgress</code>树中有工作需要被执行的 Fiber 节点。当 React 遍历 Fiber 树时，它使用这个遍历来知道是否有其他 Fiber 节点有未被完成的工作。</p>\n<p>让我们假设<code class=\"language-text\">setState</code>节点被调用了，React 把来自<code class=\"language-text\">setState</code>的回调增加到<code class=\"language-text\">ClickCounter</code>fiber 节点的<code class=\"language-text\">updateQueue</code>中，并且开始调度工作。React 进入 render 阶段。它从最高的<code class=\"language-text\">HostRoot</code>Fiber 节点开始，使用<code class=\"language-text\">renderRoot</code>方法来遍历树。然而，它会跳过已经被处理过的 Fiber 节点，直到发现一个有未处理工作的节点。在我们的例子中，只有一个 Fiber 节点有未完成工作，他就是<code class=\"language-text\">ClickCounter</code>Fiber 节点。</p>\n<p>所有的工作都会在这个 Fiber 节点的克隆副本上进行，这个克隆父辈被存放在<code class=\"language-text\">alternate</code>属性上。如果这个 alternate 节点还没有被创建，则 React 会在处理更新前，调用<code class=\"language-text\">createWorkInProgress</code>方法创建副本。让我们假设，变量<code class=\"language-text\">nextUnitOfWork</code>中存放了一个 alternate <code class=\"language-text\">ClickCounter</code> Fiber 节点的引用。</p>\n<h5>beginWork</h5>\n<p>首先，我们的 Fiber 进入到<a href=\"https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L1489\">beginWork</a>。</p>\n<blockquote>\n<p>因为这个方法会在一个树的每个 Fiber 节点上被执行，所以如果你想要 debug render 阶段，这个地方是一个打断点的好地方。我在这里打断点，并区检查一个 Fiber 节点的类型，来找到我需要的那个。</p>\n</blockquote>\n<p><code class=\"language-text\">beginWork</code>函数时一个大的<code class=\"language-text\">switch</code>语句，通过 Fiber 节点的 tag 来判断什么类型的工作需要在这个 Fiber 节点上被执行，然后执行对应的函数来处理工作。当<code class=\"language-text\">CountClicks</code>是一个类组件时，这个分支时这样的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current$$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>\n        <span class=\"token keyword\">case</span> FunctionalComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">updateClassComponent</span><span class=\"token punctuation\">(</span>current$$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后我们进入到了<code class=\"language-text\">updateClassComponent</code>方法。根据这是组件的第一次渲染、或者时组件更新的恢复再或者是组件的更新，React 会创建一个实例、或者挂载这个组件再或者更新它：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateClassComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> Component<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> shouldUpdate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>\n        <span class=\"token comment\">// In the initial pass we might need to construct the instance.</span>\n        <span class=\"token function\">constructClassInstance</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> Component<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">mountClassInstance</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> Component<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        shouldUpdate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// In a resume, we'll already have an instance we can reuse.</span>\n        shouldUpdate <span class=\"token operator\">=</span> <span class=\"token function\">resumeMountClassInstance</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> Component<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        shouldUpdate <span class=\"token operator\">=</span> <span class=\"token function\">updateClassInstance</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">finishClassComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> Component<span class=\"token punctuation\">,</span> shouldUpdate<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h5>处理 ClickCounter Fiber 的更新</h5>\n<p>我们已经有了一个<code class=\"language-text\">ClickCounter</code>组件的实例，所以我们进入到<code class=\"language-text\">updateClassInstance</code>方法中。这是 React 执行大部分类组件工作的地方。在这个函数中执行的重要操作，安装执行顺序排列如下：</p>\n<ul>\n<li>调用<code class=\"language-text\">UNSAFE_componentWillReceiveProps()</code>钩子（deprecated）</li>\n<li>处理<code class=\"language-text\">updateQueue</code>中的更新，并产生一个新的状态</li>\n<li>使用新状态调用<code class=\"language-text\">getDerivedStateFromProps</code>获得结果</li>\n<li>调用<code class=\"language-text\">shouldComponentUpdate</code>来保证组件确实需要被更新；如果结果为 false，则跳过整个渲染阶段，包括在这个组件和其子组件上调用 render；否则则处理更新</li>\n<li>调用<code class=\"language-text\">UNSAFE_componentWillUpdate</code>（depricated）</li>\n<li>增加一个影响，用来出发<code class=\"language-text\">componentDidUpdate</code>生命周期钩子</li>\n</ul>\n<blockquote>\n<p>虽然调用<code class=\"language-text\">componentDidUpdate</code>的影响时在 render 阶段被添加的，但是这个方法时在 commit 阶段被执行的。</p>\n</blockquote>\n<ul>\n<li>在组件实例上更新<code class=\"language-text\">state</code>和<code class=\"language-text\">props</code></li>\n</ul>\n<blockquote>\n<p>state 和 props 子 render 方法被调用之前在组件实例上被更新，因为 render 方法的结果往往取决于 state 和 props。如果不这样做，每次 render 方法都将返回相同的结果。</p>\n</blockquote>\n<p>下面是这个方法的一个简化版本：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateClassInstance</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> ctor<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> oldProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n    instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> oldProps<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps <span class=\"token operator\">!==</span> newProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">callComponentWillReceiveProps</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> updateQueue <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">processUpdateQueue</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> updateQueue<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        newState <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">applyDerivedStateFromProps</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    newState <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> shouldUpdate <span class=\"token operator\">=</span> <span class=\"token function\">checkShouldComponentUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">,</span> ctor<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldUpdate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentWillUpdate</span><span class=\"token punctuation\">(</span>newProps<span class=\"token punctuation\">,</span> newState<span class=\"token punctuation\">,</span> nextContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Update<span class=\"token punctuation\">;</span>\n        workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Snapshot<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> newProps<span class=\"token punctuation\">;</span>\n    instance<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> shouldUpdate<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在上面的代码片段中，我移除了一些辅助代码。比如说，在调用生命周期周期方法或增加触发他们的影响时之前，React 会使用<code class=\"language-text\">typeof</code>操作符检查一个组件是否实现了这些方法。比如说，增加影响前，对<code class=\"language-text\">componentDidUpdate</code>方法的检查：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> instance<span class=\"token punctuation\">.</span>componentDidUpdate <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Update<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>所以，我们知道了在 render 阶段，会有哪些操作在<code class=\"language-text\">ClickCounter</code>Fiber 节点上执行。让我们现在来看看这些操作如何更不 Fiber 节点上的值。当 React 开始工作时，<code class=\"language-text\">ClickCounter</code>对应的 Fiber 节点看起来类似于下面的样子：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    elementType<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    firstEffect<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        state<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        baseState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        firstUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            next<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                payload<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>…<span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>完成工作后，FIber 节点将看起来像这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    elementType<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    firstEffect<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    memoizedState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClickCounter</span><span class=\"token punctuation\">,</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        state<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        baseState<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        firstUpdate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>让我们花点时间来看下属性值的变化。</p>\n<p>在更新被实施之后，<code class=\"language-text\">memoizedState</code>和<code class=\"language-text\">updateQueue</code>中<code class=\"language-text\">baseState</code>，count 属性的值变为了 1。React 也更新了<code class=\"language-text\">ClickCounter</code>组件实例中的状态。</p>\n<p>在这时，在队列中已经没有更新，所以<code class=\"language-text\">firstUpdate</code>的值时<code class=\"language-text\">null</code>。另外，重要的是，我们更新了<code class=\"language-text\">effectTag</code>属性。它不再是 0，而是 4。4 的二进制是 100，也就是第三字节被设置了，而这正是<code class=\"language-text\">update</code>副作用 tag 的字节：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Update <span class=\"token operator\">=</span> <span class=\"token number\">0b00000000100</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>总结来说，当处理父元素<code class=\"language-text\">ClickCounter</code>Fiber 节点时，React 会调用变更前生命周期方法，更新状态并定义相关的副作用。</p>\n<h5>reconcililng ClickCounter Fiber 子元素</h5>\n<p>一旦上面说的都完成了，React 则会进入<code class=\"language-text\">finishClassComponent</code>。这是 React 调用一个组件实例 render 方法的地方，并且会将对比算法运用在组件返回的子元素上。有关这个概览可以在<a href=\"https://reactjs.org/docs/reconciliation.html#the-diffing-algorithm\">文档</a>中看到。相关部分如下：</p>\n<blockquote>\n<p>当对比两个相同类型的 React DOM 元素，React 检查他们两个的属性、保持其下相同的 DOM 节点，仅仅更新变更过的属性。</p>\n</blockquote>\n<p>如果深入了解，我们会发现，其实它对比的是 Fiber 节点和 React 元素。我不会深入到这些细节。我会单独写有关子 reconciliation 的文章。</p>\n<blockquote>\n<p>如果你很好奇里面的细节，你也可以去看<code class=\"language-text\">reconcileChildrenArray</code>方法，因为在我们的应用中，render 方法返回了一个 React 元素组成的数组。</p>\n</blockquote>\n<p>到这里，有两个需要注意的点。首先，当 React 进行子 reconciliation 过程时，它创建或更新从 render 方法返回子 React 元素的 Fiber 节点。<code class=\"language-text\">finishClassComponent</code>函数返回对 current Fiber 节点的第一个孩子的引用。这个引用会被赋值给<code class=\"language-text\">nextUnitOfWork</code>，并且在工作循环中被处理。其次，React 把在孩子上更新 props 的工作看作是在其父元素工作的一部分。这个过程，用到了来自 React 元素 render 方法返回的数据。</p>\n<p>比如，在 React reconcile ClickCounter fiber 的孩子之前，span 元素对应的 Fiber 节点看起来是这样的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n    memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>正如你所看到的，在<code class=\"language-text\">memoizedProps</code>和<code class=\"language-text\">pendingProps</code>中，<code class=\"language-text\">children</code>属性都是 0。下面是 span 元素 render 方法返回的结构：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>react<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">;</span>\n  props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    children<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  ref<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>正如你所看到的，Fiber 节点和返回的 React 元素的 props 是不同的。在用来创建 alernate Fiber 节点的<code class=\"language-text\">createWorkInProgress</code>方法中，React 会把更新后的属性从 React 元素复制到 Fiber 节点中。</p>\n<p>所以，React 在 ClickCounter 组件上完成 reconcile 子元素后，span Fiber 节点将会有一个<code class=\"language-text\">pendingProps</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n    memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>之后，当 React 在 span Fiber 节点上执行工作时，它会把它们复制给<code class=\"language-text\">memoizedProps</code>，并且增加影响来更新 DOM。</p>\n<p>这就是 render 阶段，React 对 ClickCounter fiber 节点做的所有工作。因为 button 是 ClickCounter 的第一个孩子，所以它会被赋值给<code class=\"language-text\">nextUnitOfWork</code>变量。对于它来说，这里并没有需要做的事情，所以 React 会转向它的兄弟，也就是 span Fiber 节点。根据在<a href=\"https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e#25fb\">这里</a>描述的算法，这个转移发生在<code class=\"language-text\">completeUnitOfWork</code>方法中。</p>\n<h5>处理 span fiber 的更新</h5>\n<p>所以，这时<code class=\"language-text\">nextUnitOfWork</code>指向 span fiber 的 alternate，并且 React 开始在它上面执行工作。和在 ClickCounter 执行工作的步骤类似，我们以<code class=\"language-text\">beginWork</code>方法开始。</p>\n<p>因为我们的 span 节点是<code class=\"language-text\">HostComponent</code>类型，所以这次，在 switch 语句中，React 会采用以下分支：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current$$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> FunctionalComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>它将以<code class=\"language-text\">updateHostComponent</code>方法结束。它对应于类组件的<code class=\"language-text\">updateClassComponent</code>方法。对于一个函数组件来说，它是<code class=\"language-text\">updateFunctionComponent</code>，等等。你可以在<code class=\"language-text\">ReactFiberBeginWork.js</code>中找到所有的这些方法。</p>\n<h5>reconcile span fiber 的子元素</h5>\n<p>在我们的例子中，对于 span 节点，<code class=\"language-text\">updateHostComponent</code>中并没有什么重要的内容。</p>\n<h5>完成 span Fiber 节点的工作</h5>\n<p>一旦<code class=\"language-text\">beginWork</code>结束，这个节点进入到<code class=\"language-text\">completeWork</code>方法中。但是在这之前，React 需要更新 span fiber 的<code class=\"language-text\">memoizedProps</code>。你应该还记得当在 ClickCounter 组件上 reconcile 孩子时，React 更新了 span Fiber 节点的<code class=\"language-text\">pendingProps</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n    memoizedProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>所以，一旦 span fiber 的<code class=\"language-text\">beginWork</code>完成，React 会更新<code class=\"language-text\">pendingProps</code>到对应的<code class=\"language-text\">memoizedProps</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current$$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> nextRenderExpirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps<span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后它会调用<code class=\"language-text\">completeWork</code>方法，它和<code class=\"language-text\">beginWork</code>类似，都是一个大的<code class=\"language-text\">swtich</code>语句：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>\n            <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>因为 span 节点是<code class=\"language-text\">HostComponent</code>，所以它会运行<code class=\"language-text\">updateHostComponent</code>方法。在这个方法中，React 大致会执行以下动作：</p>\n<ul>\n<li>准备 DOM 更新</li>\n<li>把它们增加到 span fiber 的<code class=\"language-text\">updateQueue</code>中</li>\n<li>增加更新 DOM 的影响</li>\n</ul>\n<p>在操作执行之前，span 节点看起来像这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>完成后，它看起来像这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    stateNode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLSpanElement</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    updateQueue<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"children\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意<code class=\"language-text\">effectTag</code>和<code class=\"language-text\">updateQueue</code>属性的不同。<code class=\"language-text\">effectTag</code>由 0 变为 4，4 的二进制是 100，正是更新副作用 tag 对应的值。这是在下面 commit 阶段 React 在这节点上唯一需要做的（指的是执行更新副作用）。<code class=\"language-text\">udpateQueue</code>顺序中装载了需要被用于更新的内容。</p>\n<p>一旦 React 处理完 ClickCounter 和它的孩子，render 阶段就结束了。现在可以在<code class=\"language-text\">FibeRoot</code>上把已完成的 alternate 树赋值给<code class=\"language-text\">finishWork</code>属性了。这也是需要被更新到屏幕上的新树。这可能会立即执行，也可能需要等一下，等到浏览器给 React 时间执行时。</p>\n<hr>\n<h4>影响列表</h4>\n<p>在我们的例子中，因为 span 节点和 ClickCounter 组件有副作用，React 会增加一个来联系，链接 span Fiber 节点和<code class=\"language-text\">HostFiber</code>的<code class=\"language-text\">firstEffect</code>属性。</p>\n<p>React 会在<a href=\"https://github.com/facebook/react/blob/d5e1bf07d086e4fc1998653331adecddcd0f5274/packages/react-reconciler/src/ReactFiberScheduler.js#L999\"><code class=\"language-text\">completeUnitOfWork</code></a>方法中构建一个影响列表。在我们的例子中，span 节点需要更新 text、ClickCounter 有回调钩子，其标识出影响的 Fiber 树如下：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/3e877/4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 505px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 58.81188118811882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHZhhcbwE//xAAaEAACAgMAAAAAAAAAAAAAAAABAgAQERMy/9oACAEBAAEFAipWbMGm7n//xAAWEQEBAQAAAAAAAAAAAAAAAAAhARD/2gAIAQMBAT8BiZ//xAAWEQADAAAAAAAAAAAAAAAAAAABEFH/2gAIAQIBAT8BNX//xAAcEAABAwUAAAAAAAAAAAAAAAABABAhAhEiMlH/2gAIAQEABj8Cxm/SgKtnElv/xAAbEAEAAgIDAAAAAAAAAAAAAAABEBEhQQAxYf/aAAgBAQABPyGybpW6OAwNaMyHqvCP/9oADAMBAAIAAwAAABAUz//EABcRAAMBAAAAAAAAAAAAAAAAAAEQESH/2gAIAQMBAT8QCIxf/8QAFxEAAwEAAAAAAAAAAAAAAAAAARARIf/aAAgBAgEBPxAoa1f/xAAZEAEBAQEBAQAAAAAAAAAAAAABIREAEHH/2gAIAQEAAT8Q0piRs+OVqWKK4XhfHIAmpG+f/9k='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"fiber tree with effect\"\n        title=\"\"\n        src=\"/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/3e877/4.jpg\"\n        srcset=\"/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/bcb14/4.jpg 138w,\n/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/568dc/4.jpg 275w,\n/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/3e877/4.jpg 505w\"\n        sizes=\"(max-width: 505px) 100vw, 505px\"\n      />\n  </span>\n  </a></p>\n<p>如下时带影响的节点构成的线性列表：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/08ee5adc51e84a3cd685adfd61f92989/4cc64/5.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 550px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 24.347826086956523%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/2gAMAwEAAhADEAAAAdsDAX//xAAXEAEBAQEAAAAAAAAAAAAAAAARAgEA/9oACAEBAAEFAigozK7/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/Aax//8QAFxAAAwEAAAAAAAAAAAAAAAAAACEyof/aAAgBAQAGPwKmUysP/8QAGRAAAgMBAAAAAAAAAAAAAAAAABEhQZHB/9oACAEBAAE/IZOiOkRZcf/aAAwDAQACAAMAAAAQC/8A/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/EBwyVf/EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAgEBPxAa7Av/xAAaEAEBAAIDAAAAAAAAAAAAAAABEQAxIVFx/9oACAEBAAE/ECU3bNYXUuFo1fGsPLMAMFehn//Z'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"5\"\n        title=\"\"\n        src=\"/static/08ee5adc51e84a3cd685adfd61f92989/fc6c6/5.jpg\"\n        srcset=\"/static/08ee5adc51e84a3cd685adfd61f92989/93e06/5.jpg 138w,\n/static/08ee5adc51e84a3cd685adfd61f92989/51ff6/5.jpg 275w,\n/static/08ee5adc51e84a3cd685adfd61f92989/fc6c6/5.jpg 550w,\n/static/08ee5adc51e84a3cd685adfd61f92989/4cc64/5.jpg 575w\"\n        sizes=\"(max-width: 550px) 100vw, 550px\"\n      />\n  </span>\n  </a></p>\n<hr>\n<h4>commit 阶段</h4>\n<p>这个阶段开始于<code class=\"language-text\">completeRoot</code>。在开始其他工作之前，它先把<code class=\"language-text\">FiberRoot</code>上的<code class=\"language-text\">finishdedWork</code>属性设置为<code class=\"language-text\">null</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">root<span class=\"token punctuation\">.</span>finishedWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>不像 render 阶段，commit 阶段总是同步的，所以可以安全更新<code class=\"language-text\">HostRoot</code>，用以显示 commit 的工作已经开始。</p>\n<p>commit 阶段是 React 更新 DOM、调用更新后生命周期方法<code class=\"language-text\">componentDidUpdate</code>的地方。为了做到这些，它会遍历在 render 阶段构建起来的影响列表，并应用他们。</p>\n<p>在 render 阶段，对于 span 和 clickCounter 节点，我们有了以下影响：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">:</span> ClickCounter<span class=\"token punctuation\">,</span> effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span> effectTag<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>ClickCounter effect tag 的值是 5，也就是二进制的 101，它定义了更新工作，在类组件中，它被翻译为<code class=\"language-text\">componentDidUpdate</code>生命周期方法。最后一位被设置，用来表明，对这个 Fiber 节点来说，render 阶段的所有的工作都已完成。</p>\n<p>span 的 effect tag，值为 4，也就是二进制的 100，它定义的更新工作是 host 组件的 DOM 更新。对于 span 元素来说，React 需要更新元素的<code class=\"language-text\">textContent</code>。</p>\n<hr>\n<h4>应用影响</h4>\n<p>让我们来看看 React 如何应用这些影响。用来应用影响的方法，<code class=\"language-text\">commitRoot</code>，一共有三个子函数构成：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">commitBeforeMutationLifecycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">commitAllHostEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">commitAllLifeCycles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>每一个子函数都会实现一个循环，这个循环会遍历影响列表，检查影响类型。如果它找到这个函数被设计应用到的影响，则它会实际应用这个影响。在我们的例子中，它会调用在 ClickCounter 组件上<code class=\"language-text\">componentDidUpdate</code>生命周期方法、更新 span 元素的 text。</p>\n<p>第一个函数 <a href=\"https://github.com/facebook/react/blob/fefa1269e2a67fa5ef0992d5cc1d6114b7948b7e/packages/react-reconciler/src/ReactFiberCommitWork.js#L183\">commitBeforeMutationLifeCycles</a>会查找<code class=\"language-text\">Snapshot</code>影响，并调用<code class=\"language-text\">getSnapshotBeforeUpdate</code>方法。但是，我们不用在 ClickCounter 组件上调用这个方法，因为 React 在 render 阶段并没有添加这个影响。所以在我们的例子中，这个函数什么都不会做。</p>\n<hr>\n<h4>DOM 更新</h4>\n<p>接下来，React 移动到<code class=\"language-text\">commitAllHostEffects</code>函数。在这里，React 将会把 span 元素的 text 由 0 变为 1。在这里，对于 ClickCounter 组件什么都不会做，因为类组件对应的节点没有任何 DOM 更新。</p>\n<p>函数的实现是，它挑选对应类型的影响，并进行对应的操作。在我们的例子中，我们需要更新 span 元素的 text，所以我们会采用<code class=\"language-text\">Update</code>分支：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateHostEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>primaryEffectTag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> Placement<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> PlacementAndUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Update<span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">var</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n          <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Deletion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>顺着<code class=\"language-text\">commitWork</code>方法而下，我们最终会进入到<code class=\"language-text\">updateDOMProperties</code>方法，它会使用在 render 阶段添加到 Fiber 节点上的<code class=\"language-text\">updateQueue</code>来更新 span 元素的<code class=\"language-text\">texttContent</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateDOMProperties</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> updatePayload<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> propKey <span class=\"token operator\">=</span> updatePayload<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> propValue <span class=\"token operator\">=</span> updatePayload<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 DOM 更新被应用之后，React 会把<code class=\"language-text\">finishedWork</code>树赋值给<code class=\"language-text\">HostRoot</code>。它会把 alternate 树设置为 current 树：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h4>调用更新后生命周期钩子</h4>\n<p>剩下的最后一个函数是<code class=\"language-text\">commitAllLifecycles</code>。这是 React 调用更新后生命周期方法的地方。在 render 阶段，React 给 ClickCounter 方法添加了 <code class=\"language-text\">Update</code>影响。这是<code class=\"language-text\">commitAllLifecycles</code>函数寻找的并调用<code class=\"language-text\">componentDidUpdate</code>方法的影响之一：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitAllLifeCycles</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>Update <span class=\"token operator\">|</span> Callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">commitLifeCycles</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> Ref<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">commitAttachRef</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这个方法也会更新<code class=\"language-text\">refs</code>，但是因为我们没有任何 refs，所以这个功能不会被用到。<a href=\"https://github.com/facebook/react/blob/e58ecda9a2381735f2c326ee99a1ffa6486321ab/packages/react-reconciler/src/ReactFiberCommitWork.js#L351\"><code class=\"language-text\">commitLifeCycles</code></a>如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitLifeCycles</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token operator\">...</span>\n          instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">,</span> prevState<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>你也可以看到，这个方法也是 React 给第一次渲染的组件调用<code class=\"language-text\">componentDidMount</code>的地方。</p>\n<p>以上，就是这些了。</p>","fields":{"postName":"深入了解React中state和props的更新"}}},{"node":{"id":"9e7b48b2-2540-5dbc-905d-3bceebbf8510","frontmatter":{"title":"React16.xRoadmap","date":"2018-12-16","description":"此文翻译自React官方博客:https://reactjs.org/blog/2018/11/27/react-16-roadmap.html。在博客中，作者讲述了React16之后的发展路线"},"html":"<p>你可能已经在之前的博客和视频中听说过有关于“Hook”、“Suspense”、“Concurrent Rendering”这些功能。在这篇博客中，我们将关注这些功能如何整合在一起以及在 React 的未来版本中这些功能达到可使用程度的时间线。</p>\n<hr>\n<h4>tl;dr</h4>\n<p>我们计划把 React 的新功能拆分为以下几个里程碑：</p>\n<ul>\n<li>React16.6 推出 “代码拆分的 Suspense”</li>\n<li>16.x 的某个小版本发布 React Hooks（到 2019 年第一季度）</li>\n<li>16.x 的某个小版本发布并发模式</li>\n<li>16.x 的某个小版本发布“数据获取的 Suspense”</li>\n</ul>\n<p>（这篇博客的原来版本用的是精确的版本号，但是被改为现在的样子，来反应，在这些版本之间可能需要一些其他小版本的积累来达到这一一个版本）</p>\n<p>上面只是预估，详细情况可能会随着时间的流逝而有所变化。在 2019 年我们计划至少有两个项目，他们需要更多探索，还没有具体的发布计划：</p>\n<ul>\n<li>Modernizing React DOM</li>\n<li>Suspense for Server Rendering</li>\n</ul>\n<p>我们期待在接下来的几个月中对于这些项目的时间线有进一步的确定。</p>\n<hr>\n<h4>发布时间线</h4>\n<p>我们会有一个单独的版本来把这些功能整合到一起，但是我们会在每个功能已经准备好的情况下进行发布，这样你就可以尽快使用它们。单独看某个功能，API 的设计可能看不出什么，这篇博客会展示我们计划的主要部分，来帮助你有一个整体的把握。</p>\n<p>逐步发布的策略有助于我们重新定义 API，但是，在过渡时期，某个没有完全完善的功能可能会造成部分疑惑。让我们来看看这些不同的功能对你的 App 来说有什么意义，他们是如何互相关联的，以及你可以在什么时候学习并使用它们。</p>\n<h5>React16.6（已发布）：代码拆分的 Suspense</h5>\n<p><em>Suspense</em>指的是 React 的新功能，当组件在等待某些内容时，它能够暂停渲染，并展示一个加载指示器。在 React16.6 中，Suspense 只支持一种用户场景：使用<code class=\"language-text\">React.lazy()</code>和<code class=\"language-text\">&lt;React.Suspense&gt;</code>进行组件的懒加载。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// This component is loaded dynamically</span>\n<span class=\"token keyword\">const</span> OtherComponent <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./OtherComponent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>React.Suspense</span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Spinner</span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OtherComponent</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>React.Suspense</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用<code class=\"language-text\">React.lazy()</code>和<code class=\"language-text\">&lt;React.Suspense&gt;</code>进行代码拆分在  <a href=\"https://reactjs.org/docs/code-splitting.html#reactlazy\">代码拆分指南</a>中有所描述，你也可以在 <a href=\"https://medium.com/@pomber/lazy-loading-and-preloading-components-in-react-16-6-804de091c82d\">这篇文章</a> 中知道其他实际解释。</p>\n<p>代码拆分是 Suspense 的第一步。对 Suspense 的长期计划也包括让它来处理数据获取的问题（与 Apollo 类似的库进行整合）。除了提供一个更加方面的编程模式外，Suspense 还在并发模式中提供更好的用户体验，在下面的有关话题中我们会提到更多内容。</p>\n<p><strong>在 React DOM 中的状态</strong>：React16.6.0 及更高版本可用</p>\n<p><strong>在 React DOM Server 中的状态</strong>：在服务器渲染中，Suspense 暂时不可用。我们已经开始在研究新的异步服务端渲染，它包含对 Suspense 的支持。但那是一个大计划，得到 2019 年才能完成。</p>\n<p><strong>在 React Native 中的状态</strong>：打包的拆分在 React Native 中并没有很大作用，但是在技术上，当给模块一个 promise 时，没有什么能够阻止<code class=\"language-text\">Reacct.lazy</code>和<code class=\"language-text\">&lt;Suspense&gt;</code>起作用。</p>\n<p><strong>建议</strong>：如果你进行客户端渲染，我们推荐你广泛使用<code class=\"language-text\">Reacct.lazy</code>和<code class=\"language-text\">&lt;Suspense&gt;</code>进行代码拆分。如果你进行服务端渲染，则你不得不等到新的服务端渲染完成后才可以采用。</p>\n<h5>React 16.x（到 2019 年第一季度）：Hooks</h5>\n<p><em>Hooks</em>让你可以在函数组件中使用 state 和生命周期等功能。他们也让你在不增加额外套嵌的情况下在组件间复用状态逻辑。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Example</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Declare a new state variable, which we'll call \"count\"</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">You clicked </span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> times</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Click me</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>自 11 月份开始已经在 Facebook 内部开始使用 Hooks。Hooks 在 React16.7 的 alpha 版本中可用。他们的 API 距离最终确定时可能会有些变化。</p>\n<p>Hooks 代表了我们对未来 React 的预期。它既直接解决了 React 的用户体验问题（再渲染属性时的“层层包裹地狱”和高阶组件，生命周期方法的逻辑复用），也解决了我们在优化 Reac 时遇到的问题（比如说使用编译器内敛组件的困难）。Hooks 没有使类失效。但是，如果 Hooks 发展顺利，在未来的某个大版本中，我们可能会把对类的支持单独拆分到一个包中，以保持 React 默认包的精简。</p>\n<p><strong>在 React DOM 中的状态</strong>：支持 Hooks 的第一个<code class=\"language-text\">react</code>和<code class=\"language-text\">react-dom</code>版本是<code class=\"language-text\">16.7.0-alpha.0</code>。我们预计在接下来几个月中会发更多的 alpha 版本。你可以通过安装<code class=\"language-text\">react@next</code>和<code class=\"language-text\">react-dom@next</code>来试用他们。别忘记升级你的<code class=\"language-text\">react-dom</code>，不然 Hooks 不会生效。</p>\n<p><strong>在 React DOM Server 中的状态</strong>：同样的 16.7 alpha 版本的<code class=\"language-text\">react-dom</code>和<code class=\"language-text\">react-dom/server</code>有对 Hooks 的全面支持。</p>\n<p><strong>在 React Native 中的状态</strong>：暂时没有官方方法在 React Native 中使用 Hooks。如果你敢于冒险，可以采用<a href=\"https://github.com/facebook/react-native/issues/21967\">这篇</a>中提到的非官方方法。里面有一个已知待解决的问题是，<code class=\"language-text\">useEffect</code>触发过晚。</p>\n<p><strong>建议</strong>：如果你已经准备好了，我们推荐你在你写的组件中试用 Hooks。确认你团队中的每个人都赞同使用它们并且对熟悉文档。我们不推荐用 Hooks 重写现在已有的组件，除非你不管怎样都准备重写它们（例如为了修 bug 重写）。在<a href=\"https://reactjs.org/docs/hooks-faq.html#adoption-strategy\">这里</a>阅读更多使用策略。</p>\n<h5>React 16.x（到 2019 年第二季度）：并发模式</h5>\n<p><em>并发模式</em>，通过在不阻塞主进程的情况下渲染组件树，使得 React 应用变得更加具有适应性。它允许 React 打断一个耗时常的渲染（比如渲染一个新的流）来处理一些高优先级的事务（比如文本输入或鼠标悬浮）。并发模式也通过在快速连接时略过不需要的状态加载来提供 Suspense 的用户体验。</p>\n<blockquote>\n<p>注意：你可能在之前，听到过被称为“异步模式”的并发模式。我们已经把名字改为并发模式，来强调 React 根据不同优先级来执行任务的能力。这使它和其他异步渲染的方法能够区分开来。</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Two ways to opt in:</span>\n\n<span class=\"token comment\">// 1. Part of an app (not final API)</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>React.unstable_ConcurrentMode</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Something</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>React.unstable_ConcurrentMode</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 2. Whole app (not final API)</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">unstable_createRoot</span><span class=\"token punctuation\">(</span>domNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>App</span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>暂时没有与并发模式有关的文档。必须要注意的是概念模型在一开始的时候可能会让人觉得不习惯。阐述它的优点、如何使用它以及它的缺点，对于我们来说是高优先级的事情，这也是我们把它称之为稳定的前提条件。在那之前，<a href=\"https://www.youtube.com/watch?v=ByBPyMBTzM0\">Andrew 的演讲</a>是现有的最好的介绍材料。</p>\n<p>并发模式相对于 Hooks 来说还没有经过那么多润色。有些 API 还没有确定，它们也没有按照我们的预期起作用。截止写这篇博客，我们不推荐你使用它，除非是在一些特别早期的实验中使用。在并发模式中，我们预计它没有特别多的 bug，但是需要注意的是，在<code class=\"language-text\">&lt;React.StrictMode&gt;</code>中产生警告的组件可能不会正常工作。另外一个需要注意的是，我们有时候会把一些在其他代码中产生的性能问题错误的归因到并发模式上。比如说，一个随便防止的<code class=\"language-text\">setInterval(fn,1)</code>调用在并发模式中会有糟糕的影响。在发布文档中，我们计划发布更多有关确认及修复这类问题的指引。</p>\n<p>在我们对 React 的预期中，并发模式是非常大的一个组成部分。对于 CPU 充足的情况下，它能够进行无阻塞渲染，在渲染复杂组件树的同时保持应用的响应。这在我们的<a href=\"https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html\">JSConf Iceland talk</a>的第一部分有所演示。并发模式也使得 Suspense 表现得更好。它能够防止，在网速足够快的情况下，出现加载指示器一闪而过的情况。在没有亲眼见到的情况下，这很难解释，<a href=\"https://www.youtube.com/watch?v=ByBPyMBTzM0\">Andrew 的演讲</a>是很好的材料。并发模式依赖于主进程调度器，我们与 Chrome 团队合作，最终把这个功能移入到浏览器本身中。</p>\n<p><strong>在 React DOM 中的状态</strong>：在 React16.6 中，有一个带<code class=\"language-text\">unstable_</code>前缀的不稳定并发模式可以使用，但是我们不推荐你使用它，除非你愿意经常遇到问题或者错误一些功能。16.7 的 alpha 版本包含了不使用<code class=\"language-text\">unstable_</code>前缀的<code class=\"language-text\">React.ConcurrentMode</code>和<code class=\"language-text\">ReactDOM.createRoot</code>，但是在 16.7 中我们大概率会保留前缀，在未来的小版本中才把并发模式成为是稳定的。</p>\n<p><strong>在 React DOM Server 中的状态</strong>：并发模式不直接影响服务端渲染，它会在现有的服务端渲染模式下运行。</p>\n<p><strong>在 React Native 中的状态</strong>：现有计划是，先推迟并发模式在 React Native 中的实现，直到<a href=\"https://github.com/react-native-community/discussions-and-proposals/issues/4\">React Fabric</a>计划接近完成。</p>\n<p><strong>建议</strong>：如果你希望在未来使用并发模式，记得把一些组件子树包裹在<code class=\"language-text\">&lt;React.StrictMode&gt;</code>并处理这导致的警告，这是比较好的第一步。一般来说，不要期望老的代码鞥能够立马能够得到兼容。比如，在 Facebook，我们一般会计划在最近的代码库中使用并发模式，在近期的未来中，保持老的代码库依旧使用同步模式。</p>\n<h5>React16.x（到 2019 年中）：数据获取的 Suspense</h5>\n<p>上面提到过，<em>Suspense</em>指的是当组件在等待某些内容是，React 暂停渲染，并展示一个加载指示器的能力。在已经发布的 React16.6 中，Suspense 唯一支持的用户场景是在代码拆分中。在未来的某个小版本中，我们也会提供官方支持，来通过它进行数据获取。我们会提供一个与 Suspense 兼容的、基础“React 缓存”的指导实现，但是你也可以自行撰写。数据获取的库，比如 Apollo 和 Relay 将来可以与 Suspense 进行集成，我们会发布一个简单的集成指引。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// React Cache for simple data fetching (not final API)</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> unstable_createResource <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react-cache\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Tell React Cache how to fetch your data</span>\n<span class=\"token keyword\">const</span> TodoResource <span class=\"token operator\">=</span> <span class=\"token function\">unstable_createResource</span><span class=\"token punctuation\">(</span>fetchTodo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Suspends until the data is in the cache</span>\n  <span class=\"token keyword\">const</span> todo <span class=\"token operator\">=</span> TodoResource<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>todo<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// Same Suspense component you already use for code splitting</span>\n    <span class=\"token comment\">// would be able to handle data fetching too.</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>React.Suspense</span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Spinner</span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* Siblings fetch in parallel */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Todo</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Todo</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>React.Suspense</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Other libraries like Apollo and Relay can also</span>\n<span class=\"token comment\">// provide Suspense integrations with similar APIs.</span></code></pre></div>\n<p>针对如何使用 Suspense 获取数据，暂时没有官方文档，但是你能够在<a href=\"https://youtu.be/ByBPyMBTzM0?t=1312\">这个 talk</a>和<a href=\"https://github.com/facebook/react/tree/master/fixtures/unstable-async/suspense\">这个小 demo</a>。我们会在接近这次发布的时候写文档，阐述 React Cache 和如何使用你自己写的 Suspense 兼容库。如果你比较好奇，可以在<a href=\"https://github.com/facebook/react/blob/master/packages/react-cache/src/ReactCache.js\">这里</a>看早先的源码。</p>\n<p>低阶 Suspense 机制（暂停渲染和这暂时反馈）预计在 React16.6 版本中稳定。我们已经把他们用在代码拆分中用了几个月。然而，数据获取的高阶 API 还不稳定。React Cache 还在快速变化中，并且还会变动很多次。也有一些低阶 API，他们缺少一些比较好的高阶 API，这使得它们无法被实现。我们不推荐在任何地方使用 React Cache，除了一些非常早起的实验中。注意，React Cache 自身并没有与 React 发布强绑定，但是现有的 alpha 版本缺少基础功能，比如缓存验证，你会遇到一些麻烦。我们计划在这个 React 版本中，达到一些可使用的点。</p>\n<p>在最终，我们希望所有的数据获取都通过 Suspense 来实现，但这个还需要很长时间，直到所有的集成项都完成。在实践中，我们期望它能够被增量式采用，通过类似于 Apollo 或者 Relay 这类中间层来实现，而不是直接使用。缺少高阶 API 并不是我们遇到的唯一麻烦——这也有些重要的 UI 模式暂时也不支持，比如在加载视图层级外展示进度展示器。跟之前一样，我们也会在这篇博客中交流我们的进度。</p>\n<p><strong>在 React DOM 中的状态</strong>：技术上说，一个兼容的缓存在 React16.6 中已经可以配合<code class=\"language-text\">&lt;React.Suspense&gt;</code>进行工作了。然而，知道这个小版本发布，我们预计都不会有一个好的缓存实现。如果你敢于冒险，你可以通过查看 React Cache alphas 版本来实现自己的缓存。然而，需要注意的是，在有正式文档前，模型有极大概率被误解。</p>\n<p><strong>在 React DOM Server 中的状态</strong>：Suspense 在服务端渲染中暂时不可用。就像之前提到的一样，我们已经开始研究一个新的异步服务端渲染，它会支持 Suspense，但是那是一个非常大的项目，会占用 2019 非常大块的时间来完成。</p>\n<p><strong>建议</strong>：到这个小版本发布再来使用 Suspense 进行数据获取。不用使用 16.6 中的 Suspense 功能来实现它，现在还不支持。然而，当数据获取的 Suspense 被官方支持后，你已存的用于代码拆分的<code class=\"language-text\">&lt;Suspense&gt;</code>组件还是能够展示加载状态的。</p>\n<hr>\n<h4>其他项目</h4>\n<h5>现代化 React DOM</h5>\n<p>我们已经开始调查<a href=\"https://github.com/facebook/react/issues/13525\">简化和现代化</a>ReactDOM，目标是缩减包的大小并与浏览器行为靠齐。现在说哪些点能够做到达到目的还为时尚早，项目现在还处于探索阶段。我们会在上面的 issue 中交流进度。</p>\n<h5>服务端渲染的 Suspense</h5>\n<p>我们已经开始设计一种支持 Suspense（包括等待服务端异步数据时无重复渲染）、支持渐进式加载、支持在 chunks 中 hydrante 页面内容的新的服务端渲染，以达到更好的用户体验。你能够在<a href=\"https://www.youtube.com/watch?v=z-6JC0_cOns\">这个 talk</a> 中看到早期原型。新的服务端渲染会成为我们 2019 年的主要关注点，但是现在说它的发布计划还为时尚早。它的开发，依然会在往常一样<a href=\"https://github.com/facebook/react/pulls?utf8=%E2%9C%93&#x26;q=is%3Apr+is%3Aopen+fizz\">在 GitHub 上进行</a>。</p>\n<hr>\n<p>就是这些了。正如你看到的，这还有很多事情要做，但是我们期待在接下来的几个月中看到更多进步。</p>\n<p>我们希望这篇博客能够让你了解我们正在做什么，你现在可以使用什么以及你能够期待未来能够使用什么。在社交媒体上有很多关于新功能的讨论，如果你读了这篇博客，那你就不会错过重要的点了。</p>\n<p>我们期待收到反馈，期待在 <a href=\"https://github.com/reactjs/rfcs\">RFC 仓库</a>、<a href=\"https://github.com/facebook/react/issues\">issue 跟踪</a>或者 <a href=\"https://mobile.twitter.com/reactjs\">Twitter</a>上获得你的来信。</p>","fields":{"postName":"4-React16.xRoadmap"}}},{"node":{"id":"313ed214-8ceb-58d6-863b-9041c11dfd62","frontmatter":{"title":"React事件处理","date":"2018-12-15","description":"总结自React官方文档，React类组件及函数组件中事件处理"},"html":"<ul>\n<li>React 的事件采用的是驼峰式的写法，而不是统一小写</li>\n<li>事件处理必须传递函数引用或函数字面量</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>activateLasers<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Activate Lasers</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>不能通过返回 false 来阻止事件的默认行为，只能通过显性调用 preventDefault 进行</li>\n</ul>\n<hr>\n<h4>es6 类组件中的事件绑定</h4>\n<h5>写法</h5>\n<ul>\n<li>第一种：使用 es6 class 语法时，如果将类的方法作为事件处理函数，则需要进行 this 绑定。原因：在<code class=\"language-text\">onClick={this.handleClick}</code>中 this.handle 引用正确，于是会变成<code class=\"language-text\">onClick={function(){this.setState({ isRed: !this.state.isRed })}}</code>，所以会出现在这个方法中 this 为 undefined，于是报错。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//进行 this 绑定</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//ES6 的写法，在类中申明方法，它是一种简写形式：</span>\n  <span class=\"token comment\">// handleClick: function(){}</span>\n  <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>welcome<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> background<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token operator\">?</span> <span class=\"token string\">\"red\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Welcome to this websit.\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">change color</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>第二种</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//另一种写法，利用箭头函数，解决 this 绑定的问题，将上面的 this，直接绑定到调用 this.handleClick 的 this，即组件，从而解决了调用绑定的问题。</span>\n  <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>welcome<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> background<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token operator\">?</span> <span class=\"token string\">\"red\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Welcome to this websit.\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">change color</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>第三种，在回调中利用箭头函数。注意，在这种写法中，如果回调是作为 props 传递进来的，组件可能会进行额外的渲染。所以比较推荐的是在构造函数中进行绑定或者利用 👆 的方法来写。</li>\n</ul>\n<h5>传参</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>welcome<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> background<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token operator\">?</span> <span class=\"token string\">\"red\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Welcome to this websit.\n        </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* 利用箭头函数解决绑定问题，注意这里 handleClick 后面要加括号。() => this.handleClick()是一整个函数字面量 *，使用这种写法有个缺点，就是如果这是一个要传递给子组件的属性，则在每次渲染时会重新生成一个函数，子组件会认为属性变更了，从而导致子组件重新渲染，所以这种方式不太推荐 */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">change color</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>第一种写法，通过 this 绑定后传参</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>welcome<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> background<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token operator\">?</span> <span class=\"token string\">\"red\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Welcome to this websit.\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          change color\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>第三种写法，箭头函数的传参</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>welcome<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> background<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token operator\">?</span> <span class=\"token string\">\"red\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Welcome to this websit.\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>e <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          change color\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>第二种写法，特殊写法的传参</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> id <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> isRed<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span>\n        <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>welcome<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> background<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>isRed <span class=\"token operator\">?</span> <span class=\"token string\">\"red\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        Welcome to this websit.\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          change color\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h4>函数组件中的事件绑定</h4>\n<ul>\n<li>基本写法。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Add</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> add <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> input<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handeClick</span> <span class=\"token operator\">=</span> input <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>input<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    input<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>add-container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>node <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>input <span class=\"token operator\">=</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">handeClick</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Add</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>可以将 handleClick 进行改写，改为比较原始的函数申明写法，不过不推荐。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Add</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> add <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> input<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//改为函数声明的写法</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">handeClick</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>input<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    input<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>add-container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>node <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>input <span class=\"token operator\">=</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* 由于需要传递 input，无法直接写成 onClick={handeClick(input)} */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">handeClick</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Add</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>如上例子中，由于需要传递 input，所以无法直接写成传递字面量的形式，如果不需要传递，则可以直接写引用，如下。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">1111</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","fields":{"postName":"3-React事件处理"}}},{"node":{"id":"dd6fdce4-e515-5772-8c0b-66dacc6a4236","frontmatter":{"title":"JSX、元素和组件","date":"2018-12-02","description":"总结自React 官方文档：https://reactjs.org/docs。摘录部分有关 JSX、元素和组件容易会被忽略的点"},"html":"<h4>有关 JSX</h4>\n<h5>JSX用作表达式</h5>\n<ul>\n<li>jsx 是JavaScript 表达式，所以它可以被用在 JavaScript 语句中，被赋值、接受参数传值以及作为函数返回值</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getGreeting</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Hello<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token function\">formatName</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Hello<span class=\"token punctuation\">,</span> Stranger<span class=\"token punctuation\">.</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h5>给 jsx 属性赋值</h5>\n<ul>\n<li>使用双引号给属性赋予常数值</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>div tabIndex<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>使用大括号给属性赋予JavaScript 表达式值</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>img src<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>user<span class=\"token punctuation\">.</span>avatarUrl<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>img<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>jsx中的属性采用驼峰式的写法，如 className、tabIndex</li>\n</ul>\n<h5>jsx 防止注入攻击</h5>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> title <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>potentiallyMaliciousInput<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// This is safe:</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>title<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>使用大括号时，React 会把所有插入的值都转为字符串后再进行渲染，从而避免XSS攻击</li>\n</ul>\n<h5>jsx 的编译</h5>\n<ul>\n<li>Babel 会调用 React.createElement 方法来编译 JSX</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>h1 className<span class=\"token operator\">=</span><span class=\"token string\">\"greeting\"</span><span class=\"token operator\">></span>\n    Hello<span class=\"token punctuation\">,</span> world<span class=\"token operator\">!</span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//相当于</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'h1'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>className<span class=\"token punctuation\">:</span> <span class=\"token string\">'greeting'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'Hello, world!'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//最终会被编译为类似于以下形式：</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token punctuation\">:</span> <span class=\"token string\">'h1'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    className<span class=\"token punctuation\">:</span> <span class=\"token string\">'greeting'</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token punctuation\">:</span> <span class=\"token string\">'Hello, world!'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h4>渲染元素</h4>\n<ul>\n<li>React 组件由 React 元素构成，React 元素都是类似如下的对象。React DOM 会负责将这些对象渲染为实际的 DOM 元素</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token punctuation\">:</span> <span class=\"token string\">'h1'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    className<span class=\"token punctuation\">:</span> <span class=\"token string\">'greeting'</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token punctuation\">:</span> <span class=\"token string\">'Hello, world!'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>调用 <code class=\"language-text\">ReactDOM.render</code>进行渲染</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello, world</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>React 元素都是不可变的。一个元素一旦创建，则其子元素及属性都不可变更。变动 UI 的方式之一就是新创建一个元素并将它渲染至页面中。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello, world!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">It is </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLocaleTimeString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">.</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span>tick<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>在元素变更后的重新渲染时，React 只会渲染变更后的内容，未变更的内容不会重复渲染。如上面例子中，虽然每秒钟都会创建一个新元素，但是 ReactDOM 在更新时只会渲染h2中变更过的内容。</li>\n</ul>\n<hr>\n<h4>组件</h4>\n<h5>函数组件和类组件</h5>\n<ul>\n<li>函数组件接受唯一一个对象参数（props 对象），返回一个 React 元素</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Welcome</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Hello<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>类组件</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Welcome</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Hello<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h5>组件大写</h5>\n<ul>\n<li>React 会把小写字母开头的元素当做DOM标签，把大写字母开头的才作为组件</li>\n</ul>\n<h5>props 是只读的</h5>\n<ul>\n<li>所有的 react 组件都必须表现得像纯函数。</li>\n</ul>","fields":{"postName":"2-jsx、元素和组件"}}},{"node":{"id":"9f9d3be4-0be7-5638-837b-7e60d8077af3","frontmatter":{"title":"不打包的情况下使用React","date":"2018-12-01","description":"总结自React官方文档：https://reactjs.org/docs/add-react-to-a-website.html，如何在不用webpack等打包工具的情况下使用React"},"html":"<h5>不使用 JSX</h5>\n<p>直接在页面中以 script 的方式引用react和 react-dom 的 CND 代码</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/react@16/umd/react.development.js<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crossorigin</span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/react-dom@16/umd/react-dom.development.js<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crossorigin</span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>此时，无法解析 JSX，故需要使用 React.createElement 的方式来创建组件，具体示例可见：<a href=\"https://gist.github.com/gaearon/6668a1f6986742109c00a581ce704605\">https://gist.github.com/gaearon/6668a1f6986742109c00a581ce704605</a></p>\n<hr>\n<h5>直接在页面中使用 JSX</h5>\n<p>在页面上引用 babel的包代码</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/babel-standalone@6/babel.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>在 html页面的 JS 代码中将 script 的 type 置为 <code class=\"language-text\">type=&quot;text/babel&quot;</code>，JS 代码写在这个特殊 script 中</p>\n<p>在这种方式下：</p>\n<p>1、此时无法通过这个 script 引用外部 JS 文件，因为设置 type 后这个 script 已经不是一个作用为引用 JS 的script 标签了</p>\n<p>2、JSX 的编译发生在浏览器中，所以页面加载速度慢，所以它不适合用在生产环境中</p>\n<hr>\n<h5>实时编译 JSX</h5>\n<p>安装 babel-cli@6 和 babel-preset-react-app@3，通过 babel --watch 的功能进行实时编译，将文件编译为浏览器可以直接执行的文件，html 中直接引用编译后的文件</p>","fields":{"postName":"1-不打包的情况下使用React"}}}]}},"pageContext":{}}