{"data":{"allMarkdownRemark":{"edges":[{"node":{"id":"8ca7c676-a6c7-560a-93ac-3b09fae7fa42","frontmatter":{"title":"浏览器内部：事件循环","date":"2019-05-27","description":"介绍浏览器事件循环，包括调用栈、webapi、事件队列、macrotask与microtask等"},"html":"<p>浏览器中，整个JavaScript的运行环境，在Render进程中。帮助JavaScript运行起来的主要线程包括：</p>\n<ul>\n<li>JavaScript 引擎线程</li>\n<li>事件触发线程</li>\n<li>定时器线程</li>\n<li>异步http线程</li>\n</ul>\n<p>先说明一下浏览器中JavaScript事件循环的整体流程，再来看各个线程在其中起的作用。</p>\n<hr>\n<h4>浏览器事件循环</h4>\n<p>浏览器事件循环的总体流程如下：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec4678143310d56afe5fe10178291c84/de852/JavaScript%20event%20loop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 531px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.802259887005654%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQoz12TCw6CQAxEuf/RuIAhYADByB/koyBgzWtSgzZptrs7nU674AzDIH3fS9u2Ute1zPMsy7LoavHz+ZR1XWWaJrndbpKmqZ69Xi91cNw3TSMOmzzP1QFv2yb/RhLn+75r4ev1Kvf7XYs9Ho8vbhxHcQBjgFBqhtowDL+EqIMUnOu64vu+YhBiRrcOJFShMlU5pBIxLUBEXBSFtlWWpXiepys48n4IOSCR1rGu6/TCjLYgY2YYY4HQBJD7QwgBKlBq63EuqKI12rb4crmoOsMzivf7rQWUkA1gHAAXKEYVVU0xag1HDBZi9vba35ZNFcm0CCkJxMfH+n99e1QzVcghlYhZeTmGXlWVJEmibjM+GiJstnxSKFWFx1YgzbJMh07MIxCTzMyCIJDz+SxxHMvpdNIYAWDpxAFEFdz+DpK5xBkBd8wZ9ajlW8SjKNK/hk5s9h/EHU8hhsIx7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"JavaScript event loop\"\n        title=\"\"\n        src=\"/static/ec4678143310d56afe5fe10178291c84/de852/JavaScript%20event%20loop.png\"\n        srcset=\"/static/ec4678143310d56afe5fe10178291c84/da694/JavaScript%20event%20loop.png 138w,\n/static/ec4678143310d56afe5fe10178291c84/b49ee/JavaScript%20event%20loop.png 275w,\n/static/ec4678143310d56afe5fe10178291c84/de852/JavaScript%20event%20loop.png 531w\"\n        sizes=\"(max-width: 531px) 100vw, 531px\"\n      />\n  </span>\n  </a></p>\n<p>各组成部分：</p>\n<ul>\n<li>JavaScript引擎，进行JavaScript的解析与执行，所有JavaScript代码的执行全部在JavaScript引擎中</li>\n<li>WebApis。由浏览器提供的api，执行例如DOM事件、Ajax请求、定时器等任务。其中包括定时器线程、异步http线程等webapi对应的线程，他们负责进行进行对应的api调用，而且不属于JavaScript引擎。</li>\n<li>事件循环队列。维护回调事件组成的队列</li>\n</ul>\n<p>整体流程：</p>\n<ul>\n<li>JavaScript引擎根据调用栈中的函数调用，依次执行JavaScript代码。其中，若调用有调用Webapi，则对相应Api进行调用，注册对应api调用与回调事件。如代码为<code class=\"language-text\">setTimeout(()=&gt;console.log(&quot;here&quot;),100)</code>，则调用定时器。</li>\n<li>Webapi执行对应调用，当执行完成后，将回调函数传递给事件循环队列。事件循环队列接受回调后，将此回调放在事件循环队列最后。比如上述的<code class=\"language-text\">setTimeout</code>定义了100ms的定时，则定时器开始计时，到100ms时，将回调<code class=\"language-text\">()=&gt;console.log(&quot;here&quot;)</code>传递给事件循环队列。</li>\n<li>当调用栈为空时，JavaScript从事件循环队列开头去除回调函数，放入调用栈中，执行回调。</li>\n</ul>\n<hr>\n<h4>JavaScript引擎</h4>\n<p>如上图所示，JavaScript引擎中主要包括两大部分：</p>\n<ul>\n<li>内存堆，提供程序运行所需内存</li>\n<li>调用栈，维护JavaScript程序调用栈</li>\n</ul>\n<p>JavaScript是单线程的，而这个单线程，也就是说在JavaScript引擎中，在一个特定时间，JavaScript只能执行一个任务，一行代码，不能同时执行多项任务。代码的执行顺序，则严格按照调用栈的程序调用顺序。</p>\n<h5>调用栈</h5>\n<p>调用栈维护的程序调用及返回顺序，调用栈是一个先进后出的栈结构。</p>\n<ul>\n<li>每次对函数的调用，将会把此函数压入栈底</li>\n<li>每次函数返回，则将函数从栈顶释放</li>\n</ul>\n<p>比如以下代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">c</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">c</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>代码执行即对应调用栈为：</p>\n<ul>\n<li>开始执行代码，调用栈为 main </li>\n<li>执行a。调用栈：main —> a</li>\n<li>函数a执行，执行<code class=\"language-text\">console.log(&quot;a&quot;)</code>。调用栈：main —> a —> console.log</li>\n<li><code class=\"language-text\">console.log</code>执行，打印<code class=\"language-text\">a</code>，然后退出<code class=\"language-text\">console.log</code>，调用栈变为 main —> a</li>\n<li>执行<code class=\"language-text\">b()</code>，调用b函数，进入函数b中，调用栈变为 main —> a —> b</li>\n<li>然后执行<code class=\"language-text\">console.log</code>，调用栈变为 main —> a —> b —> console.log</li>\n<li><code class=\"language-text\">console.log</code>执行完毕，调用栈变为 main —> a —> b</li>\n<li>然后调用c，进入c函数，调用栈变为 main —> a —> b —> c</li>\n<li>执行 <code class=\"language-text\">console.log</code>，调用栈变为 main —> a —> b —> c —> console.log</li>\n<li><code class=\"language-text\">console.log</code>执行完毕，调用栈变为 main —> a —> b —> c</li>\n<li>从c函数退出，回到b函数，调用栈变为main —> a —> b</li>\n<li>从b函数退出，调用栈变为main —> a </li>\n<li>从a函数退出，调用栈变为 main</li>\n<li>代码执行完毕，调用栈变为空</li>\n</ul>\n<h5>调用循环队列</h5>\n<p>JavaScript引擎会按照代码从上往下进行调用执行</p>\n<ul>\n<li>执行流程形成调用栈</li>\n<li>执行过程中，若需要对webapi进行调用，则调用webapi</li>\n<li>当代码执行完毕调用栈为空时，便开始执行事件循环队列中的回调</li>\n<li>每次从事件循环队列的头部获取一个回调，执行此回调时，依然形成对此回调执行的调用栈</li>\n<li>当上一个回调执行结束，调用栈回到空状态，则从事件循环队列获取一下一个回调，并进行执行</li>\n<li>循环上述流程，直到将所有回调全部执行完毕</li>\n</ul>\n<hr>\n<h4>webApi与事件循环队列</h4>\n<p>webApis中包含各种浏览器Api调用，比如</p>\n<ul>\n<li>DOM api，根据JavaScript，注册各类事件，比如点击事件，注册后，若用户进行点击，则将点击事件回调传递给事件循环队列</li>\n<li>定时器，若JavaScript执行<code class=\"language-text\">setTimeout</code>或<code class=\"language-text\">setInterval</code>，则向定时器注册定时任务，定时器将进行计时，达到执行事件后，将定时器回调传递给事件循环队列</li>\n<li>http事件同理，进行http请求，请求结束后，将请求回调及请求数据传递给事件循环队列</li>\n</ul>\n<p>事件循环队列每次收到webApi传递来的回调事件及回调数据，则将回调事件及数据放在队列最后，当 JavaScript 调用栈为空时，从循环队列开头，依次将一个个回调事件及数据传递给JavaScript引擎进行执行。</p>\n<hr>\n<h4>异步代码执行流程</h4>\n<p>综合上述内容，若代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"timeout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>执行流程为：</p>\n<ul>\n<li>调用<code class=\"language-text\">console.log</code>，调用栈变为 main —> console.log ，<code class=\"language-text\">console.log</code>执行完毕后，调用栈回到 main</li>\n<li>执行<code class=\"language-text\">setTimeout</code>，调用webapi的定时器，将回调函数传递给定时器，由于设置的超时时间为0，定时器此时会立马把回调传递给时间循环队列，时间循环队列将回调放入队列中</li>\n<li>此时JavaScript执行扔在主代码序列中，调用栈为 main 。继续往下，进入 <code class=\"language-text\">console.log(&quot;b&quot;)</code>，执行<code class=\"language-text\">console</code>，调用栈变为 main —> console，<code class=\"language-text\">console.log(&quot;b&quot;)</code>调用结束，调用栈回到 main</li>\n<li><code class=\"language-text\">console.log(&quot;b&quot;)</code>执行完毕后，主代码序列全部执行完毕，调用栈变为空</li>\n<li>此时，开始从循环队列中取出回调进行执行，于是，取出<code class=\"language-text\">()=&gt;console.log(&quot;timeout&quot;)</code>，进行执行，从代码开始执行到执行完毕，调用栈先变为 console.log，后变为空</li>\n</ul>\n<hr>\n<h4>macrotask &#x26; microtask</h4>\n<p>在上面的讲述中，事件循环队列只是一个队列，然而实际上，并不是只有一个队列。然而，事实上应该有两个主要的执行队列。</p>\n<ul>\n<li>\n<p>macrotask</p>\n<ul>\n<li>宏任务，也被称为task，从概念上来说，可以看做是一个执行主体。在执行时，是一个task接着一个task，依次进行执行的。</li>\n<li>被认为是宏任务的内容包括：setTimeout、setInterval、I/O</li>\n</ul>\n</li>\n<li>\n<p>microtask</p>\n<ul>\n<li>微任务。会尽快被执行的任务，包括：原生promise、process.nextTick(Node中)</li>\n</ul>\n</li>\n</ul>\n<h5>执行流程</h5>\n<p>macrotask、microtask、UI渲染，三者，在某个时刻，只能有一个在执行，它们的执行流程为：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/51d427aca96a32ca17615dca9aa916e7/10478/macrotask%26microtask.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 361px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.90858725761773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABB0lEQVQoz42S5wqEQAyE9/0fz38i9oIFe685JrCHLqdnIC4GnZ18iaiqijzPoyzLKM9zSpKE1nXlPI7jmwh5PoXAwzAM6vueCxDsuo6Korh8+FZcwGHbtlTXNTvEO8K2bSrLkrZto2VZLsKPgvu+0zl93yfTNPmUGUURdzAMw8XtL2GhthWGIbsLgoBPy7KYL5iiC4nmDoNQC03T8E/gKBOC8zxTHMfkOA6N48iYVDMXh3dMUIczCKN113WZLXjjEuTZqVBBqwmumDhEwRMbAcdIuQ3njRB3+3RGIRFM08SOMBwpmKYp6brOdQiLf4t6h0JeAJYQxzBfO1QxIDAgIABTONQ0jWsfALVZTWKpmCQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"macrotaskµtask\"\n        title=\"\"\n        src=\"/static/51d427aca96a32ca17615dca9aa916e7/10478/macrotask%26microtask.png\"\n        srcset=\"/static/51d427aca96a32ca17615dca9aa916e7/c4105/macrotask%26microtask.png 138w,\n/static/51d427aca96a32ca17615dca9aa916e7/ae54d/macrotask%26microtask.png 275w,\n/static/51d427aca96a32ca17615dca9aa916e7/10478/macrotask%26microtask.png 361w\"\n        sizes=\"(max-width: 361px) 100vw, 361px\"\n      />\n  </span>\n  </a></p>\n<ul>\n<li>在执行时，会先取一个task执行</li>\n<li>task执行完毕后，获取执行期间的所有microtask，把所有microtask全部执行完毕</li>\n<li>若JavaScript执行对UI有改变，则执行UI渲染</li>\n<li>UI渲染完成后，进行下一个task的执行</li>\n<li>按照上述步骤循环往复</li>\n</ul>\n<p>所以，以下代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"e\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>执行的打印顺序为<code class=\"language-text\">a - e - c - d - b</code></p>\n<hr>\n<p>参考内容</p>\n<p><a href=\"https://www.youtube.com/watch?v=8aGhZQkoFbQ\">https://www.youtube.com/watch?v=8aGhZQkoFbQ</a></p>\n<p><a href=\"https://www.i-programmer.info/programming/javascript/11337-javascript-async-microtasks.html\">https://www.i-programmer.info/programming/javascript/11337-javascript-async-microtasks.html</a></p>\n<p><a href=\"http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html\">http://www.dailichun.com/2018/01/21/js<em>singlethread</em>eventloop.html</a></p>","fields":{"postName":"/post/浏览器内部：事件循环"}}},{"node":{"id":"0bc7bc48-e64c-5cee-bcb6-6f29236df53e","frontmatter":{"title":"浏览器内部：网页渲染流程","date":"2019-05-24","description":"基于对网页渲染的初步了解，概述网页渲染的整体流程，以及对应可以进行的部分网页优化。"},"html":"<h4>渲染进程中的线程</h4>\n<p>渲染进程的主要任务，是将HTML、CSS和JavaScript变成用户可以与之交互的网页</p>\n<ul>\n<li>GUI渲染线程 — 主线程</li>\n<li>compositor线程</li>\n<li>raster线程</li>\n<li>JavaScript引擎线程</li>\n<li>事件触发线程</li>\n<li>定时器触发线程</li>\n<li>异步http请求线程</li>\n<li>… </li>\n</ul>\n<hr>\n<h4>网页渲染流程</h4>\n<ul>\n<li>\n<p>HTML解析</p>\n<ul>\n<li>接受到HTML后，主线程会将HTML解析为DOM</li>\n<li>在解析HTML的过程中，如果遇到 <code class=\"language-text\">&lt;script&gt;</code>标签，HTML解析需要停止，进行JavaScript的加载、解析与执行。原因是JavaScript可能会使用<code class=\"language-text\">document.write</code>等方法改变DOM结构</li>\n</ul>\n</li>\n<li>样式解析。主线程将CSS解析为样式规则。</li>\n<li>样式封装。当DOM和CSS解析全部完成之后，主线程会根据CSS选择器和样式规则，计算每个元素的样式，这个阶段的结果是渲染树。渲染树包含对应于各个元素的带有各种样式视觉信息(包括颜色、尺寸等)的矩形。</li>\n<li>布局。渲染树构建完毕后，开始进行布局。布局阶段，主线程会计算每个元素在页面应该处于位置的坐标，最终产出布局树。</li>\n<li>绘制顺序。有了布局树后，主线程会遍历布局树，来决定每个元素的绘制顺序。绘制顺序包括：每个元素的绘制顺序，比如设置了z-index的元素，绘制顺序会有所改变；已经元素先背景、再文字的绘制顺序等。</li>\n<li>图层树。主线程会将页面分为各个图层，不同的元素有可能会被分到不同的图层上，为了决定哪个元素应该位于哪个图层上，主线程会遍历布局树，产出图层树。图层树可以通过chrome开发者工具-More tool-Layer进行查看。</li>\n<li>栅格化。图层树和绘制顺序创建完毕后，主线程会把这些信息提交给 compositor线程，compositor线程会把较大的图层分为小块，分别交给 raster线程 进行栅格化。</li>\n<li>最终展示。每个小块被栅格化完成后，compositor线程会收集这些完成栅格化的小块，形成 compositor帧。compositor帧由渲染进程通过IPC交给browser进程，进而交给GPU，最终展示在屏幕上。</li>\n</ul>\n<hr>\n<h4>DOM解析的一些其他问题</h4>\n<h5>预解析</h5>\n<p>预解析，不同于主线程的正式HTML解析，它会专门去找HTML中嵌入的外部资源，包括CSS、图片、JavaScript等，并进行提前加载，以节省时间。</p>\n<p>找到这些内容后，渲染进程会将这些需要加载的内容交给broswer进程中的network线程，让它去发起网络请求，加载这些资源，而渲染进程中的主线程则会同步进行HTML解析</p>\n<h5>预防DOM解析阻塞</h5>\n<p>有一些方法可以避免JavaScript的加载和执行阻塞DOM解析，比如</p>\n<ul>\n<li>\n<p>如果脚本不影响DOM结构，则可以给<code class=\"language-text\">&lt;script&gt;</code>标签加上<code class=\"language-text\">async</code>或<code class=\"language-text\">defer</code>标签，使JavaScript加载变成异步</p>\n<ul>\n<li>加了<code class=\"language-text\">async</code>，则加载 JavaScript 和 DOM解析会同步进行 (JavaScript的加载时由browser进程中network线程进行，不影响DOM解析)。JavaScript加载完毕后，停止DOM解析，进行JavaScript的解析和执行，JavaScript解析和执行完毕后继续进行DOM 解析</li>\n<li>加了<code class=\"language-text\">defer</code>，则加载JavaScript和DOM解析会同步进行，JavaScript加载完毕后会进行等待，DOM全部解析完毕后，才会解析和执行这些JavaScript。浏览器会保证所有加了<code class=\"language-text\">defer</code>属性的脚本，会按照它们的排列顺序从上往下依次执行</li>\n</ul>\n</li>\n<li>如果资源是一定会用到的，可以加上<code class=\"language-text\">rel=preload</code>属性，则可以使页面尽快下载，而不是等到HTML解析到了才开始下载</li>\n</ul>\n<hr>\n<h4>接下来</h4>\n<ul>\n<li>在这里描述的只是网页渲染的一个大纲，后续有深入了解再进行补充，后面参考资料中也有更多相关详情</li>\n<li>由网页渲染流程，可以看到一系列网页优化的方法。从加载资源，到构建DOM、构建CSSOM树等，在后续的了解中再进行一一对应，进行完善。</li>\n</ul>\n<hr>\n<p>参考资料：</p>\n<p><a href=\"https://developers.google.com/web/updates/2018/09/inside-browser-part3\">https://developers.google.com/web/updates/2018/09/inside-browser-part3</a></p>\n<p><a href=\"https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#Speculative_parsing\">https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#Speculative_parsing</a></p>\n<p><a href=\"https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction\">https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction</a></p>\n<p><a href=\"https://blog.sessionstack.com/how-javascript-works-the-rendering-engine-and-tips-to-optimize-its-performance-7b95553baeda\">https://blog.sessionstack.com/how-javascript-works-the-rendering-engine-and-tips-to-optimize-its-performance-7b95553baeda</a></p>","fields":{"postName":"/post/浏览器内部：网页渲染流程"}}},{"node":{"id":"ab0322f9-29b4-5590-a85c-aece0e31f865","frontmatter":{"title":"浏览器内部：浏览器进程","date":"2019-05-19","description":"讲解浏览器内部的主要进程，以及，在渲染网页时进程如何合作来达到渲染目的。"},"html":"<h4>进程概述</h4>\n<p>浏览器的多进程，以chrome为例</p>\n<ul>\n<li>\n<p>Browser进程</p>\n<ul>\n<li>控制chrome的用户界面。所谓的用户界面，指的是浏览器网页窗口上面的部分，包括：地址栏、书签、向前向后按钮等</li>\n<li>负责网络请求、文件访问等不可见的底层服务</li>\n<li>负责各页面管理，创建和销毁其他进程</li>\n</ul>\n</li>\n<li>\n<p>渲染进程</p>\n<ul>\n<li>渲染进程负责页面渲染、脚本处理等内容</li>\n<li>每个tab有一个自己的独立的渲染进程，这么做的好处是：1、如果某个tab崩溃，不会影响其他tab的正常运行；2、隔离每个tab，避免一些跨tab造成的安全问题</li>\n</ul>\n</li>\n<li>\n<p>插件进程</p>\n<ul>\n<li>负责插件处理</li>\n<li>每个插件对应于一个插件进程</li>\n</ul>\n</li>\n<li>\n<p>GPU进程</p>\n<ul>\n<li>负责GPU任务(GPU会负责处理来自各个应用的请求，并且在同一个界面上进行绘制)</li>\n</ul>\n</li>\n<li>\n<p>其他</p>\n<ul>\n<li>比如一些工具进程等</li>\n</ul>\n</li>\n</ul>\n<p>可以在chrome的任务管理器中查看各个进程，其中每一行为一个进程，而且可以看到每个进程 CPU和内存的使用情况</p>\n<hr>\n<h4>进程合作</h4>\n<p>以在chrome地址栏输入网址为例，说明浏览器各进程之前的合作的：</p>\n<ul>\n<li>在chrome地址栏输入网址，<strong>Browser进程</strong>中的<strong>UI线程</strong>获取输入内容，然后分辨这个输入是一个地址还是一个查询字符串，chrome的地址栏既可以直接访问网址也可以进行搜索引擎查询。若是一个地址，则说明接下来需要对此网址进行请求；否则表示应该请求对应搜索引擎</li>\n<li>\n<p><strong>Browser进程</strong>中的<strong>UI线程</strong>展示网络正在请求的指示器，比如loading图标等；<strong>Browser进程</strong>的<strong>network线程</strong>对响应网络进行请求处理，包括DNS查询、建立TCP连接等</p>\n<ul>\n<li>如果此时<strong>network线程</strong>收到一个重定向的服务器返回，则告知<strong>UI线程</strong>进行重定向，展示不同的网址，并对重定向网址进行网络请求</li>\n</ul>\n</li>\n<li>\n<p><strong>network线程</strong>收到服务端返回后，首先查看返回内容的<code class=\"language-text\">Content-Type</code>请求头，以确定返回内容的类型。由于<code class=\"language-text\">Content-Type</code>请求头可能丢失或错误，所以可能会进行<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types\">MIME_types 嗅探</a>。根据<code class=\"language-text\">Content-Type</code>及嗅探结果，确定返回内容的类型后，<strong>Browser进程</strong>会根据内容类型进行不同的处理。</p>\n<ul>\n<li>如果内容是HTML文件，则接下来会会把返回数据交给<strong>Render进程</strong>进行页面渲染如果内容是zip文件或其他文件等，意味着返回内容是待下载内容，则将数据传递给下载管理器</li>\n<li>类型的确定不是等到所有内容都下载完才进行，在收到需要的数据之后便可以进行。下面的几部也都是在接受数据的同时同步进行的。</li>\n</ul>\n</li>\n<li>\n<p>另外，在接收到返回内容后，也会对内容进行跨域等安全检查。如果确定内容没有问题，并且属于对应请求的网址，则<strong>network进程</strong>会告知<strong>UI进程</strong>数据加载结束，<strong>UI进程</strong>则会寻找一个<strong>Render线程</strong>来进行页面渲染</p>\n<ul>\n<li>为了节省时间，在进行网络请求期间，<strong>UI进程</strong>会提前确定好后续进行页面渲染的<strong>Render线程</strong>，当数据加载完毕后，则直接将数据交给之前已经准备好的<strong>Render线程</strong>。</li>\n<li>需要注意的是，如果页面被重定向到了一个对于现在域名跨域的域名，则需要另外一个<strong>Render进程</strong>进行渲染</li>\n</ul>\n</li>\n<li>通过以上步骤，数据在加载中，并且已经有准备好的页面渲染的<strong>Render线程</strong>，则<strong>Browser进程</strong>通过IPC将数据发送给<strong>Render进程</strong>，<strong>Render进程</strong>开始进行网页渲染。</li>\n<li>当<strong>Render进程</strong>结束渲染，执行完所有<code class=\"language-text\">onload</code>事件后，通过IPC告知<strong>Browser进程</strong>，<strong>Browser进程</strong>的<strong>UI线程</strong>展示停止\"加载中\"的指示，显示加载完成。</li>\n</ul>\n<hr>\n<p>参考内容</p>\n<p><a href=\"https://developers.google.com/web/updates/2018/09/inside-browser-part2\">浏览器内部运行机制</a></p>\n<p><a href=\"http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html\">从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理</a></p>","fields":{"postName":"/post/浏览器内部：浏览器进程"}}},{"node":{"id":"b293356a-142c-5528-b033-cb96cd3c0f28","frontmatter":{"title":"Nodejs事件循环","date":"2019-05-12","description":"从整体上讲述Nodejs时间循环，包括时间循环的流程、流程中各阶段的任务。"},"html":"<h4>总览</h4>\n<p>node事件循环的各个阶段，如下图所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\">   ┌───────────────────────────┐\n┌─>│           timers          │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │     pending callbacks     │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │       idle, prepare       │\n│  └─────────────┬─────────────┘      ┌───────────────┐\n│  ┌─────────────┴─────────────┐      │   incoming:   │\n│  │           poll            │&lt;─────┤  connections, │\n│  └─────────────┬─────────────┘      │   data, etc.  │\n│  ┌─────────────┴─────────────┐      └───────────────┘\n│  │           check           │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n└──┤      close callbacks      │\n   └───────────────────────────┘</code></pre></div>\n<hr>\n<h4>总体执行流程</h4>\n<p>node代码执行的流程：</p>\n<p>在你通过node执行一个脚本时，比如<code class=\"language-text\">node my-scripts.js</code>。</p>\n<ul>\n<li>在单线程作用下，node会先执行所有同步的主代码。</li>\n<li>\n<p>在所有同步代码执行完毕后，node会查看事件循环是否存活，在事件循环中是否有待执行内容。</p>\n<ul>\n<li>若事件循环中无待执行内容，则尝试执行退出回调，比如<code class=\"language-text\">process.on(&#39;exit&#39;,foo)</code>，执行完毕后退出。</li>\n<li>若事件循环中有带执行内容，则进入事件循环，按照上图所示的各个阶段依次执行。</li>\n</ul>\n</li>\n<li>一个循环执行完毕后，会再次检测循环是否存活，是否有待执行内容，若有，则开启新的一轮循环；若无，则程序执行退出操作，进行退出。</li>\n</ul>\n<p>以服务器代码为例，开启服务器，则会先执行所有同步的主流程代码，然后进入事件循环，其他非请求事件执行完毕后，服务器进入到监听请求状态，事件循环会不断进行，监听请求，请求进入后，事件循环执行I/O回调，完毕后再次进入监听状态。</p>\n<hr>\n<h4>各阶段详情</h4>\n<h5>timers 阶段</h5>\n<p>通过<code class=\"language-text\">setTimeout</code>和<code class=\"language-text\">setInterval</code>指定的内容都将在这个阶段被执行。当循环进行到这个阶段时，时间到期的定时回调会被执行。</p>\n<p>在Timers阶段中，各个定时器会按照距离需要执行的时间从近到远的顺序，被放在一个堆内存中。当事件循环执行到这个阶段时，会依次获取堆中的定时器，查看定时器是否到期，若到期，则执行定时器回调，执行后查看下一个，若下一个也到期，则继续执行，直到：</p>\n<ul>\n<li>遇到第一个未到期的定时器，则停止执行，进入事件循环下一个阶段。因为定时器按照距离需要执行事件从近到远的顺序排列，所以遇到第一个未到期的定时器，则表示后面的定时器都是未到期的。</li>\n<li>或者事件循环在这个阶段的执行事件超过系统限定的此阶段的最大时长，此时也需要停止此阶段的处理，进入下一阶段。</li>\n</ul>\n<h5>pending 阶段</h5>\n<p>这个阶段会执行被挂起的 I/O 回调。大多数的 I/O 回调都会在轮询到 I/O 结束时直接立马被调用（在poll阶段中），但是有一些回调会被推迟到下一个循环，被上一个循环推迟的 I/O 回调会在这个阶段被执行。</p>\n<p>当事件循环进入到这个阶段时，会依次执行上一个循环中被推迟的I/O回调，直到队列总的所有回调都被执行完，或者总执行时长达到系统限定的此阶段执行时间。</p>\n<h5>Idle，Prepare 阶段</h5>\n<p>libUV 内部使用</p>\n<h5>poll 阶段</h5>\n<p>轮询阶段执行的内容是：检索新的I/O事件，执行I/O回调。除关闭函数、计时器回调及 <code class=\"language-text\">setImmediate()</code>等指定的回调外的其他回调，几乎都是在这个阶段被执行的。事件循环进入到这个阶段后：</p>\n<ul>\n<li>若此轮询执行队列中已经有内容，则会直接处理队列中的内容，直到队列为空或者执行时间达到系统指定最长时限</li>\n<li>如果轮询队列中没有内容，node会进行等待，等待I/O回调被添加到轮询执行队列中，若有回调被添加，则立即执行。</li>\n</ul>\n<p>如上所说到的，轮询队列可能会进行等待，等待的时间受各种因素影响：</p>\n<ul>\n<li>如果事件循环以<code class=\"language-text\">UV_RUN_NOWAIT</code>形式进行，则不进行等待，直接进入下一阶段</li>\n<li>如果事件循环需要停止，则不进行等待</li>\n<li>如果没有活跃的处理或请求，也就相当于没有后续需要等待被处理的I/O回调，则不进行等待</li>\n<li>如果idle阶段有活跃的内容待处理，则不等待</li>\n<li>如果关闭阶段有内容在等待被处理，则不等待</li>\n<li>如果上面情况都没有出现，则查看timer阶段中的堆内存，取第一个计时器的，等待时间根据距离这个定时器执行需要的时间而定。如果此时没有活跃的定时器，则等待时间为无穷大。(等待时间为无穷大，但是整个阶段受系统指定此阶段处理最大时间限制，到达这个限制时间还是会进入下一个阶段)</li>\n</ul>\n<h5>check 阶段</h5>\n<p>执行通过<code class=\"language-text\">setImmediate()</code>注册的回调。事件循环到这个阶段时，会依次同步地执行<code class=\"language-text\">setImmediate</code>回调，直到所有回调被执行完或者达到系统限定的此阶段执行时间。</p>\n<h5>close 阶段</h5>\n<p>执行close事件的回调，比如<code class=\"language-text\">socket.on(&#39;close&#39;, …)</code>。</p>\n<hr>\n<h4>nextTickQueue 和 microTaskQueue</h4>\n<p><code class=\"language-text\">nextTickQueue</code>和<code class=\"language-text\">microTaskQueue</code>是另外两个与node事件循环有关的队列。<code class=\"language-text\">nextTickQueue</code>中存放调用<code class=\"language-text\">process.nextTick()</code>指定的回调。<code class=\"language-text\">microTaskQueue</code>中存放宏任务回调，比如resolved的Promise回调。他们不是在<code class=\"language-text\">libUV</code>库中原生实现的，而是在<code class=\"language-text\">node.js</code>上层中实现的。</p>\n<p>这两个队列中的任务会被尽快执行，其执行时间，是事件循环从一个阶段进入下一个阶段的间隙。和事件循环的各个阶段不同，这两个队列的执行没有系统时间限制，node会执行它们，直到队列为空。</p>\n<p><code class=\"language-text\">nextTickQueue</code> 相对 <code class=\"language-text\">microTaskQueue</code> 拥有更高的优先级。(需要注意的是，如果使用的是V8提供的原生Promise，nextTickQueue的优先级高于作为宏任务回调的Promise回调，但是如果使用的是<code class=\"language-text\">q</code>或者<code class=\"language-text\">bluebird</code>这类JS库提供的Promise，情况则不一样了。)</p>\n<hr>\n<p>参考文章：</p>\n<p><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/\">nodejs事件循环、计时器和<code class=\"language-text\">process.nextTick()</code></a></p>\n<p><a href=\"http://voidcanvas.com/nodejs-event-loop/\">nodejs事件循环的流程和生命周期</a></p>\n<p><a href=\"https://jsblog.insiderattack.net/event-loop-and-the-big-picture-nodejs-event-loop-part-1-1cb67a182810\">nodejs事件循环概览</a></p>\n<p><a href=\"http://docs.libuv.org/en/v1.x/design.html#the-i-o-loop\">libuv的I/O循环</a></p>","fields":{"postName":"/post/Nodejs事件循环"}}},{"node":{"id":"dcc1295e-70d2-5c09-a2f6-44563bfe1955","frontmatter":{"title":"写一个React全局组件","date":"2019-03-31","description":"写全局组件不像局部组件那样直接，文本记录如何写一个比较好的全局React组件。"},"html":"<p>创建一个React组件库时，类似于<code class=\"language-text\">&lt;Button/&gt;</code>这类局部组件，是页面上的一个固定元素，所以相对来说，写起来比较直观，只需要定义一个组件，让用户直接去引用就可以了。但是对于\"弹框\"这种全局组件，应该如何写呢？应该如何控制组件的展示呢？</p>\n<p>引用局部组件的思路是，让用户从组件层面控制弹框的展示，最后用户使用的代码大概是这个样子。如果<code class=\"language-text\">displayModal</code>为false，则渲染null，从而使组件消失；如果为true，则渲染组件，让组件出现。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>displayModal<span class=\"token punctuation\">,</span>setDisplayModal<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n  \t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token function\">setDisplayModal</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>displayModal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Click</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    \t</span><span class=\"token punctuation\">{</span> displayModal <span class=\"token operator\">?</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Modal</span><span class=\"token punctuation\">/></span></span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>但是这种带来的麻烦就是，组件位于在第一层<code class=\"language-text\">&lt;div&gt;</code>内部，任何外层样式都可能会影响到组件的样式，导致每次都需要使用者去手动调整样式。</p>\n<hr>\n<h4>组件直接写在全局上</h4>\n<p>既然在这个层级内，样式会被干扰到，那么很自然地，需要把组件写到body下面。一种比较直接的方式当然就是在最上层组件里面，加一个Modal组件，然后下层去控制这个Modal的展示与否，大概是这样的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n  \t<span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n    \t<span class=\"token punctuation\">{</span><span class=\"token comment\">/* 其他逻辑组件 */</span><span class=\"token punctuation\">}</span>\n    \t<span class=\"token operator\">&lt;</span>Modal<span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这样造成的一是如果有很多全局组件，则要在App下面写一堆组件，显得非常繁琐；二是逻辑分散，如果你写的是组件库，则相当于用户需要在它的最上层组件中去引用，然后在下层组件中去写控制逻辑；三是，如果这样写，Modal和下层组件被隔离开，需要另想办法来控制组件的展示与否</p>\n<hr>\n<h4>使用Portal</h4>\n<p>React的Portal可以达到，在组件中，可以突破组件层级，将某个组件渲染到一个层级外组件下面，作为那个组件的子组件。使用Portal的写法大概是：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ConfirmModal</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> visible <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Modal <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">cname</span><span class=\"token punctuation\">(</span><span class=\"token string\">'confirm-modal-container'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> hidden<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span>visible <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span><span class=\"token comment\">/* modal content */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>visible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">createPortal</span><span class=\"token punctuation\">(</span>\n        Modal<span class=\"token punctuation\">,</span>\n        document<span class=\"token punctuation\">.</span>body\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>visible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>通过visible属性来控制组件的展示与否，如果可见，则返回一个<code class=\"language-text\">ReactDOM.createPortal(Modal,document.body)</code>，否则返回null。在这种情况下，生成的Modal则会变为body的子元素，从而突破层级限制，Modal的样式也不会受到其他组件的影响，Modal的样式大概可以这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.confirm-modal-container</span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> fixed<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>128, 128, 128, 0.5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">bottom</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">right</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这样自然就形成了一个全局的蒙层。</p>\n<p>另外，在上面情况下，初始是不可见，变为可见后，Modal会被生成称为body的直接子元素；当visible属性由true变为fasle时，由于最后渲染的是null，所以Modal会从body下被移除。</p>\n<hr>\n<h4>通过类名控制可见性</h4>\n<p>上面的情况已经基本可以达到要求了，但是，每次的可见性切换，都会执行DOM插入与移除操作。一般的可见性都可以通过类名控制，所以做一个小小的更新：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ConfirmModal</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> visible <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hasShow <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> Modal <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">cname</span><span class=\"token punctuation\">(</span><span class=\"token string\">'confirm-modal-container'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> hidden<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span>visible <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span><span class=\"token comment\">/* modal content */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> portal <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>visible <span class=\"token operator\">||</span> hasShow<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasShow<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      hasShow<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    portal <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n      ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">createPortal</span><span class=\"token punctuation\">(</span>\n        Modal<span class=\"token punctuation\">,</span>\n        document<span class=\"token punctuation\">.</span>body\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>visible <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>hasShow<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    portal <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> portal<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如下：</p>\n<ul>\n<li>初始情况下，visible为false。通过<code class=\"language-text\">useRef</code>设置一个<code class=\"language-text\">hasShow</code>属性，初始值为false，用来表示弹框是否是第一次展示。如果visible为false，并且是第一次展示，则渲染null。</li>\n<li>如果visible变为true，则将<code class=\"language-text\">hasShow</code>置为true，表示已经展示过。此时返回<code class=\"language-text\">React.createPortal</code>，向body下插入Modal</li>\n<li>此时，当visible再次从true变为false时，不再返回null，相反，还是返回<code class=\"language-text\">React.createPortal</code>，只不过此时内部被增加一个hidden类，针对这个类设置<code class=\"language-text\">display:none</code>，从而起到隐藏作用</li>\n<li>再当visible从false变为true时，则可以仍然使用<code class=\"language-text\">React.createPortal</code>,只不过去掉<code class=\"language-text\">hidden</code>类。从而使插入Modal的body不用重复地被插入移除。</li>\n</ul>","fields":{"postName":"/post/写一个React全局组件"}}},{"node":{"id":"eda8d1e7-4ab1-5150-a28d-f6c3cad5e6c6","frontmatter":{"title":"Webpack的bundle-splitting","date":"2019-03-30","description":"Webpack的包拆分，指的是拆分最终打包出来的包，从而优化资源加载。在此记录，如何通过Webpack的SplitChunks达到包拆分的目的。"},"html":"<p>在打包React文件时，如果只有一个入口，在不利用代码拆分的方式下，最后的打包出来会只有一个文件。拆分包，则是把这一个最终的包拆分为多个。拆分包带来的好处是，如果将一个包拆分为\"业务包\"和\"依赖包\"后，浏览器会加载两个包，在业务包被更新后，可以利用浏览器缓存，无需再下载依赖包，只需下载业务包即可完成整个展示。</p>\n<p>拆分包，对于浏览器的第一次加载不一定有好处，因为需要从加载一个包变成加载多个包。但是当用户频繁访问一个网站时，拆分包的好处便展示出来了，它可以利用浏览器缓存，无需加载已缓存且未变化的包，从而增加二次加载的速度。</p>\n<hr>\n<h4>场景</h4>\n<p>先整体看一下webpack的包拆分情况：</p>\n<ul>\n<li>在webpack中设置一个入口，在不做其他设置、代码中没有异步引用的情况下，打包出来的内容一般是一个chunk。如果设置多个入口文件，则会打包出多个chunk，比如下面配置，打包出来是<code class=\"language-text\">a.budnle.js</code>和<code class=\"language-text\">b.bundle.js</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">entry<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n    a<span class=\"token punctuation\">:</span><span class=\"token string\">'./src/a.js'</span><span class=\"token punctuation\">,</span>\n    b<span class=\"token punctuation\">:</span><span class=\"token string\">'./src/b.js'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\noutput<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n    filename<span class=\"token punctuation\">:</span><span class=\"token string\">'[name].bundle.js'</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">:</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>如果只有一个入口，代码或webpack配置进行变更，可能会产生多个chunk。产生多个chunk可以通过改变webpack的<code class=\"language-text\">optimization.splitChunks</code>配置项实现，也可以通过异步导入的方式实现（其实对应的是<code class=\"language-text\">optimization.splitChunks.chunks = &#39;async&#39;</code>）。</p>\n</li>\n<li>\n<p>如果有多个入口，但是多个入口的文件中，引入了相同的文件，则可以把这个相同文件提取出来，作为公共共享包，从而避免一个文件的多次加载。</p>\n</li>\n</ul>\n<p>可以通过设置<code class=\"language-text\">optimization.splitChunks</code>来设置webpack的包拆分方式</p>\n<hr>\n<h4>splitChunks默认配置</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n  optimization<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    splitChunks<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      chunks<span class=\"token punctuation\">:</span> <span class=\"token string\">'async'</span><span class=\"token punctuation\">,</span>\n      minSize<span class=\"token punctuation\">:</span> <span class=\"token number\">30000</span><span class=\"token punctuation\">,</span>\n      maxSize<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      minChunks<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      maxAsyncRequests<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n      maxInitialRequests<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n      automaticNameDelimiter<span class=\"token punctuation\">:</span> <span class=\"token string\">'~'</span><span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      cacheGroups<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        vendors<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/[\\\\/]node_modules[\\\\/]/</span><span class=\"token punctuation\">,</span>\n          priority<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">10</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          minChunks<span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n          priority<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n          reuseExistingChunk<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h4>chunks值</h4>\n<p>chunks的取值可以是<code class=\"language-text\">async</code>、<code class=\"language-text\">initial</code>、<code class=\"language-text\">all</code>三个值中的一个。下面参照 <a href=\"https://medium.com/dailyjs/webpack-4-splitchunks-plugin-d9fbbe091fd0\">Webpack4-神奇的SplitChunks插件</a> 这篇文章，对这三个值做一个解释。</p>\n<ul>\n<li>\n<p>第一种情况下，设置值为<code class=\"language-text\">async</code>：只有异步加载的包才会被放在一个新的chunk中</p>\n<ul>\n<li>此时，a和b中，lodash都是采用的异步加载，所以他们会被放在一个新的chunk中(<code class=\"language-text\">0.bundle.js</code>)</li>\n<li>a中，jquery和react都是同步加载的，所以 <code class=\"language-text\">a.bundle.js</code>中把 jquery和react都放进了包里面</li>\n<li>b中，jquery是同步加载的，所以<code class=\"language-text\">b.bundle.js</code>中包含了jquery，但是因为react是异步加载的，所以react被放入到了一个新的chunk(<code class=\"language-text\">1.bundle.js</code>)中</li>\n<li>注意到，此时jquery既存在于 <code class=\"language-text\">a.bundle.js</code>中，也存在于<code class=\"language-text\">a.bundle.js</code>中，也存在于<code class=\"language-text\">b.bundle.js</code>中</li>\n</ul>\n</li>\n<li>\n<p>第二种情况下，设置值为<code class=\"language-text\">initial</code>：此时，对异步加载的包不做限制，但对于每个入口，首次加载时，所有的内容需要在一个包中</p>\n<ul>\n<li>a和b中，lodash都是异步加载，所以被放在新的chunk中(<code class=\"language-text\">0.bundle.js</code>)</li>\n<li>a和b中，jquery都是同步加载的，但是由于它同时在a和b中，超过了splitChunks中默认的<code class=\"language-text\">minChunks:2</code>，也就是说，它会被重新重新提取出来，到一个公共共享chunk中(<code class=\"language-text\">verdor~a~b.bundle.js</code>)。此时如果更改一下<code class=\"language-text\">minChunks</code>的值，如下，改为3。此时打包出来的情况，jquery会既在a的chunk中，也在b的chunk中</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">splitChunks<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n  cacheGroups<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n    vendor<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      test<span class=\"token punctuation\">:</span><span class=\"token regex\">/[\\\\/]node_modules[\\\\/]/</span><span class=\"token punctuation\">,</span>\n      chunks<span class=\"token punctuation\">:</span><span class=\"token string\">'initial'</span><span class=\"token punctuation\">,</span>\n      minChunks<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>a中，react是直接引用的，因为有<code class=\"language-text\">vendor</code>的test设置，所以遇到<code class=\"language-text\">node_modules</code>中的包，都会被分出来，于是a中的react被放在了<code class=\"language-text\">vendor~a.bundle.js</code>中。而b中的react是异步引入的，所以被放在一个另外的文件<code class=\"language-text\">1.bundle.js</code>中</li>\n</ul>\n</li>\n<li>\n<p>第三种情况下，设置值为<code class=\"language-text\">all</code>：不在意异步加载或同步加载，对所有包进行自动优化</p>\n<ul>\n<li>此时，react、jquery和lodash都在单独的chunk中</li>\n<li>react在a中同步，在b中异步，所以react到了一个单独的文件中(<code class=\"language-text\">0.bundle.js</code>)</li>\n<li>lodash被两个文件异步加载，也到了另外一个单独文件中(<code class=\"language-text\">1.bundle.js</code>)</li>\n<li>jquery被两个文件同时同步加载，所以它到了一个公共共享的chunk中(<code class=\"language-text\">vendor~a~b.bundle.js</code>)</li>\n</ul>\n</li>\n</ul>\n<p>另外，在文章中，所有的配置都是下面形式的，但是它是等价于下面代码形式的</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//配置1</span>\nsplitChunks<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// chunks:'initial',</span>\n  cacheGroups<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n    vendor<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      test<span class=\"token punctuation\">:</span><span class=\"token regex\">/[\\\\/]node_modules[\\\\/]/</span><span class=\"token punctuation\">,</span>\n       chunks<span class=\"token punctuation\">:</span><span class=\"token string\">'initial'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n  \n<span class=\"token comment\">// 在没有其他配置的情况下，等价于</span>\n\n<span class=\"token comment\">//配置2</span>\n  splitChunks<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n     chunks<span class=\"token punctuation\">:</span><span class=\"token string\">'initial'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>等价的原因是，splitChunks 有默认的<code class=\"language-text\">vendors</code>设置，你会发现，如果是用配置1，则所有的共共享chunk名字都是以<code class=\"language-text\">vendor</code>开头，而使用配置2，所有的共享包，都会以<code class=\"language-text\">vendors</code>开头。配置1覆盖了默认的<code class=\"language-text\">vendors</code>配置，而配置2则没有覆盖，所以都是以默认的<code class=\"language-text\">vendors</code>配置走的。</p>\n<hr>\n<h4>其他配置项</h4>\n<ul>\n<li>minChunks：默认为2，表示，当文件的被引用次数 >= 2 时，被拆分为一个单独的chunk</li>\n<li>maxAsyncRequests：按需加载chunk时，最大平行请求数</li>\n<li>maxInitialRequests：对一个入口，最大平行请求数</li>\n<li>minSize：当产生的chunk大于这个值时，才会成为一个chunk</li>\n<li>name：chunk的名字</li>\n</ul>\n<hr>\n<h4>cacheGroups:</h4>\n<ul>\n<li>test:  检测哪些包应该被放入chunk中，例如正则表达式<code class=\"language-text\">/node_modules/</code>，表示，在引入包的时候，引入路径里面包含<code class=\"language-text\">/node_modules/</code>，则这个包符合这个<code class=\"language-text\">cacheGroups</code>的考虑范畴。至于是否被放入到chunk中，需要视<code class=\"language-text\">chunks</code>的值而视。</li>\n<li>splitChunks层级设置的<code class=\"language-text\">chunks</code>、<code class=\"language-text\">minChunks</code>等值，同样适用于<code class=\"language-text\">cacheGroups</code>，<code class=\"language-text\">cacheGroups</code>值会覆盖<code class=\"language-text\">splitChunks</code>中的值。而<code class=\"language-text\">cacheGroups</code>中未设置的值会向上在<code class=\"language-text\">splitChunks</code>下寻找，若也找不到，则使用默认值。</li>\n<li>priority：如果一个文件同时满足多个<code class=\"language-text\">cacheGroups</code>，则根据此配置决定进入那个<code class=\"language-text\">cacheGroups</code>指定的chunk</li>\n<li>enforce：enforce为true，则可以强制chunk被拆分出来。如果需要这个包被强制拆分时会很有用，比如，默认情况下，<code class=\"language-text\">splitChunks.minSize=30000</code>，也就是说一个chunk的大小达到30k的时候，webpack才会把它真的形成一个chunk，否则会把它放在其他chunk中。这个时候设置enforce为true，则可以使包忽略这些设置，强制让它成为一个新的chunk。</li>\n</ul>\n<hr>\n<h4>参考</h4>\n<ul>\n<li><a href=\"https://survivejs.com/webpack/building/bundle-splitting/\">Bunlde Splitting</a></li>\n<li><a href=\"https://medium.com/dailyjs/webpack-4-splitchunks-plugin-d9fbbe091fd0\">Webpack 4 — Mysterious SplitChunks Plugin</a></li>\n<li><a href=\"https://hackernoon.com/the-100-correct-way-to-split-your-chunks-with-webpack-f8a9df5b7758\">The 100% correct way to split your chunks with Webpack</a></li>\n<li><a href=\"https://itnext.io/react-router-and-webpack-v4-code-splitting-using-splitchunksplugin-f0a48f110312\">Webpack (v4) Code Splitting using SplitChunksPlugin</a></li>\n<li><a href=\"https://webpack.js.org/plugins/split-chunks-plugin/\">SplitChunksPlugin</a></li>\n</ul>","fields":{"postName":"/post/Webpack的bundle-splitting"}}},{"node":{"id":"da2f2705-39b4-56c5-ace7-fb7ea3bd3f52","frontmatter":{"title":"React的code-splitting","date":"2019-03-29","description":"代码拆分能够让App避免加载用户不会用到的代码，减少在首次加载时需要下载的代码量。在此记录一下React的代码拆分方法。"},"html":"<p>在打包时，当第三方包过多时，如果把这些包全部都打包到一个文件中，则很有可能会导致这个文件过大，加载过慢。在这种情况下，就要考虑把代码进行拆分打包。代码拆分是指，类似于 Webpack 或 Browserify等打包器支持的，把代码打包至多个包中，在应用运行时进行动态加载的打包方式。</p>\n<p>代码拆分能够让 App 只加载现在需要的内容，从而加快 App 的加载速度，并且可以避免加载用户不会用到的代码，减少在首次加载时需要下载的代码量。</p>\n<hr>\n<h4>动态import</h4>\n<ul>\n<li>动态<code class=\"language-text\">import()</code>语法，基本写法如下。当 Webpack 遇到这类语法时，它会自动将 App 进行拆分。动态加载语法暂时只是 ECMAScript 的提案，并不是标准。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./math\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>math <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>math<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>Create React App</h5>\n<ul>\n<li>如果你使用 Create React App 或者 Next.js ，则这种功能已经被配置好了，你能够直接使用。</li>\n</ul>\n<h5>Webpack</h5>\n<p>使用 Webpack 自行配置，大致配置如下</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    mode<span class=\"token punctuation\">:</span><span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n    entry<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      index<span class=\"token punctuation\">:</span><span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    output<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      filename<span class=\"token punctuation\">:</span><span class=\"token string\">'[name].bundle.js'</span><span class=\"token punctuation\">,</span>\n      chunkFilename<span class=\"token punctuation\">:</span><span class=\"token string\">'[name].bundle.js'</span><span class=\"token punctuation\">,</span>\n      path<span class=\"token punctuation\">:</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 指定 webpackChunkName，即webpack.config.js中的 name，若不指定，生成包默认会命名为 0.bundle.js</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* webpackChunkName: \"lodash\" */</span> <span class=\"token string\">'lodash'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> _ <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    element<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Hello'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'webpack'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> element<span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token string\">'An error occurred while loading the component'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// getComponent()返回一个 promise</span>\n<span class=\"token function\">getComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>component <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>component<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>注意，<code class=\"language-text\">import()</code>内部采用 promise，所以它会返回一个promise，需采用 promise 进行后续处理</li>\n</ul>\n<h5>babel</h5>\n<ul>\n<li>如果项目中使用了 babel做转义，则需要用到[babel-plugin-syntax-dynamic-import][https://yarnpkg.com/en/package/babel-plugin-syntax-dynamic-import]插件来转义动态<code class=\"language-text\">import</code>。现代项目中一般都会使用babel，所以一般都先安装这个插件，才能做动态导入，否则会无法识别动态<code class=\"language-text\">import</code>语法而报错</li>\n</ul>\n<hr>\n<h4>React.lazy + Suspense</h4>\n<p>使用方法示例：</p>\n<blockquote>\n<p>注意，React.lazy 和 Suspense 在服务端暂时不支持，如果相对服务端应用做代码拆分，推荐使用 [Loadable Components][https://github.com/smooth-code/loadable-components]</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> OtherComponent <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./OtherComponent'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>React.Suspense</span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">loading</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OtherComponent</span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>React.Suspense</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>需要注意的点：</p>\n<ul>\n<li>lazy 和 Suspense都位于<code class=\"language-text\">react</code>包中</li>\n<li>在打包的时候，会把<code class=\"language-text\">OtherComponent</code>打包如另外一个包中，当<code class=\"language-text\">OtherComponent</code>被渲染的时候，会自动加载<code class=\"language-text\">OtherComponent</code>并渲染它</li>\n<li><code class=\"language-text\">React.lazy</code>必须调用一个动态<code class=\"language-text\">import()</code>，而这个动态import返回一个Promise，这个Promise被resolve为一个模块，这个模块中是一个有<code class=\"language-text\">default</code>导出的React组件</li>\n<li>如果<code class=\"language-text\">React.lazy</code>加载的组件还没有加载成功或还没有被渲染到页面上，页面上会展示<code class=\"language-text\">Suspense</code> <code class=\"language-text\">fallback</code>中的组件，作为一个加载指示器。<code class=\"language-text\">fallback</code>中可以放任何组件。<code class=\"language-text\">Suspense</code>中也可以放置多个<code class=\"language-text\">lazy</code>加载的组件。</li>\n</ul>\n<h6>React.lazy + Supsense + Router</h6>\n<p>通过lazy动态导入组件，一个比较好的地方是路由，示例如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> BrowserRouter <span class=\"token keyword\">as</span> Router<span class=\"token punctuation\">,</span> Route<span class=\"token punctuation\">,</span> Switch <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Suspense<span class=\"token punctuation\">,</span> lazy <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> Home <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./routes/Home'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> About <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./routes/About'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Router</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Suspense</span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Switch</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Route</span> <span class=\"token attr-name\">exact</span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">component</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>Home<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Route</span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/about<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">component</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>About<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Switch</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Suspense</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Router</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>命名导入</h5>\n<p><code class=\"language-text\">React.lazy</code>现在只支持<code class=\"language-text\">default</code>导出。非<code class=\"language-text\">default</code>导出的组件，可以采用创建一个文件然后导入组件再导出的方式，例如：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ManyComponents.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> MyComponent <span class=\"token operator\">=</span> <span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> MyUnusedComponent <span class=\"token operator\">=</span> <span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// MyComponent.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> MyComponent <span class=\"token keyword\">as</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./ManyComponents.js\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// MyApp.js</span>\n<span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> lazy <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MyComponent <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./MyComponent.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h4>扩展</h4>\n<ul>\n<li>通过 Webpack 多<code class=\"language-text\">entry</code>的方式进行代码拆分，如下：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    mode<span class=\"token punctuation\">:</span><span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n    entry<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 设置两个入口文件</span>\n      index<span class=\"token punctuation\">:</span><span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span>\n      another<span class=\"token punctuation\">:</span><span class=\"token string\">'./src/another-module.js'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    output<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      filename<span class=\"token punctuation\">:</span><span class=\"token string\">'[name].bundle.js'</span><span class=\"token punctuation\">,</span>\n      path<span class=\"token punctuation\">:</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    optimization<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 设置splitChunks，将两个包的共同代码提取到一个包中</span>\n      splitChunks<span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n        chunks<span class=\"token punctuation\">:</span><span class=\"token string\">'all'</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"postName":"/post/React的code-splitting"}}},{"node":{"id":"5cedbcc0-ddca-5f42-a772-425e5ee7a72b","frontmatter":{"title":"react-emotion的useSpring","date":"2019-03-24","description":"react-emotion是一个React动画库，并且已经发布了Hook版本。本文主要介绍库中基础功能useSpring的用法。"},"html":"<p>先解释一个非常简单的示例，然后由这个示例引申到<code class=\"language-text\">useSpring</code>的使用及配置。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useSpring<span class=\"token punctuation\">,</span> animated <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-spring'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> number <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>number<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>如上面的代码，会看到的动画是，数字由1变为0，且变化过程中，数字一直保持2为小数。</p>\n<p>useSpring配合<code class=\"language-text\">animated</code>使用，可以使元素从一个状态变为另外一个状态，如上面所示，初始状态 number为1，最终状态为number为0，元素进行了从初始状态到最终状态的变化，而这种变化是通过动画的形式展现的。</p>\n<hr>\n<h4>useSpring</h4>\n<h5>参数</h5>\n<p><code class=\"language-text\">useSpring</code>是一个React Hook。它定义了，动画的初始状态、最终状态以及一些变化参数。先看基本的，<code class=\"language-text\">useSpring</code>若接受一个对象为参数（实例中就是以对象为参数），则这个对象可以包含以下属性：</p>\n<ul>\n<li>\n<p><code class=\"language-text\">from</code>，表示初始状态</p>\n</li>\n<li>\n<p><code class=\"language-text\">to</code>，表示最终状态。需要注意的是，所有未在<code class=\"language-text\">react-spring</code>API 中指定的参数，都会被视为 <code class=\"language-text\">to</code>终止状态的数据。比如上面示例中<code class=\"language-text\">useSpring({ number: 0, from: { number: 1 } })</code>，number并不是API指定的配置参数，所以<code class=\"language-text\">number:0</code>是<code class=\"language-text\">to</code>的数据之一，也就是说，它等价于<code class=\"language-text\">useSpring({ to: { number: 0 }, from: { number: 1 } });</code></p>\n</li>\n<li>\n<p><code class=\"language-text\">delay</code>，动画等待时间，如设置为1000，则动画会在等待1s后才执行</p>\n</li>\n<li>\n<p><code class=\"language-text\">immediate</code>，值为一个布尔值或者一个返回布尔值的函数，若布尔值为true或函数执行结果为true，则会从开始状态直接变为最终状态，而不执行动画</p>\n</li>\n<li>\n<p><code class=\"language-text\">reverse</code>，对调动画的最终状态和初始状态，只有当设置了<code class=\"language-text\">reset</code>为true时才有意义</p>\n</li>\n<li>\n<p><code class=\"language-text\">config</code>，动画配置。</p>\n<ul>\n<li>可配置项包括<code class=\"language-text\">duration</code>、<code class=\"language-text\">precision</code>、<code class=\"language-text\">easing</code>等参数。如上示例中，变为如下形式，则数字从1变为0会在3s钟内进行，动画会维持3s。全部可配置项可以参见<a href=\"https://www.react-spring.io/docs/hooks/api\">react-spring官网common-api的config</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> number <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> to<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> duration<span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>react-spring中预设了一部分配置项。这些配置项包括<code class=\"language-text\">default</code>、<code class=\"language-text\">gentle</code>等，可以使用以下方式进行引用</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span> config <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-spring'</span>\n\n<span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span>gentle <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">onStart</code>，当动画开始时，执行这个函数</p>\n</li>\n<li>\n<p><code class=\"language-text\">onFrame</code>，动画的每帧播放时调用，会传入此时的动画值，动画值见下面<code class=\"language-text\">useSpring</code>的返回值解释</p>\n</li>\n</ul>\n<h5>返回值</h5>\n<p><code class=\"language-text\">useSpring</code>的返回值是一个对象，这个对象的属性，是<code class=\"language-text\">useSpring</code>参数中的状态值。对象中的各状态值会随着动画的进行而变化。最开始的时候，此状态值是初始状态值；动画开始后，状态值变为动画状态对应的值；最终在动画结束时，此状态值变为最终状态。</p>\n<p>比如在上述示例中，采用了结构赋值，返回的实际值是一个 <code class=\"language-text\">{number:AnimatedValue}</code>，表示返回的是一个对象，这个对象有一个number属性，而number的值是一个对象，这个对象是<code class=\"language-text\">AnimatedValue</code>类型，它有一个<code class=\"language-text\">value</code>属性，其值为0。之后动画进行时，这个value值会随着动画状态变更，最终变为最终状态中的1</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> number <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>函数参数</h5>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useSpring<span class=\"token punctuation\">,</span> animated <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-spring'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> number <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">,</span> stop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">handleClick</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">{</span>number<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>handleClick<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>reverse<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>上面代码实现的效果是：页面加载后，数字0会使用动画变为1，此时点击reverse按钮，数字又会由1以动画形式变为0，再次点击reverse，则又会变为1。</p>\n<p>如上面代码所示：</p>\n<ul>\n<li><code class=\"language-text\">useSpring</code>可以接受一个函数作为参数，这个函数的的返回值是一个对象，此对象是上面已经讲述过的那个，可以有from、to等参数</li>\n<li>当<code class=\"language-text\">useSpring</code>接受函数为参数时，它的返回值是一个数组，上面采用了解构赋值的方式，数组中包含三个值，第一个返回值和上面<code class=\"language-text\">useSpring</code>接受对象时的返回值相同，第二个返回值是一个set函数，第三个返回值是一个stop函数</li>\n<li>set函数，可以接受一个对象，它和React原生的<code class=\"language-text\">setState</code>很相似，可以将动画状态至为某个指定状态(这个指定状态就是调用set函数时的入参)，调用set函数后，react-spring会按照<code class=\"language-text\">useSpring</code>中指定的动画配置，将元素以动画的形式变为指定状态。</li>\n<li>stop函数可以使动画停止</li>\n</ul>\n<hr>\n<h4>interpolate</h4>\n<p>interpolate的作用是，设定动画的呈现：</p>\n<ul>\n<li>interpolate可以接受一个函数，这个函数的返回值，会被用作效果呈现，比如上面例子中，接受了一个函数<code class=\"language-text\">n=&gt;n.toFixed(2)</code>，则，每个number值在呈现的时候，都只会取两位小数</li>\n<li>interpolate可以接受两个数组，此时第一个数组表示的是时间线，第二数组是对应的输出，比如 <code class=\"language-text\">number.interpolate([0,0.5,1],[0,1.9.2])</code>，它表示的是，动画执行时，0时刻，应该输出0；中间时刻点应该输出1.9；到最终动画中点，应该是2。此时第二个数组的输出，也就是对应时刻，动画应该在的状态。</li>\n<li>interpolate也可以接受一个对象，这个对象包括<code class=\"language-text\">range</code>、<code class=\"language-text\">output</code>、<code class=\"language-text\">extrapolate</code>等属性</li>\n</ul>\n<p>interpolate也可以串联使用，比如</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">number\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>此时由<code class=\"language-text\">.interpolate([0, 0.5, 1], [2, 1.9, 0])</code>输出的值会作为<code class=\"language-text\">.interpolate(n =&gt; n.toFixed(2))</code>的输入，经过取两位小数再进行输出。</p>\n<hr>\n<h4>异步动画/动画链</h4>\n<h5>异步动画</h5>\n<p>useSpring的to属性可以接受一个异步函数作为参数，在此异步函数中可以执行异步动画，比如下面的例子中，会等到接口请求返回才执行动画，每次next的时候回next出一个动画状态，然后会执行动画，将元素状态置为这个状态</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useSpring<span class=\"token punctuation\">,</span> animated <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-spring'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> fetch <span class=\"token keyword\">from</span> <span class=\"token string\">'cross-fetch'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> number <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    to<span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>next<span class=\"token punctuation\">,</span> cancel<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.reddit.com/r/reactjs.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>number<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<h5>链式动画</h5>\n<p>to 可以被指定为状态组成的数组，此时会从左往右，执行动画依次进行状态变更。如下面，会先变为1，然后再变为2</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> number <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    to<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> number<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>number<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>animated<span class=\"token punctuation\">.</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","fields":{"postName":"/post/react-emotion的useSpring"}}},{"node":{"id":"1edc97ac-5674-53ee-a51f-46208e5f29e3","frontmatter":{"title":"CSS的transform属性","date":"2019-03-23","description":"在给元素添加动画时，经常会用到transform属性。本文介绍transform属性的基本用法。"},"html":"<p>CSS的<code class=\"language-text\">transform</code>属性，是用于对某个元素进行旋转、缩放等动作，它是在给元素添加动画的基本属性。它的基本使用方式是：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token property\">tranform</span><span class=\"token punctuation\">:</span> &lt;transfrom-function> &lt;transform-function> ... </code></pre></div>\n<p><code class=\"language-text\">&lt;transform-function&gt;</code>指的则是一个或多个动作，这些动作包括：<code class=\"language-text\">matrix</code> 、 <code class=\"language-text\">translate</code>、 <code class=\"language-text\">scale</code>、 <code class=\"language-text\">rotate</code>、 <code class=\"language-text\">perspective</code> 等等。</p>\n<hr>\n<h4>translate</h4>\n<h5>基本</h5>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token property\">transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">translate</span><span class=\"token punctuation\">(</span>x,y<span class=\"token punctuation\">)</span></code></pre></div>\n<p>两个参数都是长度：</p>\n<ul>\n<li>第一个表示在水平方向的移动距离，为正表示往右移动，为负表示往左移动</li>\n<li>第二个表示垂直方向移动距离，为正表示往下移动，为负表示往上移动。不指定时，采用默认值0，即不在垂直方向移动</li>\n</ul>\n<h5>其他</h5>\n<ul>\n<li>translateX(n) = translate(n,0)</li>\n<li>translateY(n) = translate(0,n)</li>\n<li>translate3d(x,y,z)：3D空间下，在x、y、z三个方向分别移动</li>\n<li>translateZ(n) = translate3d(0,0,n)</li>\n</ul>\n<hr>\n<h4>scale</h4>\n<h5>基本</h5>\n<p><code class=\"language-text\">scale</code>的作用是进行元素的缩放，使用方式为：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>x,y<span class=\"token punctuation\">)</span></code></pre></div>\n<p>x、y表示<strong>缩放倍数</strong>。需要注意的是：</p>\n<ul>\n<li>此处的x与y不可指定为想要变化到的长度。如指定<code class=\"language-text\">transform:translate(50px,50px) scale(2px,2px)</code>会导致整条语句无效，<code class=\"language-text\">translate</code>也不会执行。</li>\n<li>当x、y大于1时，元素被“拉伸”；当小于1时，元素被压缩；当为1时，不会变化。</li>\n<li>整个缩放采用的是“拉伸”或“压缩”的方式，而不是“另外增加”。如果水平和垂直倍数不相同，会导致里面的内容变形。</li>\n<li>默认拉伸或压缩，默认的固定点是水平方向的中点或垂直方式上的中点。这个固定点可以通过<code class=\"language-text\">transform-origin</code>进行自定义。</li>\n<li>缩放倍数为负的情况下，会被“压缩过头”，比如，若设置为x为-1，y为0，最终的效果类似于元素延着水平方向的中点进行水平翻转。</li>\n</ul>\n<h5>其他</h5>\n<ul>\n<li>scale3d(x,y,z) 相对 scale(x,y) 多了z方向上的伸缩</li>\n<li>scaleX、scaleY、scaleZ分别表示在对应方向上进行缩放，其他方向上保持不变（即相当于在使用scale时其他方向上被设置为1）</li>\n</ul>\n<hr>\n<h4>rotate</h4>\n<h5>基本</h5>\n<p><code class=\"language-text\">rotate</code>能够使元素进行旋转，使用方式为</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token property\">transform</span><span class=\"token punctuation\">:</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span></code></pre></div>\n<p>其中参数a是一个旋转角度。</p>\n<ul>\n<li>a的单位可以是<code class=\"language-text\">deg</code>、<code class=\"language-text\">grad</code>、<code class=\"language-text\">rad</code>、<code class=\"language-text\">turn</code> ，具体可见有关<a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/angle\"><code class=\"language-text\">MDN&lt;angle&gt;的解释</code></a>。</li>\n<li>a为正值表示顺时间旋转，a为负值表示逆时针旋转。</li>\n<li>旋转围绕的固定点可以通过<code class=\"language-text\">transform-origin</code>进行定义，其默认值为元素的中心点。</li>\n<li><code class=\"language-text\">rotate</code>会改变元素的轴线方向。比如先<code class=\"language-text\">rotate(45deg)</code>，再进行<code class=\"language-text\">translateX(50px)</code>，旋转后，元素x方向的轴线变为45度，此时再<code class=\"language-text\">translate</code>，就会往45度的方向移动。</li>\n</ul>\n<h5>其他</h5>\n<ul>\n<li>rotate3d() 相对于 rotate多了 z 轴上的旋转</li>\n<li>rotateX、rotateY、rotateZ 即为在此方向上单独旋转</li>\n</ul>\n<hr>\n<h4>skew</h4>\n<h5>基本</h5>\n<p>skew能够使元素倾斜：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token function\">skew</span><span class=\"token punctuation\">(</span>x,y<span class=\"token punctuation\">)</span></code></pre></div>\n<p>参数x、y是一个代表倾斜角度的角度值。</p>\n<ul>\n<li>x为正则会使元素向左倾斜，为负会使元素向右倾斜。默认情况下，x方向上的倾斜，以<strong>元素底边</strong>和<strong>元素水平中线</strong>为基线。</li>\n<li>y为正，会使元素像右倾斜，为负会使元素向左倾斜。默认情况下，y方向上的倾斜，以<strong>元素右边</strong>和<strong>元素垂直中线</strong>为基线。所以，当y为正时，看起来，元素会往左上方倒；为负时，往左下方倒。</li>\n<li>可以通过<code class=\"language-text\">transform-origin</code>来指定元素的倾斜基线。例如，若设置<code class=\"language-text\">transform-origin:left</code>，此时y为正会使元素看起来往右下方倒。</li>\n</ul>\n<h5>其他</h5>\n<ul>\n<li>shewX和shewY表示在对应单独方向倾斜</li>\n</ul>\n<hr>\n<h4>matrix和perspective</h4>\n<ul>\n<li>matrix。其实上面四种变化都是可以由matrix变化而来，具体可以见 <a href=\"https://www.zhangxinxu.com/wordpress/2012/06/css3-transform-matrix-%E7%9F%A9%E9%98%B5/\">理解CSS3 transform中的Matrix</a> 这篇文章，也可以使用<a href=\"https://meyerweb.com/eric/tools/matrix/\">Matrix resolutions</a>这个工具进行转化，(这个网站第一眼看上去还是很好玩的，哈哈）</li>\n<li>perspective 可以设置用户和z=0平面的距离，其距离可以通过参数进行指定，比如<code class=\"language-text\">perspective(800px)</code></li>\n</ul>\n<hr>\n<h4>transform-origin</h4>\n<p><code class=\"language-text\">transform-origin</code>表示的是应用转化的点（转换起点），比如<code class=\"language-text\">rotate</code>在进行旋转时旋转围绕的点。</p>\n<h5>值的构成</h5>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token property\">transfrom-origin</span><span class=\"token punctuation\">:</span> x-offset y-offset z-offset</code></pre></div>\n<p>如上所示，<code class=\"language-text\">transform-origin</code>的三个值，分别表示x、y、z轴上的偏移量。</p>\n<ul>\n<li>由这三个偏移量定义的一个点，即为元素进行变化的转换起点。</li>\n<li>默认初始值是：<code class=\"language-text\">transform-origin: 50% 50%;</code></li>\n<li>对 x-offset和y-offset，偏移的起点是元素的左上角，x为正表示右偏移，y为正表示向下偏移</li>\n</ul>\n<h5>偏移量的赋值</h5>\n<ul>\n<li>x-offset、y-offset 可以是长度值、百分数和关键词(<code class=\"language-text\">left</code>、<code class=\"language-text\">right</code>、<code class=\"language-text\">top</code>、<code class=\"language-text\">bottom</code>)</li>\n<li>z-offset只能是长度值</li>\n</ul>\n<h5>关键词</h5>\n<p>关键词可以看做是百分数值的另外一种写法，其对应关系如下</p>\n<ul>\n<li>left = 0%</li>\n<li>right = 100% </li>\n<li>center = 50%</li>\n<li>top = 0%</li>\n<li>bottom = 100%</li>\n</ul>","fields":{"postName":"/post/CSS的transform属性"}}},{"node":{"id":"a381d583-65e8-5b36-b18e-9615f92a2a86","frontmatter":{"title":"eslint基础配置须知","date":"2019-03-17","description":"eslint是JavaScript开发必备工具，在此记录eslint基础配置规则"},"html":"<p>安装</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> eslint --save-dev</code></pre></div>\n<p>初始化</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./node_modules/.bin/eslint --init</code></pre></div>\n<p>执行上述命令，命令行会让你回答一下问题，包括项目的运行环境、框架等，回答后，会生成一个默认配置文件</p>\n<hr>\n<h4>parserOptions</h4>\n<p>指定eslint能够识别的语法，配置解析选项能够帮助eslint判断什么属于解析错误。默认情况下，eslint能够识别<code class=\"language-text\">es5</code>和<code class=\"language-text\">jsx</code>的语法，可以通过设置<code class=\"language-text\">parserOptions</code>选项覆盖这些默认配置。<code class=\"language-text\">parserOptions</code>的可配置项：</p>\n<ul>\n<li>ecmaVersion：希望能够识别的<code class=\"language-text\">ECMAScript</code>语法版本。指定版本即可，比如对于<code class=\"language-text\">es6</code>，设置此值为<code class=\"language-text\">6</code>或<code class=\"language-text\">2015</code>，其他版本依次类推。</li>\n<li>sourceType：默认为<code class=\"language-text\">script</code>，可设置为<code class=\"language-text\">module</code>。若设置为<code class=\"language-text\">script</code>，则无法在文件中使用<code class=\"language-text\">import</code>等。</li>\n<li>\n<p>ecmaFeatures：指定其他可用的语言功能，可配置值：</p>\n<ul>\n<li>globalReturn：是否允许在全局作用域中使用<code class=\"language-text\">return</code>语句</li>\n<li>impliedStrict：是否开启全局的严格模式（在<code class=\"language-text\">es5</code>及更高版本可用）</li>\n<li>jsx：开启<code class=\"language-text\">jsx</code></li>\n</ul>\n</li>\n</ul>\n<h5>需要注意的点</h5>\n<ul>\n<li>设置<code class=\"language-text\">ecmaVersion</code>为<code class=\"language-text\">es6</code>，可以让eslint识别<code class=\"language-text\">es6</code>的语法，但是它并不代表eslint能够识别<code class=\"language-text\">es6</code>中类似于<code class=\"language-text\">Set</code>这些新的<code class=\"language-text\">esmaScript</code>全局变量。需要配合设置<code class=\"language-text\">{env:{es6:true}}</code>使eslint识别这些全局变量。只设置<code class=\"language-text\">ecmaVersion</code>为<code class=\"language-text\">es6</code>，在使用<code class=\"language-text\">Set</code>等全局变量时，会遇到<code class=\"language-text\">no-undef</code>的eslint报错。只设置<code class=\"language-text\">{env:{es6:true}}</code>但是<code class=\"language-text\">ecmaVersion</code>小于<code class=\"language-text\">6</code>，则无法使用<code class=\"language-text\">const</code>等语法，会遇到eslint<code class=\"language-text\">parser error</code>的错误。</li>\n<li>设置<code class=\"language-text\">jsx</code>为<code class=\"language-text\">true</code>后，能够识别<code class=\"language-text\">jsx</code>不代表能够识别React，React使用了一些eslint无法识别的<code class=\"language-text\">jsx</code>语法。若要使用<code class=\"language-text\">React</code>，可以使用<a href=\"https://github.com/yannickcr/eslint-plugin-react\"><code class=\"language-text\">eslint-plugin-react</code></a></li>\n</ul>\n<hr>\n<h4>parser</h4>\n<p>默认情况下，eslint使用<a href=\"https://github.com/eslint/espree\"><code class=\"language-text\">Espree</code></a>作为解析器，但是可以自行通过<code class=\"language-text\">parser</code>字段设置解析器。详情可见<a href=\"https://eslint.org/docs/user-guide/configuring#specifying-parser\"><code class=\"language-text\">eslint官网parser配置项</code></a></p>\n<hr>\n<h4>env</h4>\n<p><code class=\"language-text\">env</code>配置项指定了项目需要运行的环境，eslint根据env判断，哪些全局变量是可用的哪些是不可用的。比如设置了<code class=\"language-text\">node:true</code>后，<code class=\"language-text\">__dirname</code>变得可用，不然会报<code class=\"language-text\">no-undef</code>错误。</p>\n<ul>\n<li>常用配置项有：<code class=\"language-text\">node</code>、<code class=\"language-text\">browser</code>、<code class=\"language-text\">es6</code>、<code class=\"language-text\">mocha</code>等，所有列表可见<a href=\"https://eslint.org/docs/user-guide/configuring#specifying-environments\"><code class=\"language-text\">eslint</code>官网配置项</a></li>\n<li>可以同时指定多个环境</li>\n<li>可以通过配置文件指定，也可以通过文件注释的方式指定，如下</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* eslint-env node, mocha */</span></code></pre></div>\n<ul>\n<li>除了可以使用上面<code class=\"language-text\">node</code>这些已提前设置好的配置项外，也可以通过<code class=\"language-text\">plugins</code>的方式引入环境，如下，指定<code class=\"language-text\">plugins</code>，然后在<code class=\"language-text\">env</code>中通过<code class=\"language-text\">plugins/xx</code>的方式引入。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"example\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"env\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"example/custom\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h4>global</h4>\n<p>在通过<code class=\"language-text\">env</code>设置一部分变量后，可能仍然有部分是用户需要的全局变量，此时若不进行配置，也会报<code class=\"language-text\">no-undef</code>的错误，所以需要通过<code class=\"language-text\">global</code>的配置项告诉eslint这些变量是全局变量。</p>\n<ul>\n<li>globa不仅可以告诉eslint哪些变量是全局变量，也可以告诉eslint这些全局变量是否可以变更，配置方式如下</li>\n<li>可以通过文件注释的方式进行配置</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* global var1, var2 */</span>\n\n<span class=\"token comment\">/* global var1:writable, var2:writable *</span></code></pre></div>\n<ul>\n<li>也可以通过配置文件的方式进行配置</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"globals\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"var1\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"writable\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"var2\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"readonly\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>开启<a href=\"https://eslint.org/docs/rules/no-global-assign\">no-global-assign</a>规则可以使eslint检测用户是否有给不允许重写的全局变量赋值，若有此行为，则会进行报错</li>\n</ul>\n<hr>\n<h4>plugins</h4>\n<p>eslint可以使用第三方插件，通过<code class=\"language-text\">npm</code>下载后，在配置文件中的<code class=\"language-text\">plugins</code>字段进行配置即可。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"plugin1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"eslint-plugin-plugin2\"</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>由于<code class=\"language-text\">Node</code>的<code class=\"language-text\">require</code>函数的特性，全局安装的eslint只能使用全局安装的插件，本地安装的eslint只能使用本地安装的插件。</p>\n<hr>\n<h4>rules</h4>\n<p>eslint有很多<code class=\"language-text\">rules</code>，每条规则可以被赋值为<code class=\"language-text\">off</code>(或0)、<code class=\"language-text\">warn</code>(或1)，<code class=\"language-text\">error</code>(或2)。</p>\n<ul>\n<li>文件注释的方式配置</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* eslint eqeqeq: 0, curly: 2 */</span>\n\n若规则有更多配置项时，可以使用数组的方式：\n<span class=\"token comment\">/* eslint quotes: [\"error\", \"double\"], curly: 2 */</span></code></pre></div>\n<ul>\n<li>配置文件的方式</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"rules\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"eqeqeq\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"off\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"curly\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"quotes\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"double\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>配置插件提供的规则。此时记得去掉插件的<code class=\"language-text\">eslint-plugin</code>前缀，eslint会使用不加前缀的名称去匹配</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* eslint \"plugin1/rule1\": \"error\" */</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"plugin1\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"rules\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"plugin1/rule1\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"error\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h4>特定情况禁用eslint</h4>\n<ul>\n<li>使用注释的方式禁用</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* eslint-disable */</span>\n\n<span class=\"token comment\">/* eslint-disable no-alert, no-console */</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// eslint-disable-line</span></code></pre></div>\n<hr>\n<h4>overrides</h4>\n<p>使用<code class=\"language-text\">override</code>字段可以对特定文件使用特定规则。具体的文件路径解析规则等可以参见<a href=\"https://eslint.org/docs/user-guide/configuring#configuration-based-on-glob-patterns\"><code class=\"language-text\">configuration-based-on-glob-patterns</code></a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"rules\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"overrides\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"files\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"*-test.js\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"*.spec.js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"rules\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"no-unused-expressions\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"off\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h4>配置的层叠</h4>\n<ul>\n<li>eslint配置的优先级： 内联文件注释配置 > 命令行配置 >本文件夹中的配置文件 > 父文件夹中的配置文件 > 跟文件夹中的<code class=\"language-text\">.eslint.*</code>配置文件 > 根文件夹中<code class=\"language-text\">package.json</code>中<code class=\"language-text\">eslintConfig</code>字段中的配置</li>\n<li>若配置冲突，优先级高的配置覆盖优先级低的配置</li>\n<li>一般来说，eslint会去寻找配置文件，直到文件系统的根目录，这会导致一些意想不到的问题（全局eslint配置可能会意外影响到本地文件夹），设置<code class=\"language-text\">root:true</code>会使eslint停止向上查找</li>\n</ul>\n<hr>\n<h4>配置的继承</h4>\n<h5>继承规则</h5>\n<ul>\n<li>使用<code class=\"language-text\">extends</code>字段，配置可以继承一些已有的配置</li>\n<li><code class=\"language-text\">extends</code>字段可以被指定为代表某个配置的字符串，或一个数组，数组中，每个后面的配置继承前面的配置</li>\n<li>rules覆盖继承过来的配置，可以单独覆盖其等级，也可以同时覆盖其等级和配置项。如继承的配置是<code class=\"language-text\">&quot;quotes&quot;: [&quot;error&quot;, &quot;single&quot;, &quot;avoid-escape&quot;]</code>，<code class=\"language-text\">rules</code>中指定配置为<code class=\"language-text\">&quot;eqeqeq&quot;: &quot;warn&quot;</code>，则最终配置为<code class=\"language-text\">&quot;eqeqeq&quot;: [&quot;warn&quot;, &quot;allow-null&quot;]</code>，只覆盖其等级</li>\n</ul>\n<h5>配置继承的方式</h5>\n<ul>\n<li>继承自<code class=\"language-text\">eslint:recommended</code>，<code class=\"language-text\">eslint:recommended</code>内置了一系列<a href=\"https://eslint.org/docs/rules/\">核心规则</a>，这些核心规则只会在eslint主版本变更是会进行变动</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"extends\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"eslint:recommended\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>继承共享配置包。共享配置包指的是一个npm包，比如<code class=\"language-text\">eslint-config-standard</code>，它会导出一个配置文件，可以把它下载到本地eslint可以引用到的地方，然后通过<code class=\"language-text\">extends</code>继承配置包中的配置（此时可以忽略掉包名的<code class=\"language-text\">eslint-config-</code>前缀）</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"extends\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"standard\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>从插件继承。eslint插件，是一个npm包，里面通常会导出一系列规则。有些插件也会导出一个或多个命名配置。若需要继承插件的配置，则需要先安装插件到eslint可以引用到的地方。然后配置<code class=\"language-text\">plugins</code>字段和<code class=\"language-text\">extends</code>字段，<code class=\"language-text\">extends</code>字段格式为<code class=\"language-text\">plugins:packageName/configurationName</code>（<code class=\"language-text\">packageName</code>可以忽略<code class=\"language-text\">eslint-plugin-</code>前缀）</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"react\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"extends\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"eslint:recommended\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"plugin:react/recommended\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"rules\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token string\">\"no-set-state\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"off\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>继承自某个文件。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"extends\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"./node_modules/coding-standard/eslintDefaults.js\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"./node_modules/coding-standard/.eslintrc-es6\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>继承自<code class=\"language-text\">all</code>，配置方式为:<code class=\"language-text\">&quot;extends&quot;: &quot;eslint:all&quot;</code>。这会启用eslint中所有内置的核心规则。这些规则会跟随eslint的发版（包括小版本和大版本）而变化。不推荐在正式项目中用这个配置，因为这会导致再升级eslint后，eslint会针对原有代码进行报错。</li>\n</ul>\n<hr>\n<h4>.eslintignore</h4>\n<ul>\n<li>可以创建<code class=\"language-text\">.eslintignore</code>文件，通过正则的方式，指定不进行lint的文件</li>\n<li><code class=\"language-text\">node_modules</code>和<code class=\"language-text\">bower_components</code>默认忽略</li>\n</ul>","fields":{"postName":"/post/eslint基础配置须知"}}},{"node":{"id":"ac8cfca9-ca70-587f-aa94-a23e3d710510","frontmatter":{"title":"开发环境设置浏览器自动刷新","date":"2019-03-08","description":"开发环境的浏览器自动刷新，有利于提高开发效率。在此记录如何配置开发环境的浏览器自动刷新"},"html":"<p>开发环境中，如果在更新代码后，浏览器能够自动刷新，能够很大程度上提升我们的开发效率。在此记录一下，以<code class=\"language-text\">webpack-dev-server</code>和<code class=\"language-text\">express</code>两者提供服务的情况下，如何设置浏览器自动刷新。</p>\n<hr>\n<h4>webpack-dev-server</h4>\n<p>在<code class=\"language-text\">webpack-dev-server</code>提供服务的情况下，浏览器自动刷新的设置相当简单，只需要在<code class=\"language-text\">webpack.config.js</code>中加入以下代码即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\ndevServer<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    contentBase<span class=\"token punctuation\">:</span> <span class=\"token string\">'./views'</span><span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>相关<code class=\"language-text\">contentBase</code>和<code class=\"language-text\">publicPath</code>参数值可以按照需要进行设置，可参考<a href=\"https://webpack.js.org/guides/development/#using-webpack-dev-middleware\">webpack官网devServer配置项</a></p>\n<hr>\n<h4>以 express 提供服务</h4>\n<p>若以express提供服务，则需要使用<code class=\"language-text\">webpack-dev-middleware</code>和<code class=\"language-text\">webpack-hot-middleware</code>模块进行配置。首先</p>\n<h5>安装模块</h5>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev webpack-dev-middleware webpack-hot-middleware</code></pre></div>\n<h5>webpack配置</h5>\n<p>在 webpack 中添加配置</p>\n<ul>\n<li>entry 配置增加对<code class=\"language-text\">webpack-hot-middleware/client</code>的引用</li>\n<li>output 配置中增加<code class=\"language-text\">publicPath</code>配置</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'webpack-hot-middleware/client?reload=true'</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./entry/index.jsx'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\noutput<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span><span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h5>express 增加中间件</h5>\n<p>增加对<code class=\"language-text\">webpack-dev-middleware</code>和<code class=\"language-text\">webpack-hot-middleware</code>的使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> webpack <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'webpack'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./webpack.config'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> compiler <span class=\"token operator\">=</span> <span class=\"token function\">webpack</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack-dev-middleware\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  noInfo<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> publicPath<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>publicPath\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webpack-hot-middleware\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>reload 选项</h5>\n<p><code class=\"language-text\">webpack-hot-middleware/client</code>可以配置<a href=\"https://github.com/webpack-contrib/webpack-hot-middleware#config\">很多选项</a>，其中可以关注一下<code class=\"language-text\">reload</code>的参数。由于<code class=\"language-text\">webpack-hot-middleware</code>的主要目的是做热替换的。但是在某些项目中，比如React项目，单纯的<code class=\"language-text\">webpack-dev-middleware</code>和<code class=\"language-text\">webpack-hot-middleware</code>模块无法达到热替换的目的，设置<code class=\"language-text\">reload=true</code>会在当 webpack 检测到文件更新，但是无法完成热替换时，将替换方案退化为，重新刷新浏览器。</p>\n<hr>\n<h4>更多</h4>\n<p>热替换是比刷新浏览器更好的体验，React 的热替换可以参考：</p>\n<ul>\n<li><a href=\"https://github.com/gaearon/react-hot-loader\">react-hot-load</a></li>\n<li><a href=\"https://mobile.twitter.com/dan_abramov\">Dan Abramov</a> 有关热替换的文章：<a href=\"https://overreacted.io/my-wishlist-for-hot-reloading/\">my-wishlist-for-hot-reloading</a></li>\n</ul>","fields":{"postName":"/post/开发环境设置浏览器自动刷新"}}},{"node":{"id":"35b7e22b-59bf-59ab-a260-8363a69f88a2","frontmatter":{"title":"配置一个基本的React项目","date":"2019-03-07","description":"从0开始，配置一个最基本的React项目，内容包括：建立最基本的express服务器、webpack配置、babel配置等"},"html":"<p>配置一个最基本的 React 项目，大概分为一下几个部分：</p>\n<ul>\n<li>后端，使用<code class=\"language-text\">express</code>快速构建一个服务器</li>\n<li>采用 webpack 进行打包</li>\n<li>采用 babel 作为语法转义</li>\n<li>构建好的项目文件目录如下：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/dist\n\t- bundle.js   // 打包后的js文件\n\t- bundle.map.js  // source-map文件\n/entry\n\t- index.jsx  // React项目住入口\n/node_modules\n/pages\n\t- App.jsx\n\t- app.less\n/views\n\t- index.html\n.babelrc\napp.js\npackage-lock.json\npackage.json\nwebpack.config.js</code></pre></div>\n<hr>\n<h4>webpack</h4>\n<p>最终配置如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  mode<span class=\"token punctuation\">:</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n  entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    app<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./entry/index.jsx'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  resolve<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    extensions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'.jsx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.js'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  module<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    rules<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        test<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token regex\">/.js$/</span><span class=\"token punctuation\">,</span> <span class=\"token regex\">/.jsx$/</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        exclude<span class=\"token punctuation\">:</span> <span class=\"token regex\">/node_modules/</span><span class=\"token punctuation\">,</span>\n        use<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'babel-loader'</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.less$/</span><span class=\"token punctuation\">,</span>\n        use<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'style-loader'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'css-loader'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'less-loader'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  watch<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  devtool<span class=\"token punctuation\">:</span> <span class=\"token string\">'source-map'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>各方面解释如下：</p>\n<ul>\n<li>设置入口文件为<code class=\"language-text\">./entry/index.jsx</code></li>\n<li>打包后输出文件位置为<code class=\"language-text\">./dist</code>，文件名称为<code class=\"language-text\">bundle.js</code></li>\n<li>指定<code class=\"language-text\">resolve.extensions</code>为<code class=\"language-text\">[&#39;.jsx&#39;, &#39;.js&#39;]</code>，从而在文件引入的时候可以不带上后缀，如<code class=\"language-text\">import App from &#39;../pages/App&#39;</code>，此时<code class=\"language-text\">../pages/App</code>会按照<code class=\"language-text\">../pages/App.jsx</code>的方式去查找，若找不到，再按照 js 的后缀去查找，再找不到就会报错</li>\n<li>module 中对对应文件进行编译</li>\n</ul>\n<h5>js 和 jsx 文件的编译</h5>\n<p>首先是对于<code class=\"language-text\">.js</code>和<code class=\"language-text\">.jsx</code>的文件，采用<code class=\"language-text\">babel-loader</code>进行 babel 编译。其主要目的是转义<code class=\"language-text\">jsx</code>语法和<code class=\"language-text\">es6</code>及其以上的语法，具体 babel 配置见下面 babel 配置方面</p>\n<h5>less 文件的编译</h5>\n<p>对于 less 文件，依次采用了<code class=\"language-text\">less-loader</code>、<code class=\"language-text\">css-loader</code>和<code class=\"language-text\">style-loader</code>进行处理，这三个 loader 的作用如下：</p>\n<ul>\n<li><code class=\"language-text\">less-loader</code>：将 less 语法编译为 css</li>\n<li><code class=\"language-text\">css-loader</code>：css-loader 的使用，允许你在 less 文件或 css 文件中采用<code class=\"language-text\">@import</code>和<code class=\"language-text\">url()</code>加载其他文件，与采用<code class=\"language-text\">import</code>和<code class=\"language-text\">require</code>类似，css-loader 回去解析它们</li>\n<li><code class=\"language-text\">style-loader</code>：将 css 文件已<code class=\"language-text\">&lt;style&gt;</code>标签的形式插入到html 文件的 DOM 中，从而使样式生效</li>\n</ul>\n<hr>\n<h4>babel</h4>\n<p>babel 的配置，主要有两方面作用：</p>\n<ul>\n<li>转义<code class=\"language-text\">jsx</code>语法</li>\n<li>转义<code class=\"language-text\">es6</code>及以上的语法为 es5，使其能够在低版本浏览器中运行</li>\n</ul>\n<p>最终的配置文件如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/preset-env\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"useBuiltIns\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"usage\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"forceAllTransforms\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/preset-react\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/plugin-transform-runtime\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用到的 preset 及 plugins 解释如下：</p>\n<ul>\n<li>\n<p><code class=\"language-text\">@babel/preset-env</code>：根据目标运行环境来转化es6及以上代码，使其能够在目标环境中运行。目标环境可以通过<code class=\"language-text\">.browserlistrc</code>或<code class=\"language-text\">package.json</code>中的<code class=\"language-text\">target</code>字段指定，若未指定，则采用默认配置</p>\n<ul>\n<li>设置<code class=\"language-text\">&quot;useBuiltIns&quot;: &quot;usage&quot;</code>，若代码中采用了 es6及以上的高级功能，babel 会自动引入对应的<code class=\"language-text\">polyfill</code></li>\n</ul>\n</li>\n<li><code class=\"language-text\">@babel/preset-react</code>，转义 React 的 <code class=\"language-text\">jsx</code>语法的相关内容</li>\n<li><code class=\"language-text\">@babel/plugin-transform-runtime</code>：生成沙箱环境，是的各类 polyfill 不影响全局变量，并减少包的体积</li>\n</ul>\n<hr>\n<h4>主文件</h4>\n<ul>\n<li>入口文件<code class=\"language-text\">./entry/index.jsx</code>：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ReactDOM <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'../pages/App'</span><span class=\"token punctuation\">;</span>\n\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>App</span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">./pages/App.jsx</code>：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'./app.less'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>hello<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello world!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>配置后之后，使用 webpack 打包，即可看到<code class=\"language-text\">./dist</code>文件夹中生成了<code class=\"language-text\">bundle.js</code>文件。</p>\n<hr>\n<h4>后端及 index.html</h4>\n<h5>所需文件</h5>\n<ul>\n<li>后端采用 express 架设简单服务器</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token string\">'3100'</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./views/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server has been listening on </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">./views/index.html</code>:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\">&lt;!DOCTYPE html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>common-react-config<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>root<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/bundle.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">package.json</code>中加入<code class=\"language-text\">start</code>脚本</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack &amp; nodemon app.js\"</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>执行<code class=\"language-text\">npm start</code>即可在<code class=\"language-text\">localhost:3100</code>中看到<code class=\"language-text\">Hello world!</code></p>\n<h5>流程</h5>\n<ul>\n<li>请求<code class=\"language-text\">localhost:30000</code>，请求进入<code class=\"language-text\">app.js</code>中后，后端会读取<code class=\"language-text\">./views/index.html</code>并返回给前端</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./views/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>前端接收到请求后，会进行解析，并根据<code class=\"language-text\">&lt;script&gt;</code>请求<code class=\"language-text\">bundle.js</code>文件</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/bundle.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>对于<code class=\"language-text\">bundle.js</code>的请求，会在服务器端静态服务器处找到<code class=\"language-text\">bundle.js</code>文件，并返回此文件</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>前端收到 <code class=\"language-text\">bundle.js</code>文件后，执行对应 js，并渲染出<code class=\"language-text\">Hello world!</code></li>\n</ul>","fields":{"postName":"/post/配置一个基本的React项目"}}},{"node":{"id":"40828c9c-70f6-5eb4-8fde-e36ddcddc994","frontmatter":{"title":"babel基础概述","date":"2019-03-05","description":"配置babel前必须了解的babel基础知识，包括plugins、preset以及常用的plugins、preset"},"html":"<ul>\n<li>babel 可以通过<code class=\"language-text\">.babelrc</code>、<code class=\"language-text\">babel.config.js</code>或<code class=\"language-text\">package.json</code>中的<code class=\"language-text\">babel</code>字段进行配置</li>\n<li>以<code class=\"language-text\">.babelrc</code>为例，设置最常用的<code class=\"language-text\">presets</code>和<code class=\"language-text\">plugins</code>两个配置项：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n   <span class=\"token string\">\"presets\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"presetsA\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"presetsAOptions\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"presetsAValue\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">...</span>\n   <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"pluginsA\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"pluginsAOptions\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"pluginsAValue\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>更多配置项可以见<a href=\"https://babeljs.io/docs/en/options\">babel文档</a></li>\n</ul>\n<hr>\n<h4>plugins</h4>\n<ul>\n<li>babel 是一个编译器，它接受代码，经过对应语法转义后输出代码。而babel 的语法转义是通过 plugin实现的，plugin 会指导babel 对相应 JavaScript 程序进行编译，比如<code class=\"language-text\">@babel/plugin-transform-arrow-functions</code>，可以将箭头函数转化为ES5的非箭头函数，如下面代码。babel 的语法转义功能，即将目标环境无法识别的语法，转化为对应可以识别的语法，从而使一些更高级的语法功能能够在目标环境中运行。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fn</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// converted to</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token function-variable function\">fn</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>plugin 分为<code class=\"language-text\">transform plugins</code>和<code class=\"language-text\">syntax plugins</code>，<code class=\"language-text\">transform plugins</code>会包含对应的<code class=\"language-text\">syntx plugins</code>，它会识别并解析高级语法，并转化为目标环境能够识别的语法，比如上面箭头函数的例子。<code class=\"language-text\">syntx plugins</code>只能够使 babel 能够解析对应语法，但并不能转化他们。</li>\n<li>babel 的<code class=\"language-text\">transform plugins</code>列表可见：<a href=\"https://babeljs.io/docs/en/plugins\">https://babeljs.io/docs/en/plugins</a></li>\n<li>\n<p>我们也可以自定义plugin，来转化我们想转化的语法。可以参考：</p>\n<ul>\n<li><a href=\"https://itnext.io/introduction-to-custom-babel-plugins-98a62dad16ee\">babel自定义插件简介</a></li>\n<li><a href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md\">babel插件手册</a></li>\n</ul>\n</li>\n</ul>\n<hr>\n<h4>preset</h4>\n<ul>\n<li>在我们的项目中，因为有很多需要转化的点，比如 ES6的一堆功能，一个一个的添加插件会显得非常困难，这个是时候就有了 preset。preset 是一个插件包，里面有预设好的一堆插件。我们自己也可以自定义 preset，将一些插件以我们想要的方式进行排列，并进行共享。</li>\n<li>常见比较常用的preset 有：@babel/preset-env</li>\n</ul>\n<hr>\n<h4>plugins和 preset 执行顺序</h4>\n<p>babel 会按照配置文件中指定的 plugins 和 preset 来转化代码，plugins 和 preset 的执行顺序如下：</p>\n<ul>\n<li>先执行 plugins，然后执行 preset</li>\n<li>plugins 列表，按照从前往后的顺序执行</li>\n<li>preset 列表，按照从后往前的顺序执行</li>\n</ul>\n<hr>\n<h4>polyfill</h4>\n<ul>\n<li>\n<p><a href=\"https://babeljs.io/docs/en/babel-polyfill\">@babel/polyfill</a>模块中包含了<code class=\"language-text\">core-js</code>和一个自定义的<code class=\"language-text\">regenerator runtime</code>来模拟 ES2015以上的 JavaScript 允许环境。它可以帮助你 polyfill 一些 ES2015及以上的功能，比如内建的<code class=\"language-text\">Promise</code>、<code class=\"language-text\">WeakMap</code>，静态方法<code class=\"language-text\">Array.from</code>、实例方法<code class=\"language-text\">Array.prototype.includes</code>，以及生成器函数。</p>\n</li>\n<li>\n<p>注意，因为 polyfill 是需要在生成环境被使用的，所以需要按照<code class=\"language-text\">npm install --save @babel/polyfill</code>的方式进行安装</p>\n</li>\n<li>\n<p>使用方式：</p>\n<ul>\n<li>单独手动引入。手动引入又分为 <strong>在项目入口文件处整体引入</strong> 和在 <strong>使用时引入引入特定模块</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 整体引入</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@babel/polyfill\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token comment\">// 通过 webpack 的方式整体引入</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\nentry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"@babel/polyfill\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./app/js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 引入特定模块</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"core-js/modules/es.promise.finally\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </code></pre></div>\n<ul>\n<li>通过 <code class=\"language-text\">@babel/preset-env</code>引入，见下面对<code class=\"language-text\">@babel/preset-env</code>的介绍。</li>\n<li>通过<code class=\"language-text\">@babel/plugin-transform-runtime</code>引入，这种引入方式能够做到不影响全局变量，但是以这种方式引入后，无法引用实例方法，比如<code class=\"language-text\">Array.prototype.includes</code></li>\n</ul>\n</li>\n</ul>\n<hr>\n<h4>@babel/preset-env</h4>\n<ul>\n<li>在这个 preset 中包含了所有支持现代 JavaScript（包括ES2015、ES2016等）的插件。</li>\n<li>设置<code class=\"language-text\">useBuiltIns：&quot;usage&quot;</code>后，babel 会探测你代码中使用到的，但是目标环境中缺失的功能，并引入对应的这个 polyfill，而不是整个 polyfill 文件。从而减少包的体积。</li>\n</ul>\n<h5>原理</h5>\n<ul>\n<li><code class=\"language-text\">@babel/preset-env</code>会将代码的指定目标运行环境，通过一些数据源对应为在目标环境中运行相应代码所需要的语法及功能，然后将这些语法和功能对应为对应所需的插件和 polyfill，从而通过这些插件和 polyfill，将代码转化为可以在目标环境中允许的代码</li>\n<li>可以通过<code class=\"language-text\">.browserlistrc</code>指定代码的目标运行环境，<code class=\"language-text\">.browserlistrc</code>的配置方式可以参考<a href=\"https://github.com/browserslist/browserslist#queries\">browserlist项目</a>，如果没有找到<code class=\"language-text\">.browserlistrc</code>文件，则会使用<a href=\"https://github.com/browserslist/browserslist#queries\">默认配置</a></li>\n</ul>\n<h5>@babel/preset-env和@babel/polyfill</h5>\n<p>通过<code class=\"language-text\">@babel/preset-env</code>可以引入<code class=\"language-text\">@babel/polyfill</code>：</p>\n<ul>\n<li>指定<code class=\"language-text\">useBuiltIns: &#39;usage&#39;</code>后，不需要再显性<code class=\"language-text\">require</code>或<code class=\"language-text\">import</code> <code class=\"language-text\">@babel/polyfill</code>。但是注意<code class=\"language-text\">@babel/polyfill</code>还是需要被安装。设置后，babel 会在需要时，独引用<code class=\"language-text\">@babel/polyfill</code>的特定 polyfill，而不是整个polyfill</li>\n<li>多次引入<code class=\"language-text\">@babel/polyfill</code>会造成一些不可预知的问题。如果指定<code class=\"language-text\">useBuiltIns: &#39;entry&#39;</code>，任需在使用到的地方手动通过通过<code class=\"language-text\">require</code>或<code class=\"language-text\">import</code> <code class=\"language-text\">@babel/polyfill</code>，但是它会将所有的 <code class=\"language-text\">import &quot;@babel/polyfill&quot;</code>或 <code class=\"language-text\">require(&quot;@babel/polyfill&quot;)</code> 根据环境，转化为一个单独的引入。</li>\n<li>如果<code class=\"language-text\">useBuiltIns</code>未被指定或被显性指定为 false，则需要在手动显性引入<code class=\"language-text\">@babel/polyfill</code></li>\n</ul>\n<h5>forceAllTransforms参数</h5>\n<ul>\n<li>默认为 false，此时会按照目标运行环境执行对应转化</li>\n<li>如果设置为true，此时会强制执行所有可能的转化，如果目标代码需要执行UglifyJS 或执行在一个只支持ES5的环境中，则这个参数会很有用</li>\n</ul>\n<hr>\n<h4>@babel/plugin-transform-runtime</h4>\n<h5>作用</h5>\n<ul>\n<li>babel 会使用一些工具函数，比如<code class=\"language-text\">_extend</code>，这些工具函数基本上会在每个文件中被使用到，导致在每个文件中，都需要去定义这些工具函数。而<code class=\"language-text\">@babel/plugin-transform-runtime</code>会使所有的工具函数都去引用<code class=\"language-text\">@babel/runtime</code>，这样就避免了不断去重复定义这些工具函数。</li>\n<li>另一个作用是，为代码创建一个沙箱环境。如果使用<code class=\"language-text\">@babel/polyfill</code>，它会提供一些类似<code class=\"language-text\">Promise</code>、<code class=\"language-text\">Set</code>的功能，这些功能的实现会污染全局环境，当你需要发布某个库时，这就会成为一个问题。这个插件可以解决这个问题，具体可见：<a href=\"https://babeljs.io/docs/en/babel-plugin-transform-runtime#technical-details%E3%80%82\">https://babeljs.io/docs/en/babel-plugin-transform-runtime#technical-details。</a></li>\n</ul>\n<h5>使用</h5>\n<ul>\n<li>开发环境</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev @babel/plugin-transform-runtime</code></pre></div>\n<ul>\n<li>生成环境需要安装<code class=\"language-text\">@babel/runtime</code>作为</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save @babel/runtime</code></pre></div>\n<h5>引入 polyfill</h5>\n<ul>\n<li>对于 babel 7.0及以上，移除了原有的<code class=\"language-text\">polyfill</code>参数，此时，通过<code class=\"language-text\">@babel/plugin-transform-runtime</code>引入 polyfill 的方式是，在配置文件中指定<code class=\"language-text\">corejs</code>为2，并采用<code class=\"language-text\">@babel/runtime-corejs2</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/plugin-transform-runtime\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"corejs\"</span><span class=\"token operator\">:</span><span class=\"token number\">2</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save @babel/runtime-corejs2</code></pre></div>\n<ul>\n<li>需要注意的是，这种方式引入的 polyfill，无法使用实例方法，如<code class=\"language-text\">&quot;foobar&quot;.includes(&quot;foo&quot;)</code></li>\n</ul>\n<h5>使用async和 await</h5>\n<ul>\n<li><code class=\"language-text\">@babel/plugin-transform-runtime</code>中，参数<code class=\"language-text\">regenerator</code>可以指定是否转化生成器函数，指定为 true（默认也是 true）时，可以转化<code class=\"language-text\">async</code>和<code class=\"language-text\">await</code></li>\n</ul>\n<hr>\n<h4>@babel/preset-stage-x</h4>\n<ul>\n<li>babel7 已经去除了所有的<code class=\"language-text\">@babel/preset-stage-x</code>，相关信息可以在<a href=\"https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets\">去除Babel 的Stage Presets</a>这篇文章中获取到</li>\n<li>简单来说，<code class=\"language-text\">@babel/preset-stage-x</code> 使很多用户能干哟用上一些 proposal 的功能的同时，让大家误以为这些 proposal 的功能就是标准，最后造成了一些迁移以及处理上的麻烦，所以在babel7中将 stage 的 preset 去除了</li>\n</ul>","fields":{"postName":"/post/babel基础概述"}}},{"node":{"id":"c12486a5-d9c1-5040-8427-d66031043f5e","frontmatter":{"title":"Hooks与定时器","date":"2019-02-24","description":"React Hooks用于定时器时引发的问题及解决方式"},"html":"<p>简单的示例：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span></code></pre></div>\n<p>问题：允许后会出现跳字符的问题。</p>\n<p>原因：随着 Counter 的渲染，设置了多个定时器，多个定时器导致count 被设置为不同的值，页面不停被渲染。</p>\n<hr>\n<h4>1. 多个定时器的问题</h4>\n<h5>1.1 利用 useRef 取消多个定时器</h5>\n<p>利用 useRef 设置一个引用，判断之前是否有设置定时器，如果有则不再设置，代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count:'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span></code></pre></div>\n<p>问题：会发现，页面上的数字变为1后，不会再更新。但是在控制台，一直在输出<code class=\"language-text\">count: 0</code></p>\n<p>原因：在 setInterval 中获得的 count 参数的值一直是0，随着页面的渲染，每次传入定时器函数中的值都是初始值。</p>\n<h5>1.2 利用 useEffect 取消之前的定时器</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count:'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 useEffect 中返回<code class=\"language-text\">() =&gt; clearInterval(id);</code>，则每次渲染，都会利用这个函数来取消之前的定时器，然后设置新的定时器。所以去除了设置多个定时器的问题。</p>\n<p>需要注意的点：在上面的例子中，<code class=\"language-text\">useEffect</code>没有传入第二个参数，此时例子能够按照预期工作。但是如果给第二个参数传入<code class=\"language-text\">[]</code>，会发现它加到1后不会往上加了，但是控制台还在不断输出<code class=\"language-text\">count：0</code>。原因：当不传第二个参数时，每次都会取消上一个定时器然后添加新的定时器，然后新添加的定时器会引用最新的 count 值，所以能够正确工作。但是增加<code class=\"language-text\">[]</code>后，表示定时器只会在挂载时添加，在组件卸载时删除，但是在组件更新时定时器不会变化，此时定时器中的执行函数每次获取的都是最初值0。</p>\n<hr>\n<h4>2 解决值不更新的问题</h4>\n<h5>2.1 利用 useRef 获取最新值</h5>\n<p>可以利用 useRef 来设置一个引用，保持最新值的引用，如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> currentCount <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  currentCount<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> count<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'currentCount'</span><span class=\"token punctuation\">,</span> currentCount<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>currentCount<span class=\"token punctuation\">.</span>current <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>页面按照预期每秒钟变动一次。正如Dan Abramov 在[这个 twitter][https://twitter.com/dan_abramov/status/1098027329836797952)]中解释的:</p>\n<blockquote>\n<p>How do you opt into class-like behavior? With a thing similar to “this”. A ref.\nconst something = useRef()\nIn classes, it’s <code class=\"language-text\">this.something</code>. With Hooks, it’s <code class=\"language-text\">something.current</code>. But in both cases it’s a way to “break out” of captured values and get the latest one.</p>\n</blockquote>\n<p>一个 ref 会表现的像类组件中的<code class=\"language-text\">this.something</code>一样，它总是会获取最新的值。</p>\n<h5>2.2 利用 useRef 创造新函数</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> savedCallback <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    savedCallback<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      savedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用<code class=\"language-text\">useRef</code>生成一个每次渲染都不变的<code class=\"language-text\">savedCallback</code>，每次渲染都会生成新的<code class=\"language-text\">callback</code>函数，此函数中 count 会引用最新的值，<code class=\"language-text\">useEffect</code>每次渲染都更新<code class=\"language-text\">savedCall.current</code>中存储callback，更新为最新的 callback，然后声明 tick 函数，将每次的调用都指向这个最新的<code class=\"language-text\">savedCall.current</code>。这样，每次就都能够获得最新的 count 值并进行更新。</p>\n<p>需要注意的一点：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    savedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>不能直接写成<code class=\"language-text\">setInterval(savedcallback.current,1000)</code>，原因：useEffect 中的内容会在组件挂载后执行，而 setInterval 则在组件 render 时，造成的结果就是 setInterval 时 savedCall.current的值是 undefined。这就导致 count 的值根本不会进行更新。</p>\n<p>相同的道理，如下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> savedCallback <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count:'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    savedCallback<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span>savedCallback<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>此代码只会更新一次，但是会每秒打印一个<code class=\"language-text\">count: 0</code>。因为执行 setInterval 时，savedCall.current，其值是<code class=\"language-text\">()=&gt;{setCount(count+1)}</code>，它是一个具体函数，而不在是一个引用，所以此定时器在设定时，引用的是第一次渲染是的 callback，后续每秒执行的也是这个第一次渲染的 callback，继而callback 中每次获得的 count 值都是0。</p>\n<h5>2.3 给 setCount传入一个 updater</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>interval<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    interval<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>prevCount <span class=\"token operator\">=></span> prevCount <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span></code></pre></div>\n<p>在<code class=\"language-text\">prevCount=&gt;prevCount+1</code>中<code class=\"language-text\">prevCount</code>会引用最新的值，此时给它+1则没问题。页面会按照预期每秒加1。</p>\n<h5>2.4 使用useReducer</h5>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>action <span class=\"token operator\">===</span> <span class=\"token string\">'inc'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> state <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'inc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Counter<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 参考Dan Abramov 的博客：https://overreacted.io/making-setinterval-declarative-with-react-hooks/</span></code></pre></div>","fields":{"postName":"/post/Hooks与定时器"}}},{"node":{"id":"de896a8f-ab79-524f-bc52-484df133ca28","frontmatter":{"title":"Nextjs简介","date":"2019-02-17","description":"以一个项目为基础，简要介绍 Next 框架中的一些概念和简单使用方式"},"html":"<p>本文基于的项目来自Next的官方教程，地址为：<a href=\"https://github.com/arunoda/learnnextjs-demo.git\">https://github.com/arunoda/learnnextjs-demo.git</a> ，采用<code class=\"language-text\">clean-url-ssr</code>分支。</p>\n<hr>\n<h4>几个主要的概念</h4>\n<h5>渲染方式</h5>\n<p>Next 结合了服务端渲染和客户端渲染。首屏加载时采用服务端渲染，之后若用户点击链接进入到新的页面，对新的页面则使用客户端渲染。</p>\n<h5>服务端渲染</h5>\n<p>Next 中，首次请求采用的服务端渲染。服务端渲染指的是，在服务端生成 html 字符串，然后传递给客户端，客户端解析并展示从服务端获取的内容，并进行<a href=\"https://reactjs.org/docs/react-dom.html#hydrate\">hydrate</a>，增加事件处理等。服务端渲染，又可以分为两种方式：</p>\n<ul>\n<li>一种是采用 Next 自身的路由框架，直接在<code class=\"language-text\">page</code>文件夹中增加页面，请求的页面路径直接渲染出<code class=\"language-text\">page</code>文件夹下的页面。例如，在<code class=\"language-text\">/pages/index.js</code>中定义以下组件并导出，则可以直接在<code class=\"language-text\">localhost:3000</code>中看到通过服务端渲染展示出的页面，页面中只有一个<code class=\"language-text\">Hello world!</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello world!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>另一种是自定义路由。通过 express 自定义路由，自定义路由会通过express框架的<code class=\"language-text\">res.render</code>进行服务端渲染，然后将结果返回给客户端，客户端直接呈现服务端渲染结果。比如<a href=\"https://github.com/arunoda/learnnextjs-demo/blob/4482c6e0f16acea394a7f632ce2cd1e29a492779/server.js#L15\">模板项目中的一个例子</a></li>\n</ul>\n<h5>客户端渲染</h5>\n<p>在首页加载完成后，用户点击某个链接，导向新的页面，此时则加载对应页面的 JS 文件，将JS 下载客户端后，在客户端进行渲染，展示页面内容。此时不再通过服务端生成页面，而是客户端加载 JS 并生成页面。</p>\n<blockquote>\n<p>Next 中的客户端加载是通过<code class=\"language-text\">Link</code>组件来完成的，通过在页面中使用<code class=\"language-text\">Link</code>组件，则可以是页面拦截直接的服务端请求，转而采用加载 JS，并进行客户端渲染。若直接使用<code class=\"language-text\">a</code>标签，则相当于直接转向新的页面，则此时还是会重新请求服务端，进行服务端渲染。</p>\n</blockquote>\n<h5>页面兼容两种渲染方式</h5>\n<p>如上所述，由于 Next 将首页采用服务端渲染，而用户可能在每个页面进行刷新，此时这个页面则成为加载的首页，此时页面必须能够被进行服务端渲染，从而完成首页加载；而另一方面，每个页面都可能由另外一个页面从客户端点击后链接导入而来，此时页面则必须能够进行客户端渲染。综上，每个页面都必须兼容服务端渲染和客户端渲染方式。而 Next 中的页面天然具有这种能力。</p>\n<hr>\n<h4>数据获取</h4>\n<p>Next 定义了<code class=\"language-text\">getInitialProps</code>方法进行数据获取，它是一个静态方法，例子如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">//  /pages/post.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Post</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Layout</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/&lt;[/]?p>/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">.</span>image<span class=\"token punctuation\">.</span>medium<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Layout</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span>\n\nPost<span class=\"token punctuation\">.</span>getInitialProps <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`https://api.tvmaze.com/shows/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> show <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> show <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Post<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>服务端渲染。若请求 post，并进行服务端渲染，则服务端会先查看Post 是否有定义<code class=\"language-text\">getInitialProps</code>方法，若有定义此方法，则使用定义的方法请求数据，并将数据放置在一个服务端渲染出的 html 页面中的一个script 标签中（如下所示）。客户端加载 html 后会将此数据渲染进视图。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>__NEXT_DATA__<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>application/json<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\">\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"props\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"pageProps\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"show\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"page\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"/post\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"query\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"900\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"buildId\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"development\"</span><span class=\"token punctuation\">}</span>\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>客户端渲染。在进行客户端渲染时，渲染页面，会先通过<code class=\"language-text\">getInitialProps</code>请求数据，并将请求到的数据通过 props 传递给组件，组件进行对应渲染。</li>\n</ul>\n<hr>\n<h4>数据传递</h4>\n<p>在页面跳转时，若需要传递数据，比如在列表页，点击某个链接，跳转至其详情页，则在详情页需要知道，需要展示哪个内容的详情，此时则需要传递给详情对应数据。在列表页，跳转如下</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Link</span> <span class=\"token attr-name\">as</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`/p/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>show<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">href</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`/post?id=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>show<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>show<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Link</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>则在详情页，获取此 id 的方式为：</p>\n<ul>\n<li>对于组件，通过 <code class=\"language-text\">withRouter</code>，在<code class=\"language-text\">router.query</code>中获取，如下</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> Content <span class=\"token operator\">=</span> <span class=\"token function\">withRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>router<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">This is the blog post content.</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Content props:</span><span class=\"token punctuation\">{</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>对于<code class=\"language-text\">getInitialProps</code>方法，通过<code class=\"language-text\">context</code>方式获取，如下</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Post<span class=\"token punctuation\">.</span>getInitialProps <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>id<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`https://api.tvmaze.com/shows/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> show <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Fetched show:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>show<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>show<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当然，这两种方式获取的数据是相同的。</p>\n<p>若采用自定义路由（如下代码），在对应页面，也可以通过上面的方式通过<code class=\"language-text\">router.query</code>和<code class=\"language-text\">context.query</code>获取<code class=\"language-text\">queryParams</code>中的数据。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">server<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/p/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> actualPage <span class=\"token operator\">=</span> <span class=\"token string\">'/post'</span>\n    <span class=\"token keyword\">const</span> queryParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> req<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> actualPage<span class=\"token punctuation\">,</span> queryParams<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>","fields":{"postName":"/post/Nextjs简介"}}}]}},"pageContext":{"limit":15,"skip":0,"pagesCount":2,"currentPage":1}}