{"data":{"markdownRemark":{"html":"<p>浏览器中，整个JavaScript的运行环境，在Render进程中。帮助JavaScript运行起来的主要线程包括：</p>\n<ul>\n<li>JavaScript 引擎线程</li>\n<li>事件触发线程</li>\n<li>定时器线程</li>\n<li>异步http线程</li>\n</ul>\n<p>先说明一下浏览器中JavaScript事件循环的整体流程，再来看各个线程在其中起的作用。</p>\n<hr>\n<h4>浏览器事件循环</h4>\n<p>浏览器事件循环的总体流程如下：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec4678143310d56afe5fe10178291c84/de852/JavaScript%20event%20loop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 531px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.802259887005654%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQoz12TCw6CQAxEuf/RuIAhYADByB/koyBgzWtSgzZptrs7nU674AzDIH3fS9u2Ute1zPMsy7LoavHz+ZR1XWWaJrndbpKmqZ69Xi91cNw3TSMOmzzP1QFv2yb/RhLn+75r4ev1Kvf7XYs9Ho8vbhxHcQBjgFBqhtowDL+EqIMUnOu64vu+YhBiRrcOJFShMlU5pBIxLUBEXBSFtlWWpXiepys48n4IOSCR1rGu6/TCjLYgY2YYY4HQBJD7QwgBKlBq63EuqKI12rb4crmoOsMzivf7rQWUkA1gHAAXKEYVVU0xag1HDBZi9vba35ZNFcm0CCkJxMfH+n99e1QzVcghlYhZeTmGXlWVJEmibjM+GiJstnxSKFWFx1YgzbJMh07MIxCTzMyCIJDz+SxxHMvpdNIYAWDpxAFEFdz+DpK5xBkBd8wZ9ajlW8SjKNK/hk5s9h/EHU8hhsIx7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"JavaScript event loop\"\n        title=\"\"\n        src=\"/static/ec4678143310d56afe5fe10178291c84/de852/JavaScript%20event%20loop.png\"\n        srcset=\"/static/ec4678143310d56afe5fe10178291c84/da694/JavaScript%20event%20loop.png 138w,\n/static/ec4678143310d56afe5fe10178291c84/b49ee/JavaScript%20event%20loop.png 275w,\n/static/ec4678143310d56afe5fe10178291c84/de852/JavaScript%20event%20loop.png 531w\"\n        sizes=\"(max-width: 531px) 100vw, 531px\"\n      />\n  </span>\n  </a></p>\n<p>各组成部分：</p>\n<ul>\n<li>JavaScript引擎，进行JavaScript的解析与执行，所有JavaScript代码的执行全部在JavaScript引擎中</li>\n<li>WebApis。由浏览器提供的api，执行例如DOM事件、Ajax请求、定时器等任务。其中包括定时器线程、异步http线程等webapi对应的线程，他们负责进行进行对应的api调用，而且不属于JavaScript引擎。</li>\n<li>事件循环队列。维护回调事件组成的队列</li>\n</ul>\n<p>整体流程：</p>\n<ul>\n<li>JavaScript引擎根据调用栈中的函数调用，依次执行JavaScript代码。其中，若调用有调用Webapi，则对相应Api进行调用，注册对应api调用与回调事件。如代码为<code class=\"language-text\">setTimeout(()=&gt;console.log(&quot;here&quot;),100)</code>，则调用定时器。</li>\n<li>Webapi执行对应调用，当执行完成后，将回调函数传递给事件循环队列。事件循环队列接受回调后，将此回调放在事件循环队列最后。比如上述的<code class=\"language-text\">setTimeout</code>定义了100ms的定时，则定时器开始计时，到100ms时，将回调<code class=\"language-text\">()=&gt;console.log(&quot;here&quot;)</code>传递给事件循环队列。</li>\n<li>当调用栈为空时，JavaScript从事件循环队列开头去除回调函数，放入调用栈中，执行回调。</li>\n</ul>\n<hr>\n<h4>JavaScript引擎</h4>\n<p>如上图所示，JavaScript引擎中主要包括两大部分：</p>\n<ul>\n<li>内存堆，提供程序运行所需内存</li>\n<li>调用栈，维护JavaScript程序调用栈</li>\n</ul>\n<p>JavaScript是单线程的，而这个单线程，也就是说在JavaScript引擎中，在一个特定时间，JavaScript只能执行一个任务，一行代码，不能同时执行多项任务。代码的执行顺序，则严格按照调用栈的程序调用顺序。</p>\n<h5>调用栈</h5>\n<p>调用栈维护的程序调用及返回顺序，调用栈是一个先进后出的栈结构。</p>\n<ul>\n<li>每次对函数的调用，将会把此函数压入栈底</li>\n<li>每次函数返回，则将函数从栈顶释放</li>\n</ul>\n<p>比如以下代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">c</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">c</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>代码执行即对应调用栈为：</p>\n<ul>\n<li>开始执行代码，调用栈为 main </li>\n<li>执行a。调用栈：main —> a</li>\n<li>函数a执行，执行<code class=\"language-text\">console.log(&quot;a&quot;)</code>。调用栈：main —> a —> console.log</li>\n<li><code class=\"language-text\">console.log</code>执行，打印<code class=\"language-text\">a</code>，然后退出<code class=\"language-text\">console.log</code>，调用栈变为 main —> a</li>\n<li>执行<code class=\"language-text\">b()</code>，调用b函数，进入函数b中，调用栈变为 main —> a —> b</li>\n<li>然后执行<code class=\"language-text\">console.log</code>，调用栈变为 main —> a —> b —> console.log</li>\n<li><code class=\"language-text\">console.log</code>执行完毕，调用栈变为 main —> a —> b</li>\n<li>然后调用c，进入c函数，调用栈变为 main —> a —> b —> c</li>\n<li>执行 <code class=\"language-text\">console.log</code>，调用栈变为 main —> a —> b —> c —> console.log</li>\n<li><code class=\"language-text\">console.log</code>执行完毕，调用栈变为 main —> a —> b —> c</li>\n<li>从c函数退出，回到b函数，调用栈变为main —> a —> b</li>\n<li>从b函数退出，调用栈变为main —> a </li>\n<li>从a函数退出，调用栈变为 main</li>\n<li>代码执行完毕，调用栈变为空</li>\n</ul>\n<h5>调用循环队列</h5>\n<p>JavaScript引擎会按照代码从上往下进行调用执行</p>\n<ul>\n<li>执行流程形成调用栈</li>\n<li>执行过程中，若需要对webapi进行调用，则调用webapi</li>\n<li>当代码执行完毕调用栈为空时，便开始执行事件循环队列中的回调</li>\n<li>每次从事件循环队列的头部获取一个回调，执行此回调时，依然形成对此回调执行的调用栈</li>\n<li>当上一个回调执行结束，调用栈回到空状态，则从事件循环队列获取一下一个回调，并进行执行</li>\n<li>循环上述流程，直到将所有回调全部执行完毕</li>\n</ul>\n<hr>\n<h4>webApi与事件循环队列</h4>\n<p>webApis中包含各种浏览器Api调用，比如</p>\n<ul>\n<li>DOM api，根据JavaScript，注册各类事件，比如点击事件，注册后，若用户进行点击，则将点击事件回调传递给事件循环队列</li>\n<li>定时器，若JavaScript执行<code class=\"language-text\">setTimeout</code>或<code class=\"language-text\">setInterval</code>，则向定时器注册定时任务，定时器将进行计时，达到执行事件后，将定时器回调传递给事件循环队列</li>\n<li>http事件同理，进行http请求，请求结束后，将请求回调及请求数据传递给事件循环队列</li>\n</ul>\n<p>事件循环队列每次收到webApi传递来的回调事件及回调数据，则将回调事件及数据放在队列最后，当 JavaScript 调用栈为空时，从循环队列开头，依次将一个个回调事件及数据传递给JavaScript引擎进行执行。</p>\n<hr>\n<h4>异步代码执行流程</h4>\n<p>综合上述内容，若代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"timeout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>执行流程为：</p>\n<ul>\n<li>调用<code class=\"language-text\">console.log</code>，调用栈变为 main —> console.log ，<code class=\"language-text\">console.log</code>执行完毕后，调用栈回到 main</li>\n<li>执行<code class=\"language-text\">setTimeout</code>，调用webapi的定时器，将回调函数传递给定时器，由于设置的超时时间为0，定时器此时会立马把回调传递给时间循环队列，时间循环队列将回调放入队列中</li>\n<li>此时JavaScript执行扔在主代码序列中，调用栈为 main 。继续往下，进入 <code class=\"language-text\">console.log(&quot;b&quot;)</code>，执行<code class=\"language-text\">console</code>，调用栈变为 main —> console，<code class=\"language-text\">console.log(&quot;b&quot;)</code>调用结束，调用栈回到 main</li>\n<li><code class=\"language-text\">console.log(&quot;b&quot;)</code>执行完毕后，主代码序列全部执行完毕，调用栈变为空</li>\n<li>此时，开始从循环队列中取出回调进行执行，于是，取出<code class=\"language-text\">()=&gt;console.log(&quot;timeout&quot;)</code>，进行执行，从代码开始执行到执行完毕，调用栈先变为 console.log，后变为空</li>\n</ul>\n<hr>\n<h4>macrotask &#x26; microtask</h4>\n<p>在上面的讲述中，事件循环队列只是一个队列，然而实际上，并不是只有一个队列。然而，事实上应该有两个主要的执行队列。</p>\n<ul>\n<li>\n<p>macrotask</p>\n<ul>\n<li>宏任务，也被称为task，从概念上来说，可以看做是一个执行主体。在执行时，是一个task接着一个task，依次进行执行的。</li>\n<li>被认为是宏任务的内容包括：setTimeout、setInterval、I/O</li>\n</ul>\n</li>\n<li>\n<p>microtask</p>\n<ul>\n<li>微任务。会尽快被执行的任务，包括：原生promise、process.nextTick(Node中)</li>\n</ul>\n</li>\n</ul>\n<h5>执行流程</h5>\n<p>macrotask、microtask、UI渲染，三者，在某个时刻，只能有一个在执行，它们的执行流程为：</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/51d427aca96a32ca17615dca9aa916e7/10478/macrotask%26microtask.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 361px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.90858725761773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABB0lEQVQoz42S5wqEQAyE9/0fz38i9oIFe685JrCHLqdnIC4GnZ18iaiqijzPoyzLKM9zSpKE1nXlPI7jmwh5PoXAwzAM6vueCxDsuo6Korh8+FZcwGHbtlTXNTvEO8K2bSrLkrZto2VZLsKPgvu+0zl93yfTNPmUGUURdzAMw8XtL2GhthWGIbsLgoBPy7KYL5iiC4nmDoNQC03T8E/gKBOC8zxTHMfkOA6N48iYVDMXh3dMUIczCKN113WZLXjjEuTZqVBBqwmumDhEwRMbAcdIuQ3njRB3+3RGIRFM08SOMBwpmKYp6brOdQiLf4t6h0JeAJYQxzBfO1QxIDAgIABTONQ0jWsfALVZTWKpmCQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"macrotaskµtask\"\n        title=\"\"\n        src=\"/static/51d427aca96a32ca17615dca9aa916e7/10478/macrotask%26microtask.png\"\n        srcset=\"/static/51d427aca96a32ca17615dca9aa916e7/c4105/macrotask%26microtask.png 138w,\n/static/51d427aca96a32ca17615dca9aa916e7/ae54d/macrotask%26microtask.png 275w,\n/static/51d427aca96a32ca17615dca9aa916e7/10478/macrotask%26microtask.png 361w\"\n        sizes=\"(max-width: 361px) 100vw, 361px\"\n      />\n  </span>\n  </a></p>\n<ul>\n<li>在执行时，会先取一个task执行</li>\n<li>task执行完毕后，获取执行期间的所有microtask，把所有microtask全部执行完毕</li>\n<li>若JavaScript执行对UI有改变，则执行UI渲染</li>\n<li>UI渲染完成后，进行下一个task的执行</li>\n<li>按照上述步骤循环往复</li>\n</ul>\n<p>所以，以下代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"e\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>执行的打印顺序为<code class=\"language-text\">a - e - c - d - b</code></p>\n<hr>\n<p>参考内容</p>\n<p><a href=\"https://www.youtube.com/watch?v=8aGhZQkoFbQ\">https://www.youtube.com/watch?v=8aGhZQkoFbQ</a></p>\n<p><a href=\"https://www.i-programmer.info/programming/javascript/11337-javascript-async-microtasks.html\">https://www.i-programmer.info/programming/javascript/11337-javascript-async-microtasks.html</a></p>\n<p><a href=\"http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html\">http://www.dailichun.com/2018/01/21/js<em>singlethread</em>eventloop.html</a></p>","frontmatter":{"title":"浏览器内部：事件循环"}}},"pageContext":{"postName":"/post/浏览器内部：事件循环"}}