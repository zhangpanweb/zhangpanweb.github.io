<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.2df82b7fabbbaffc2435.css">code[class*=language-],pre[class*=language-]{color:#c5c8c6;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Inconsolata,Monaco,Courier New,Courier,monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1d1f21}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7c7c7c}.token.punctuation{color:#c5c8c6}.namespace{opacity:.7}.token.keyword,.token.property,.token.tag{color:#96cbfe}.token.class-name{color:#ffffb6;text-decoration:underline}.token.boolean,.token.constant{color:#9c9}.token.deleted,.token.symbol{color:#f92672}.token.number{color:#ff73fd}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a8ff60}.token.variable{color:#c6c5fe}.token.operator{color:#ededed}.token.entity{color:#ffffb6}.token.url{color:#96cbfe}.language-css .token.string,.style .token.string{color:#87c38a}.token.atrule,.token.attr-value{color:#f9ee98}.token.function{color:#dad085}.token.regex{color:#e9c062}.token.important{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body,html{word-break:break-word}@font-face{font-family:Consolas;src:url(/static/consola-dd67cc82c437fd23ab38a8efead69e47.ttf) format("truetype")}blockquote{position:relative}blockquote:before{content:"";position:absolute;margin-left:-20px;width:5px;height:100%;background:#eaeaea}:not(pre)>code[class*=language-]{background:#efefed;color:rgba(23,22,22,.92);text-shadow:none;font-size:100%}pre[class*=language-]{background:#313131;font-size:13px}</style><meta name="generator" content="Gatsby 2.1.11"/><title data-react-helmet="true"></title><link as="script" rel="preload" href="/component---src-templates-post-js-5144e2763294d5ac9dab.js"/><link as="script" rel="preload" href="/styles-e6b6a307c6b9df920a5d.js"/><link as="script" rel="preload" href="/app-9e853ca0473879fabc7b.js"/><link as="script" rel="preload" href="/webpack-runtime-5a7ce0198e418b23f26a.js"/><link as="fetch" rel="preload" href="/static/d/29/path---post-深入了解-react中state和props的更新-7-c-2-223-Rgfv9kqzgpzq58vUnyz3qP08.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><style data-emotion-css="qtu3xq">.css-qtu3xq{margin:50px auto 50px;max-width:770px;padding-top:50px;padding:50px;background:white;border:1px solid #cacaca;border-radius:5px;}</style><div class="css-qtu3xq ezt8jpi0"><style data-emotion-css="bqntim">.css-bqntim{margin-bottom:50px;font-size:25px;}</style><h2 class="css-bqntim ezt8jpi1">深入了解React中state和props的更新</h2><style data-emotion-css="s4undb">.css-s4undb{font-size:15px;}.css-s4undb h6{font-size:100%;}.css-s4undb h5{font-size:120%;}.css-s4undb h4{font-size:140%;}.css-s4undb h2{font-size:200%;}.css-s4undb *{line-height:1.8;}</style><div class="css-s4undb"><p>在上<a href="https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e">一篇文章</a>中，我讲解了一些基础，这些基础是理解这篇文章中描述更新过程中的技术细节所必需的。</p>
<p>我讲述了在这篇文章中会用到的主要数据结构和概念，特别是 Fiber 节点、current 和 work-in-progress 树、副作用和副作用列表。我也提供了一个主要算法的概览，并说明了 render 阶段和 commit 阶段的不同点。如果你还没有阅读上一篇文章，我推荐你从那里开始。</p>
<p>我也介绍了一个简单的应用，只有一个按钮，点击后会增加渲染在屏幕上数字的大小。</p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/4cb17450b9c01101e2d65de05be09c8e/13cfa/1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 550px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 21.386430678466077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABJ0AAASdAHeZh94AAAAVElEQVQY05WO0QqAIBRD/f/vK3yJ9BPiXi0w2/KhoAe74GAw2DjM8UcAaKvfux7ohQEXc1aKbExJmpX1LJ8eo8DKGBZ6PzXPXGPgseuzGQDaGebDG03zPCtuy+5RAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="1"
        title=""
        src="/static/4cb17450b9c01101e2d65de05be09c8e/542ea/1.png"
        srcset="/static/4cb17450b9c01101e2d65de05be09c8e/e35fc/1.png 138w,
/static/4cb17450b9c01101e2d65de05be09c8e/4417e/1.png 275w,
/static/4cb17450b9c01101e2d65de05be09c8e/542ea/1.png 550w,
/static/4cb17450b9c01101e2d65de05be09c8e/13cfa/1.png 678w"
        sizes="(max-width: 550px) 100vw, 550px"
      />
  </span>
  </a></p>
<p>它的实现如下：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ClickCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>state <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token operator">&lt;</span>button key<span class="token operator">=</span><span class="token string">"1"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        Update counter
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">,</span>
      <span class="token operator">&lt;</span>span key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在这里我给组件添加了<code class="language-text">componentDidUpdate</code>生命周期方法，它将用于展示在 React 在 commit 阶段如添加影响，调用这个方法。</p>
<p>在这篇文章中，我想向你展示 React 如何处理状态更新并建立副作用列表。我们将带你看到在 render 和 commit 阶段的高级函数中发生了什么。</p>
<p>特别的，我们将看到在<code class="language-text">completeWork</code>函数中，React 如何：</p>
<ul>
<li>更新<code class="language-text">ClickCounter</code> <code class="language-text">state</code>中的<code class="language-text">count</code>属性</li>
<li>调用<code class="language-text">render</code>方法来获得一个子元素列表并执行对比</li>
<li>更新<code class="language-text">span</code>元素的属性</li>
</ul>
<p>和在<code class="language-text">commitRoot</code>中，React：</p>
<ul>
<li>更新<code class="language-text">span</code>元素的<code class="language-text">textContent</code>属性</li>
<li>调用<code class="language-text">componentDidUpdate</code>生命周期方法</li>
</ul>
<p>在那之前，让我们先快速看一下当我们在点击处理函数中调用<code class="language-text">setState</code>方法时，工作时如何调度的。</p>
<p>注意，你不用理解这些也能使用 React，这篇文章时关于 React 内部是如何工作的。</p>
<hr>
<h4>调度更新</h4>
<p>当我们点击按钮时，<code class="language-text">click</code>事件被触发，React 执行被传入 button 属性的回调。在我们的应用中，它仅仅增加计数并更新状态。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ClickCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>每个 React 组件有一个与之相关联的<code class="language-text">updater</code>，它作为一个桥梁，连接组件和 React 核心。这使得<code class="language-text">setState</code>能够能够被 React DOM、ReactNative、服务端渲染和测试工具中被以不同的方式进行实现。</p>
<p>在这篇文章中，我们将看到 ReactDOM 中<code class="language-text">updater</code>对象的实现，而 React DOM 中私用的则是 Fiber reconciler。对于<code class="language-text">ClickCounter</code>组件来说，这个<code class="language-text">updater</code>是<code class="language-text">classComponentUpdater</code>。它负责获取一个 Fiber 实例、队列更新以及调度工作。</p>
<p>当更新被加入队列中，他们被加入到需要在一个 Fiber 节点上被处理的更新的队列中。在我们的例子中，与<code class="language-text">ClickCounter</code>组件相关联的 Fiber 节点有以下结构：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    stateNode<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ClickCounter</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> ClickCounter<span class="token punctuation">,</span>
    updateQueue<span class="token punctuation">:</span> <span class="token punctuation">{</span>
         baseState<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
         firstUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
             next<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                 payload<span class="token punctuation">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token operator">...</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>正如你所能够看到的，<code class="language-text">updateQueue.firstUpdate.next.payload</code>中的函数时我们传入到<code class="language-text">ClickCounter</code>组件<code class="language-text">setState</code>中的回调。它代表的是，在 render 阶段需要被处理的第一个更新。</p>
<hr>
<h4>处理 ClickCounter Fiber node 的更新</h4>
<p>我上篇文章中<a href="https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e">有关工作循环的章节</a>解释了<code class="language-text">nextUnitOfWork</code>全局变量的作用。具体来说，章节中降到了，这个变量包含一个引用，指向<code class="language-text">workInProgress</code>树中有工作需要被执行的 Fiber 节点。当 React 遍历 Fiber 树时，它使用这个遍历来知道是否有其他 Fiber 节点有未被完成的工作。</p>
<p>让我们假设<code class="language-text">setState</code>节点被调用了，React 把来自<code class="language-text">setState</code>的回调增加到<code class="language-text">ClickCounter</code>fiber 节点的<code class="language-text">updateQueue</code>中，并且开始调度工作。React 进入 render 阶段。它从最高的<code class="language-text">HostRoot</code>Fiber 节点开始，使用<code class="language-text">renderRoot</code>方法来遍历树。然而，它会跳过已经被处理过的 Fiber 节点，直到发现一个有未处理工作的节点。在我们的例子中，只有一个 Fiber 节点有未完成工作，他就是<code class="language-text">ClickCounter</code>Fiber 节点。</p>
<p>所有的工作都会在这个 Fiber 节点的克隆副本上进行，这个克隆父辈被存放在<code class="language-text">alternate</code>属性上。如果这个 alternate 节点还没有被创建，则 React 会在处理更新前，调用<code class="language-text">createWorkInProgress</code>方法创建副本。让我们假设，变量<code class="language-text">nextUnitOfWork</code>中存放了一个 alternate <code class="language-text">ClickCounter</code> Fiber 节点的引用。</p>
<h5>beginWork</h5>
<p>首先，我们的 Fiber 进入到<a href="https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L1489">beginWork</a>。</p>
<blockquote>
<p>因为这个方法会在一个树的每个 Fiber 节点上被执行，所以如果你想要 debug render 阶段，这个地方是一个打断点的好地方。我在这里打断点，并区检查一个 Fiber 节点的类型，来找到我需要的那个。</p>
</blockquote>
<p><code class="language-text">beginWork</code>函数时一个大的<code class="language-text">switch</code>语句，通过 Fiber 节点的 tag 来判断什么类型的工作需要在这个 Fiber 节点上被执行，然后执行对应的函数来处理工作。当<code class="language-text">CountClicks</code>是一个类组件时，这个分支时这样的：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token keyword">case</span> FunctionalComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
        <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span>
        <span class="token punctuation">{</span>
            <span class="token operator">...</span>
            <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后我们进入到了<code class="language-text">updateClassComponent</code>方法。根据这是组件的第一次渲染、或者时组件更新的恢复再或者是组件的更新，React 会创建一个实例、或者挂载这个组件再或者更新它：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">let</span> shouldUpdate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token comment">// In the initial pass we might need to construct the instance.</span>
        <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// In a resume, we'll already have an instance we can reuse.</span>
        shouldUpdate <span class="token operator">=</span> <span class="token function">resumeMountClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        shouldUpdate <span class="token operator">=</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> shouldUpdate<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h5>处理 ClickCounter Fiber 的更新</h5>
<p>我们已经有了一个<code class="language-text">ClickCounter</code>组件的实例，所以我们进入到<code class="language-text">updateClassInstance</code>方法中。这是 React 执行大部分类组件工作的地方。在这个函数中执行的重要操作，安装执行顺序排列如下：</p>
<ul>
<li>调用<code class="language-text">UNSAFE_componentWillReceiveProps()</code>钩子（deprecated）</li>
<li>处理<code class="language-text">updateQueue</code>中的更新，并产生一个新的状态</li>
<li>使用新状态调用<code class="language-text">getDerivedStateFromProps</code>获得结果</li>
<li>调用<code class="language-text">shouldComponentUpdate</code>来保证组件确实需要被更新；如果结果为 false，则跳过整个渲染阶段，包括在这个组件和其子组件上调用 render；否则则处理更新</li>
<li>调用<code class="language-text">UNSAFE_componentWillUpdate</code>（depricated）</li>
<li>增加一个影响，用来出发<code class="language-text">componentDidUpdate</code>生命周期钩子</li>
</ul>
<blockquote>
<p>虽然调用<code class="language-text">componentDidUpdate</code>的影响时在 render 阶段被添加的，但是这个方法时在 commit 阶段被执行的。</p>
</blockquote>
<ul>
<li>在组件实例上更新<code class="language-text">state</code>和<code class="language-text">props</code></li>
</ul>
<blockquote>
<p>state 和 props 子 render 方法被调用之前在组件实例上被更新，因为 render 方法的结果往往取决于 state 和 props。如果不这样做，每次 render 方法都将返回相同的结果。</p>
</blockquote>
<p>下面是这个方法的一个简化版本：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> oldProps<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callComponentWillReceiveProps</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> updateQueue<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>

    <span class="token keyword">const</span> shouldUpdate <span class="token operator">=</span> <span class="token function">checkShouldComponentUpdate</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span>

    <span class="token keyword">return</span> shouldUpdate<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在上面的代码片段中，我移除了一些辅助代码。比如说，在调用生命周期周期方法或增加触发他们的影响时之前，React 会使用<code class="language-text">typeof</code>操作符检查一个组件是否实现了这些方法。比如说，增加影响前，对<code class="language-text">componentDidUpdate</code>方法的检查：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>所以，我们知道了在 render 阶段，会有哪些操作在<code class="language-text">ClickCounter</code>Fiber 节点上执行。让我们现在来看看这些操作如何更不 Fiber 节点上的值。当 React 开始工作时，<code class="language-text">ClickCounter</code>对应的 Fiber 节点看起来类似于下面的样子：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    effectTag<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    elementType<span class="token punctuation">:</span> <span class="token keyword">class</span> <span class="token class-name">ClickCounter</span><span class="token punctuation">,</span>
    firstEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    memoizedState<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token keyword">class</span> <span class="token class-name">ClickCounter</span><span class="token punctuation">,</span>
    stateNode<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    updateQueue<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        baseState<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        firstUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                payload<span class="token punctuation">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>完成工作后，FIber 节点将看起来像这样：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    effectTag<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    elementType<span class="token punctuation">:</span> <span class="token keyword">class</span> <span class="token class-name">ClickCounter</span><span class="token punctuation">,</span>
    firstEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    memoizedState<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token keyword">class</span> <span class="token class-name">ClickCounter</span><span class="token punctuation">,</span>
    stateNode<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    updateQueue<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        baseState<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        firstUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>让我们花点时间来看下属性值的变化。</p>
<p>在更新被实施之后，<code class="language-text">memoizedState</code>和<code class="language-text">updateQueue</code>中<code class="language-text">baseState</code>，count 属性的值变为了 1。React 也更新了<code class="language-text">ClickCounter</code>组件实例中的状态。</p>
<p>在这时，在队列中已经没有更新，所以<code class="language-text">firstUpdate</code>的值时<code class="language-text">null</code>。另外，重要的是，我们更新了<code class="language-text">effectTag</code>属性。它不再是 0，而是 4。4 的二进制是 100，也就是第三字节被设置了，而这正是<code class="language-text">update</code>副作用 tag 的字节：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> Update <span class="token operator">=</span> <span class="token number">0b00000000100</span><span class="token punctuation">;</span></code></pre></div>
<p>总结来说，当处理父元素<code class="language-text">ClickCounter</code>Fiber 节点时，React 会调用变更前生命周期方法，更新状态并定义相关的副作用。</p>
<h5>reconcililng ClickCounter Fiber 子元素</h5>
<p>一旦上面说的都完成了，React 则会进入<code class="language-text">finishClassComponent</code>。这是 React 调用一个组件实例 render 方法的地方，并且会将对比算法运用在组件返回的子元素上。有关这个概览可以在<a href="https://reactjs.org/docs/reconciliation.html#the-diffing-algorithm">文档</a>中看到。相关部分如下：</p>
<blockquote>
<p>当对比两个相同类型的 React DOM 元素，React 检查他们两个的属性、保持其下相同的 DOM 节点，仅仅更新变更过的属性。</p>
</blockquote>
<p>如果深入了解，我们会发现，其实它对比的是 Fiber 节点和 React 元素。我不会深入到这些细节。我会单独写有关子 reconciliation 的文章。</p>
<blockquote>
<p>如果你很好奇里面的细节，你也可以去看<code class="language-text">reconcileChildrenArray</code>方法，因为在我们的应用中，render 方法返回了一个 React 元素组成的数组。</p>
</blockquote>
<p>到这里，有两个需要注意的点。首先，当 React 进行子 reconciliation 过程时，它创建或更新从 render 方法返回子 React 元素的 Fiber 节点。<code class="language-text">finishClassComponent</code>函数返回对 current Fiber 节点的第一个孩子的引用。这个引用会被赋值给<code class="language-text">nextUnitOfWork</code>，并且在工作循环中被处理。其次，React 把在孩子上更新 props 的工作看作是在其父元素工作的一部分。这个过程，用到了来自 React 元素 render 方法返回的数据。</p>
<p>比如，在 React reconcile ClickCounter fiber 的孩子之前，span 元素对应的 Fiber 节点看起来是这样的：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    stateNode<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">HTMLSpanElement</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token string">"span"</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
    memoizedProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>children<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    pendingProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>children<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>正如你所看到的，在<code class="language-text">memoizedProps</code>和<code class="language-text">pendingProps</code>中，<code class="language-text">children</code>属性都是 0。下面是 span 元素 render 方法返回的结构：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  key<span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">;</span>
  props<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    children<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  type<span class="token punctuation">:</span> <span class="token string">"span"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>正如你所看到的，Fiber 节点和返回的 React 元素的 props 是不同的。在用来创建 alernate Fiber 节点的<code class="language-text">createWorkInProgress</code>方法中，React 会把更新后的属性从 React 元素复制到 Fiber 节点中。</p>
<p>所以，React 在 ClickCounter 组件上完成 reconcile 子元素后，span Fiber 节点将会有一个<code class="language-text">pendingProps</code>：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    stateNode<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">HTMLSpanElement</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token string">"span"</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
    memoizedProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>children<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    pendingProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>children<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>之后，当 React 在 span Fiber 节点上执行工作时，它会把它们复制给<code class="language-text">memoizedProps</code>，并且增加影响来更新 DOM。</p>
<p>这就是 render 阶段，React 对 ClickCounter fiber 节点做的所有工作。因为 button 是 ClickCounter 的第一个孩子，所以它会被赋值给<code class="language-text">nextUnitOfWork</code>变量。对于它来说，这里并没有需要做的事情，所以 React 会转向它的兄弟，也就是 span Fiber 节点。根据在<a href="https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e#25fb">这里</a>描述的算法，这个转移发生在<code class="language-text">completeUnitOfWork</code>方法中。</p>
<h5>处理 span fiber 的更新</h5>
<p>所以，这时<code class="language-text">nextUnitOfWork</code>指向 span fiber 的 alternate，并且 React 开始在它上面执行工作。和在 ClickCounter 执行工作的步骤类似，我们以<code class="language-text">beginWork</code>方法开始。</p>
<p>因为我们的 span 节点是<code class="language-text">HostComponent</code>类型，所以这次，在 switch 语句中，React 会采用以下分支：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> FunctionalComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
        <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
        <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>
          <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>它将以<code class="language-text">updateHostComponent</code>方法结束。它对应于类组件的<code class="language-text">updateClassComponent</code>方法。对于一个函数组件来说，它是<code class="language-text">updateFunctionComponent</code>，等等。你可以在<code class="language-text">ReactFiberBeginWork.js</code>中找到所有的这些方法。</p>
<h5>reconcile span fiber 的子元素</h5>
<p>在我们的例子中，对于 span 节点，<code class="language-text">updateHostComponent</code>中并没有什么重要的内容。</p>
<h5>完成 span Fiber 节点的工作</h5>
<p>一旦<code class="language-text">beginWork</code>结束，这个节点进入到<code class="language-text">completeWork</code>方法中。但是在这之前，React 需要更新 span fiber 的<code class="language-text">memoizedProps</code>。你应该还记得当在 ClickCounter 组件上 reconcile 孩子时，React 更新了 span Fiber 节点的<code class="language-text">pendingProps</code>：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    stateNode<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">HTMLSpanElement</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token string">"span"</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
    memoizedProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>children<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    pendingProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>children<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>所以，一旦 span fiber 的<code class="language-text">beginWork</code>完成，React 会更新<code class="language-text">pendingProps</code>到对应的<code class="language-text">memoizedProps</code>：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current$$<span class="token number">1</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextRenderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后它会调用<code class="language-text">completeWork</code>方法，它和<code class="language-text">beginWork</code>类似，都是一个大的<code class="language-text">swtich</code>语句：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
        <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
        <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
            <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>因为 span 节点是<code class="language-text">HostComponent</code>，所以它会运行<code class="language-text">updateHostComponent</code>方法。在这个方法中，React 大致会执行以下动作：</p>
<ul>
<li>准备 DOM 更新</li>
<li>把它们增加到 span fiber 的<code class="language-text">updateQueue</code>中</li>
<li>增加更新 DOM 的影响</li>
</ul>
<p>在操作执行之前，span 节点看起来像这样：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    stateNode<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">HTMLSpanElement</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token string">"span"</span><span class="token punctuation">,</span>
    effectTag<span class="token punctuation">:</span> <span class="token number">0</span>
    updateQueue<span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>完成后，它看起来像这样：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    stateNode<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">HTMLSpanElement</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token string">"span"</span><span class="token punctuation">,</span>
    effectTag<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    updateQueue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"children"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>注意<code class="language-text">effectTag</code>和<code class="language-text">updateQueue</code>属性的不同。<code class="language-text">effectTag</code>由 0 变为 4，4 的二进制是 100，正是更新副作用 tag 对应的值。这是在下面 commit 阶段 React 在这节点上唯一需要做的（指的是执行更新副作用）。<code class="language-text">udpateQueue</code>顺序中装载了需要被用于更新的内容。</p>
<p>一旦 React 处理完 ClickCounter 和它的孩子，render 阶段就结束了。现在可以在<code class="language-text">FibeRoot</code>上把已完成的 alternate 树赋值给<code class="language-text">finishWork</code>属性了。这也是需要被更新到屏幕上的新树。这可能会立即执行，也可能需要等一下，等到浏览器给 React 时间执行时。</p>
<hr>
<h4>影响列表</h4>
<p>在我们的例子中，因为 span 节点和 ClickCounter 组件有副作用，React 会增加一个来联系，链接 span Fiber 节点和<code class="language-text">HostFiber</code>的<code class="language-text">firstEffect</code>属性。</p>
<p>React 会在<a href="https://github.com/facebook/react/blob/d5e1bf07d086e4fc1998653331adecddcd0f5274/packages/react-reconciler/src/ReactFiberScheduler.js#L999"><code class="language-text">completeUnitOfWork</code></a>方法中构建一个影响列表。在我们的例子中，span 节点需要更新 text、ClickCounter 有回调钩子，其标识出影响的 Fiber 树如下：</p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/3e877/4.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 505px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 58.81188118811882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHZhhcbwE//xAAaEAACAgMAAAAAAAAAAAAAAAABAgAQERMy/9oACAEBAAEFAipWbMGm7n//xAAWEQEBAQAAAAAAAAAAAAAAAAAhARD/2gAIAQMBAT8BiZ//xAAWEQADAAAAAAAAAAAAAAAAAAABEFH/2gAIAQIBAT8BNX//xAAcEAABAwUAAAAAAAAAAAAAAAABABAhAhEiMlH/2gAIAQEABj8Cxm/SgKtnElv/xAAbEAEAAgIDAAAAAAAAAAAAAAABEBEhQQAxYf/aAAgBAQABPyGybpW6OAwNaMyHqvCP/9oADAMBAAIAAwAAABAUz//EABcRAAMBAAAAAAAAAAAAAAAAAAEQESH/2gAIAQMBAT8QCIxf/8QAFxEAAwEAAAAAAAAAAAAAAAAAARARIf/aAAgBAgEBPxAoa1f/xAAZEAEBAQEBAQAAAAAAAAAAAAABIREAEHH/2gAIAQEAAT8Q0piRs+OVqWKK4XhfHIAmpG+f/9k='); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="fiber tree with effect"
        title=""
        src="/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/3e877/4.jpg"
        srcset="/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/bcb14/4.jpg 138w,
/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/568dc/4.jpg 275w,
/static/307dbd8cb0a5cbae9fff6ff4fb237d0b/3e877/4.jpg 505w"
        sizes="(max-width: 505px) 100vw, 505px"
      />
  </span>
  </a></p>
<p>如下时带影响的节点构成的线性列表：</p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/08ee5adc51e84a3cd685adfd61f92989/4cc64/5.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 550px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 24.347826086956523%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/2gAMAwEAAhADEAAAAdsDAX//xAAXEAEBAQEAAAAAAAAAAAAAAAARAgEA/9oACAEBAAEFAigozK7/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/Aax//8QAFxAAAwEAAAAAAAAAAAAAAAAAACEyof/aAAgBAQAGPwKmUysP/8QAGRAAAgMBAAAAAAAAAAAAAAAAABEhQZHB/9oACAEBAAE/IZOiOkRZcf/aAAwDAQACAAMAAAAQC/8A/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/EBwyVf/EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAgEBPxAa7Av/xAAaEAEBAAIDAAAAAAAAAAAAAAABEQAxIVFx/9oACAEBAAE/ECU3bNYXUuFo1fGsPLMAMFehn//Z'); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="5"
        title=""
        src="/static/08ee5adc51e84a3cd685adfd61f92989/fc6c6/5.jpg"
        srcset="/static/08ee5adc51e84a3cd685adfd61f92989/93e06/5.jpg 138w,
/static/08ee5adc51e84a3cd685adfd61f92989/51ff6/5.jpg 275w,
/static/08ee5adc51e84a3cd685adfd61f92989/fc6c6/5.jpg 550w,
/static/08ee5adc51e84a3cd685adfd61f92989/4cc64/5.jpg 575w"
        sizes="(max-width: 550px) 100vw, 550px"
      />
  </span>
  </a></p>
<hr>
<h4>commit 阶段</h4>
<p>这个阶段开始于<code class="language-text">completeRoot</code>。在开始其他工作之前，它先把<code class="language-text">FiberRoot</code>上的<code class="language-text">finishdedWork</code>属性设置为<code class="language-text">null</code>。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code></pre></div>
<p>不像 render 阶段，commit 阶段总是同步的，所以可以安全更新<code class="language-text">HostRoot</code>，用以显示 commit 的工作已经开始。</p>
<p>commit 阶段是 React 更新 DOM、调用更新后生命周期方法<code class="language-text">componentDidUpdate</code>的地方。为了做到这些，它会遍历在 render 阶段构建起来的影响列表，并应用他们。</p>
<p>在 render 阶段，对于 span 和 clickCounter 节点，我们有了以下影响：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span> type<span class="token punctuation">:</span> ClickCounter<span class="token punctuation">,</span> effectTag<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span> effectTag<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token punctuation">}</span></code></pre></div>
<p>ClickCounter effect tag 的值是 5，也就是二进制的 101，它定义了更新工作，在类组件中，它被翻译为<code class="language-text">componentDidUpdate</code>生命周期方法。最后一位被设置，用来表明，对这个 Fiber 节点来说，render 阶段的所有的工作都已完成。</p>
<p>span 的 effect tag，值为 4，也就是二进制的 100，它定义的更新工作是 host 组件的 DOM 更新。对于 span 元素来说，React 需要更新元素的<code class="language-text">textContent</code>。</p>
<hr>
<h4>应用影响</h4>
<p>让我们来看看 React 如何应用这些影响。用来应用影响的方法，<code class="language-text">commitRoot</code>，一共有三个子函数构成：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commitBeforeMutationLifecycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitAllHostEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  <span class="token function">commitAllLifeCycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>每一个子函数都会实现一个循环，这个循环会遍历影响列表，检查影响类型。如果它找到这个函数被设计应用到的影响，则它会实际应用这个影响。在我们的例子中，它会调用在 ClickCounter 组件上<code class="language-text">componentDidUpdate</code>生命周期方法、更新 span 元素的 text。</p>
<p>第一个函数 <a href="https://github.com/facebook/react/blob/fefa1269e2a67fa5ef0992d5cc1d6114b7948b7e/packages/react-reconciler/src/ReactFiberCommitWork.js#L183">commitBeforeMutationLifeCycles</a>会查找<code class="language-text">Snapshot</code>影响，并调用<code class="language-text">getSnapshotBeforeUpdate</code>方法。但是，我们不用在 ClickCounter 组件上调用这个方法，因为 React 在 render 阶段并没有添加这个影响。所以在我们的例子中，这个函数什么都不会做。</p>
<hr>
<h4>DOM 更新</h4>
<p>接下来，React 移动到<code class="language-text">commitAllHostEffects</code>函数。在这里，React 将会把 span 元素的 text 由 0 变为 1。在这里，对于 ClickCounter 组件什么都不会做，因为类组件对应的节点没有任何 DOM 更新。</p>
<p>函数的实现是，它挑选对应类型的影响，并进行对应的操作。在我们的例子中，我们需要更新 span 元素的 text，所以我们会采用<code class="language-text">Update</code>分支：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateHostEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> Placement<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
      <span class="token keyword">case</span> PlacementAndUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
      <span class="token keyword">case</span> Update<span class="token punctuation">:</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">var</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
          <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">case</span> Deletion<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>顺着<code class="language-text">commitWork</code>方法而下，我们最终会进入到<code class="language-text">updateDOMProperties</code>方法，它会使用在 render 阶段添加到 Fiber 节点上的<code class="language-text">updateQueue</code>来更新 span 元素的<code class="language-text">texttContent</code>：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> updatePayload<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updatePayload<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> propKey <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> propValue <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">DANGEROUSLY_SET_INNER_HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTextContent</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在 DOM 更新被应用之后，React 会把<code class="language-text">finishedWork</code>树赋值给<code class="language-text">HostRoot</code>。它会把 alternate 树设置为 current 树：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span></code></pre></div>
<hr>
<h4>调用更新后生命周期钩子</h4>
<p>剩下的最后一个函数是<code class="language-text">commitAllLifecycles</code>。这是 React 调用更新后生命周期方法的地方。在 render 阶段，React 给 ClickCounter 方法添加了 <code class="language-text">Update</code>影响。这是<code class="language-text">commitAllLifecycles</code>函数寻找的并调用<code class="language-text">componentDidUpdate</code>方法的影响之一：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">commitAllLifeCycles</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
            <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这个方法也会更新<code class="language-text">refs</code>，但是因为我们没有任何 refs，所以这个功能不会被用到。<a href="https://github.com/facebook/react/blob/e58ecda9a2381735f2c326ee99a1ffa6486321ab/packages/react-reconciler/src/ReactFiberCommitWork.js#L351"><code class="language-text">commitLifeCycles</code></a>如下：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>你也可以看到，这个方法也是 React 给第一次渲染的组件调用<code class="language-text">componentDidMount</code>的地方。</p>
<p>以上，就是这些了。</p></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-js","jsonName":"post-深入了解-react中state和props的更新-7c2","path":"/post/深入了解React中state和props的更新"};window.dataPath="29/path---post-深入了解-react中state和props的更新-7-c-2-223-Rgfv9kqzgpzq58vUnyz3qP08";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-9e853ca0473879fabc7b.js"],"component---src-templates-post-js":["/component---src-templates-post-js-5144e2763294d5ac9dab.js"],"component---src-templates-blog-list-js":["/component---src-templates-blog-list-js-1377c674db8a0f810940.js"],"component---src-pages-page-js":["/component---src-pages-page-js-6b454277fbe7e5be4505.js"],"pages-manifest":["/pages-manifest-63075a67fdfa565a73b3.js"]};/*]]>*/</script><script src="/webpack-runtime-5a7ce0198e418b23f26a.js" async=""></script><script src="/app-9e853ca0473879fabc7b.js" async=""></script><script src="/styles-e6b6a307c6b9df920a5d.js" async=""></script><script src="/component---src-templates-post-js-5144e2763294d5ac9dab.js" async=""></script></body></html>