<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.4faffe570b919c015229.css">code[class*=language-],pre[class*=language-]{color:#c5c8c6;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Inconsolata,Monaco,Courier New,Courier,monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1d1f21}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7c7c7c}.token.punctuation{color:#c5c8c6}.namespace{opacity:.7}.token.keyword,.token.property,.token.tag{color:#96cbfe}.token.class-name{color:#ffffb6;text-decoration:underline}.token.boolean,.token.constant{color:#9c9}.token.deleted,.token.symbol{color:#f92672}.token.number{color:#ff73fd}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a8ff60}.token.variable{color:#c6c5fe}.token.operator{color:#ededed}.token.entity{color:#ffffb6}.token.url{color:#96cbfe}.language-css .token.string,.style .token.string{color:#87c38a}.token.atrule,.token.attr-value{color:#f9ee98}.token.function{color:#dad085}.token.regex{color:#e9c062}.token.important{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body,html{background-color:#eae9e9;word-break:break-word}@font-face{font-family:Consolas;src:url(/static/consola-dd67cc82c437fd23ab38a8efead69e47.ttf) format("truetype")}blockquote{position:relative}blockquote:before{content:"";position:absolute;margin-left:-20px;width:5px;height:100%;background:#eaeaea}:not(pre)>code[class*=language-]{background:#efefed;color:rgba(23,22,22,.92);text-shadow:none;font-size:100%}pre[class*=language-]{background:#313131;font-size:13px}</style><meta name="generator" content="Gatsby 2.1.11"/><title data-react-helmet="true"></title><link as="script" rel="preload" href="/component---src-templates-post-js-30aa7530cff3dfb988b8.js"/><link as="script" rel="preload" href="/styles-1733f10ae0a41b682de6.js"/><link as="script" rel="preload" href="/app-84ad13c86530e26dc69f.js"/><link as="script" rel="preload" href="/webpack-runtime-b3054d4aec55bb8ec1a7.js"/><link as="fetch" rel="preload" href="/static/d/43/path---nextjs简介-215-166-5UkIPMZt1DkkP2RNwJOHtP5wpug.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><style data-emotion-css="1am5tay">.css-1am5tay{margin:50px auto 50px;max-width:770px;padding-top:50px;padding:50px;background:white;}</style><div class="css-1am5tay ezt8jpi0"><style data-emotion-css="bqntim">.css-bqntim{margin-bottom:50px;font-size:25px;}</style><h2 class="css-bqntim ezt8jpi1">Nextjs简介</h2><style data-emotion-css="1g2op9e">.css-1g2op9e{font-size:15px;}.css-1g2op9e h6{font-size:100%;}.css-1g2op9e h5{font-size:120%;}.css-1g2op9e h4{font-size:140%;}.css-1g2op9e h2{font-size:200%;}</style><div class="css-1g2op9e"><p>本文基于的项目来自Next的官方教程，地址为：<a href="https://github.com/arunoda/learnnextjs-demo.git">https://github.com/arunoda/learnnextjs-demo.git</a> ，采用<code class="language-text">clean-url-ssr</code>分支。</p>
<hr>
<h4>几个主要的概念</h4>
<h5>渲染方式</h5>
<p>Next 结合了服务端渲染和客户端渲染。首屏加载时采用服务端渲染，之后若用户点击链接进入到新的页面，对新的页面则使用客户端渲染。</p>
<h5>服务端渲染</h5>
<p>Next 中，首次请求采用的服务端渲染。服务端渲染指的是，在服务端生成 html 字符串，然后传递给客户端，客户端解析并展示从服务端获取的内容，并进行<a href="https://reactjs.org/docs/react-dom.html#hydrate">hydrate</a>，增加事件处理等。服务端渲染，又可以分为两种方式：</p>
<ul>
<li>一种是采用 Next 自身的路由框架，直接在<code class="language-text">page</code>文件夹中增加页面，请求的页面路径直接渲染出<code class="language-text">page</code>文件夹下的页面。例如，在<code class="language-text">/pages/index.js</code>中定义以下组件并导出，则可以直接在<code class="language-text">localhost:3000</code>中看到通过服务端渲染展示出的页面，页面中只有一个<code class="language-text">Hello world!</code>。</li>
</ul>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Hello world!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></code></pre></div>
<ul>
<li>另一种是自定义路由。通过 express 自定义路由，自定义路由会通过express框架的<code class="language-text">res.render</code>进行服务端渲染，然后将结果返回给客户端，客户端直接呈现服务端渲染结果。比如<a href="https://github.com/arunoda/learnnextjs-demo/blob/4482c6e0f16acea394a7f632ce2cd1e29a492779/server.js#L15">模板项目中的一个例子</a></li>
</ul>
<h5>客户端渲染</h5>
<p>在首页加载完成后，用户点击某个链接，导向新的页面，此时则加载对应页面的 JS 文件，将JS 下载客户端后，在客户端进行渲染，展示页面内容。此时不再通过服务端生成页面，而是客户端加载 JS 并生成页面。</p>
<blockquote>
<p>Next 中的客户端加载是通过<code class="language-text">Link</code>组件来完成的，通过在页面中使用<code class="language-text">Link</code>组件，则可以是页面拦截直接的服务端请求，转而采用加载 JS，并进行客户端渲染。若直接使用<code class="language-text">a</code>标签，则相当于直接转向新的页面，则此时还是会重新请求服务端，进行服务端渲染。</p>
</blockquote>
<h5>页面兼容两种渲染方式</h5>
<p>如上所述，由于 Next 将首页采用服务端渲染，而用户可能在每个页面进行刷新，此时这个页面则成为加载的首页，此时页面必须能够被进行服务端渲染，从而完成首页加载；而另一方面，每个页面都可能由另外一个页面从客户端点击后链接导入而来，此时页面则必须能够进行客户端渲染。综上，每个页面都必须兼容服务端渲染和客户端渲染方式。而 Next 中的页面天然具有这种能力。</p>
<hr>
<h4>数据获取</h4>
<p>Next 定义了<code class="language-text">getInitialProps</code>方法进行数据获取，它是一个静态方法，例子如下，</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token comment">//  /pages/post.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">Post</span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Layout</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>show<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>show<span class="token punctuation">.</span>summary<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;[/]?p>/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>show<span class="token punctuation">.</span>image<span class="token punctuation">.</span>medium<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Layout</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span>

Post<span class="token punctuation">.</span>getInitialProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://api.tvmaze.com/shows/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> show <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> show <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Post<span class="token punctuation">;</span></code></pre></div>
<ul>
<li>服务端渲染。若请求 post，并进行服务端渲染，则服务端会先查看Post 是否有定义<code class="language-text">getInitialProps</code>方法，若有定义此方法，则使用定义的方法请求数据，并将数据放置在一个服务端渲染出的 html 页面中的一个script 标签中（如下所示）。客户端加载 html 后会将此数据渲染进视图。</li>
</ul>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>__NEXT_DATA__<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/json<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript">
<span class="token punctuation">{</span><span class="token string">"props"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"pageProps"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"show"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"page"</span><span class="token punctuation">:</span><span class="token string">"/post"</span><span class="token punctuation">,</span><span class="token string">"query"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"900"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"buildId"</span><span class="token punctuation">:</span><span class="token string">"development"</span><span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<ul>
<li>客户端渲染。在进行客户端渲染时，渲染页面，会先通过<code class="language-text">getInitialProps</code>请求数据，并将请求到的数据通过 props 传递给组件，组件进行对应渲染。</li>
</ul>
<hr>
<h4>数据传递</h4>
<p>在页面跳转时，若需要传递数据，比如在列表页，点击某个链接，跳转至其详情页，则在详情页需要知道，需要展示哪个内容的详情，此时则需要传递给详情对应数据。在列表页，跳转如下</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">as</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token string">`/p/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>show<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">}</span></span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token string">`/post?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>show<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>show<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span></code></pre></div>
<p>则在详情页，获取此 id 的方式为：</p>
<ul>
<li>对于组件，通过 <code class="language-text">withRouter</code>，在<code class="language-text">router.query</code>中获取，如下</li>
</ul>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Content <span class="token operator">=</span> <span class="token function">withRouter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">This is the blog post content.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Content props:</span><span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<ul>
<li>对于<code class="language-text">getInitialProps</code>方法，通过<code class="language-text">context</code>方式获取，如下</li>
</ul>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx">Post<span class="token punctuation">.</span>getInitialProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://api.tvmaze.com/shows/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> show <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Fetched show:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>show<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>show<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>当然，这两种方式获取的数据是相同的。</p>
<p>若采用自定义路由（如下代码），在对应页面，也可以通过上面的方式通过<code class="language-text">router.query</code>和<code class="language-text">context.query</code>获取<code class="language-text">queryParams</code>中的数据。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/p/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> actualPage <span class="token operator">=</span> <span class="token string">'/post'</span>
    <span class="token keyword">const</span> queryParams <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token punctuation">}</span>
    app<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> actualPage<span class="token punctuation">,</span> queryParams<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-js","jsonName":"nextjs简介-215","path":"/Nextjs简介"};window.dataPath="43/path---nextjs简介-215-166-5UkIPMZt1DkkP2RNwJOHtP5wpug";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-84ad13c86530e26dc69f.js"],"component---src-templates-post-js":["/component---src-templates-post-js-30aa7530cff3dfb988b8.js"],"component---src-pages-index-js":["/component---src-pages-index-js-3ada8dc43a9f28284fbb.js"],"pages-manifest":["/pages-manifest-b4b642ac39870003f80e.js"]};/*]]>*/</script><script src="/webpack-runtime-b3054d4aec55bb8ec1a7.js" async=""></script><script src="/app-84ad13c86530e26dc69f.js" async=""></script><script src="/styles-1733f10ae0a41b682de6.js" async=""></script><script src="/component---src-templates-post-js-30aa7530cff3dfb988b8.js" async=""></script></body></html>